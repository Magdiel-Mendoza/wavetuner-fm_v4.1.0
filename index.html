<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" id="metaTheme" content="#060910">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="./manifest.json">
<link rel="icon" type="image/png" href="./icon-192.png">
<link rel="apple-touch-icon" href="./icon-192.png">
<title>WaveTuner FM</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Inter:wght@300;400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}

/* â”€â”€ VARIABLES DE TEMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root,[data-theme="dark"]{
--bg:#050810;--bg2:#0e1525;--bg3:#151e30;--bg4:#0b1120;
--card:#131b2d;--card2:#182340;--cardb:rgba(0,229,255,.06);
--tx:#e0e7ff;--tx2:#94a3b8;--tx3:#546380;
--bd:rgba(255,255,255,.07);--bd2:rgba(255,255,255,.14);
--pri:#00e5ff;--prid:#0091ea;--prib:rgba(0,229,255,.1);--pribd:rgba(0,229,255,.3);
--acc:#ff6d00;--accb:rgba(255,109,0,.1);--accbd:rgba(255,109,0,.3);
--ok:#00e676;--err:#ff1744;--wrn:#ffd600;
--sh:rgba(0,0,0,.5);--gl:rgba(255,255,255,.05);--gl2:rgba(255,255,255,.08);
--card-sh:0 8px 32px rgba(0,0,0,.5),0 0 1px rgba(0,229,255,.08);
--needle:#00e5ff;--pvt1:#3a4a5e;--pvt2:#1a2535;
}
[data-theme="light"]{
--bg:#d8dfe8;--bg2:#edf0f5;--bg3:#f5f7fa;--bg4:#e0e5ed;
--card:#ffffff;--card2:#f0f3f7;--cardb:rgba(2,132,199,.06);
--tx:#0f172a;--tx2:#475569;--tx3:#8494a7;
--bd:rgba(0,0,0,.08);--bd2:rgba(0,0,0,.14);
--pri:#0270ad;--prid:#025e90;--prib:rgba(2,132,199,.08);--pribd:rgba(2,132,199,.2);
--acc:#c65a08;--accb:rgba(198,90,8,.08);--accbd:rgba(198,90,8,.2);
--ok:#15803d;--err:#b91c1c;--wrn:#a16207;
--sh:rgba(0,0,0,.08);--gl:rgba(0,0,0,.03);--gl2:rgba(0,0,0,.05);
--card-sh:0 4px 16px rgba(0,0,0,.08),0 1px 3px rgba(0,0,0,.06);
--needle:#0270ad;--pvt1:#8899aa;--pvt2:#556677;
}

html{scroll-behavior:smooth}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;min-height:100dvh;overflow-x:hidden;transition:background .4s,color .4s}

/* â”€â”€ FONDO ANIMADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bgx{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.bgx i{position:absolute;border-radius:50%;filter:blur(100px);opacity:.06;font-style:normal}
[data-theme="light"] .bgx i{opacity:.03}
.bgx i:nth-child(1){width:400px;height:400px;background:var(--pri);top:-120px;right:-100px;animation:gf 22s ease-in-out infinite}
.bgx i:nth-child(2){width:350px;height:350px;background:var(--acc);bottom:-100px;left:-80px;animation:gf 28s ease-in-out infinite reverse}
@keyframes gf{0%,100%{transform:translate(0)}50%{transform:translate(40px,25px)}}

/* â”€â”€ LAYOUT MÃ“VIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app{position:relative;z-index:1;max-width:560px;margin:0 auto;padding:12px}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:8px 4px 14px;gap:6px}
.hdr-l{display:flex;align-items:center;gap:10px;min-width:0}
.hdr-ico{width:42px;height:42px;background:linear-gradient(135deg,var(--pri),var(--prid));border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 3px 12px rgba(0,229,255,.2);flex-shrink:0}
.hdr-t h1{font-family:'Orbitron',monospace;font-size:20px;font-weight:700;background:linear-gradient(90deg,var(--pri),var(--tx));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap}
.hdr-t p{font-size:10px;color:var(--tx3);letter-spacing:3px;text-transform:uppercase;margin-top:1px}
.hdr-r{display:flex;align-items:center;gap:5px;flex-shrink:0}
.hdr-dot{width:8px;height:8px;border-radius:50%;background:var(--tx3);transition:.3s;flex-shrink:0}
.hdr-dot.on{background:var(--ok);box-shadow:0 0 8px rgba(0,230,118,.6);animation:pls 1.5s infinite}
.hdr-dot.rec{background:var(--err);box-shadow:0 0 8px rgba(255,23,68,.6);animation:pls 1s infinite}
.hdr-dot.wrn{background:var(--wrn);box-shadow:0 0 8px rgba(255,214,0,.5)}
@keyframes pls{0%,100%{opacity:1}50%{opacity:.35}}
.hdr-st{font-size:12px;color:var(--tx3);white-space:nowrap;margin-right:2px}
.hbtn{width:36px;height:36px;border-radius:10px;border:1px solid var(--bd);background:var(--gl);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all .2s;color:var(--tx2);flex-shrink:0}
.hbtn:hover{background:var(--gl2);border-color:var(--bd2);color:var(--tx)}
.hbtn:active{transform:scale(.93)}

/* â”€â”€ REPRODUCTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ply{background:var(--card);border-radius:20px;border:1px solid var(--cardb);overflow:hidden;margin-bottom:12px;box-shadow:var(--card-sh);transition:background .4s,border-color .4s}
.ply-empty{text-align:center;padding:28px 20px;color:var(--tx3);font-size:15px}
.ply-empty i{font-size:36px;display:block;margin-bottom:8px;font-style:normal}
.ply-top{display:flex;gap:12px;padding:14px 14px 0}
.ply-art{width:68px;height:68px;border-radius:14px;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:30px;flex-shrink:0;overflow:hidden;border:1px solid var(--bd)}
.ply-art img{width:100%;height:100%;object-fit:cover}
.ply-inf{flex:1;min-width:0;display:flex;flex-direction:column;justify-content:center}
.ply-nm{font-size:18px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ply-mt{font-size:13px;color:var(--tx3);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ply-st{font-size:12px;margin-top:5px;display:flex;align-items:center;gap:5px;font-weight:600}
.ply-st.ld{color:var(--wrn)}.ply-st.pl{color:var(--ok)}.ply-st.er{color:var(--err)}.ply-st.sp{color:var(--tx3)}
.ply-st em{width:7px;height:7px;border-radius:50%;background:currentColor;flex-shrink:0;font-style:normal}
.ply-st.ld em,.ply-st.pl em{animation:pls 1s infinite}

/* â”€â”€ GALVANÃ“METRO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gauge-w{padding:8px 10px 2px;position:relative}
.gauge-cv{width:100%;height:120px;display:block}
.gauge-info{display:flex;justify-content:center;align-items:center;gap:8px;padding:2px 0 0}
.gauge-bdg{font-family:'Orbitron',monospace;font-size:10px;padding:3px 8px;border-radius:4px;letter-spacing:1px;font-weight:600}
.gauge-bdg.st{background:rgba(0,230,118,.12);color:var(--ok);border:1px solid rgba(0,230,118,.25)}
.gauge-bdg.mn{background:rgba(255,214,0,.1);color:var(--wrn);border:1px solid rgba(255,214,0,.2)}
.gauge-kb{font-family:'Orbitron',monospace;font-size:10px;color:var(--tx3)}

/* â”€â”€ CONTROLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ply-ct{display:flex;align-items:center;gap:8px;padding:10px 14px}
.btn-p{width:50px;height:50px;border-radius:50%;border:2px solid var(--bd2);background:var(--gl);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .25s;flex-shrink:0;color:var(--tx);font-size:22px}
.btn-p:hover{border-color:var(--pri);background:var(--prib);color:var(--pri)}
.btn-p:active{transform:scale(.92)}
.btn-p.on{border-color:var(--ok);background:rgba(0,230,118,.1);color:var(--ok);box-shadow:0 0 16px rgba(0,230,118,.15)}
.vol-s{flex:1;display:flex;align-items:center;gap:7px}
.vol-i{font-size:18px;cursor:pointer;flex-shrink:0;width:24px;text-align:center;user-select:none}
.vol-r{-webkit-appearance:none;appearance:none;flex:1;height:5px;background:var(--bg4);border-radius:3px;outline:none}
.vol-r::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;background:var(--tx);border-radius:50%;cursor:pointer;box-shadow:0 2px 6px var(--sh)}
.vol-r::-moz-range-thumb{width:18px;height:18px;background:var(--tx);border-radius:50%;cursor:pointer;border:none}
.vol-v{font-family:'Orbitron',monospace;font-size:12px;color:var(--tx3);width:28px;text-align:right;flex-shrink:0}
.cbtn{width:40px;height:40px;border-radius:10px;border:1px solid var(--bd);background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;transition:all .2s;flex-shrink:0;color:var(--tx2)}
.cbtn:hover{background:var(--gl2)}
.cbtn:active{transform:scale(.93)}
.cbtn.fav-on{border-color:var(--accbd);background:var(--accb);color:var(--acc)}
.cbtn.rec-on{border-color:rgba(255,23,68,.4);background:rgba(255,23,68,.1);color:var(--err);animation:pls 1s infinite}

/* â”€â”€ BARRA GRABACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rec-bar{display:none;align-items:center;gap:8px;padding:10px 14px 12px;background:rgba(255,23,68,.06);border-top:1px solid rgba(255,23,68,.15)}
.rec-bar.on{display:flex}
.rec-dot{width:12px;height:12px;border-radius:50%;background:var(--err);animation:pls .8s infinite;flex-shrink:0}
.rec-info{flex:1;min-width:0}
.rec-tm{font-family:'Orbitron',monospace;font-size:15px;color:var(--err)}
.rec-sz{font-size:12px;color:var(--tx3);margin-top:2px}
.rec-fmt{display:inline-block;font-size:10px;color:var(--pri);background:var(--prib);padding:2px 6px;border-radius:4px;margin-left:6px;font-weight:600}
.rec-stop{padding:8px 14px;border-radius:8px;border:1px solid rgba(255,23,68,.3);background:rgba(255,23,68,.1);color:var(--err);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap}

/* â”€â”€ BÃšSQUEDA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.srch{position:relative;margin-bottom:10px}
.srch input{width:100%;padding:13px 14px 13px 44px;background:var(--card);border:1px solid var(--bd);border-radius:13px;color:var(--tx);font-size:16px;outline:none;font-family:inherit;transition:border .2s,background .4s;box-shadow:var(--card-sh)}
.srch input:focus{border-color:var(--pribd)}
.srch input::placeholder{color:var(--tx3)}
.srch-i{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:16px;color:var(--tx3);pointer-events:none}
.srch-x{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:28px;height:28px;border-radius:50%;border:none;background:var(--gl2);color:var(--tx3);font-size:14px;cursor:pointer;display:none;align-items:center;justify-content:center}
.srch-x.on{display:flex}

/* â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs{display:flex;gap:5px;margin-bottom:8px;overflow-x:auto;scrollbar-width:none;padding:2px 0;-webkit-overflow-scrolling:touch}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:9px 15px;border-radius:10px;background:var(--card);border:1px solid var(--bd);font-size:13px;font-weight:600;color:var(--tx3);cursor:pointer;white-space:nowrap;transition:all .2s;flex-shrink:0;box-shadow:0 2px 8px var(--sh)}
.tab:active{transform:scale(.96)}
.tab.on{background:var(--prib);border-color:var(--pribd);color:var(--pri)}
.scats{display:none;gap:5px;margin-bottom:10px;overflow-x:auto;scrollbar-width:none;padding:2px 0;-webkit-overflow-scrolling:touch;flex-wrap:nowrap}
.scats.on{display:flex}
.scats::-webkit-scrollbar{display:none}
.scat{padding:7px 13px;border-radius:18px;background:var(--gl);border:1px solid var(--bd);font-size:12px;color:var(--tx3);cursor:pointer;white-space:nowrap;transition:all .2s;flex-shrink:0}
.scat:active{transform:scale(.95)}
.scat.on{background:var(--accb);border-color:var(--accbd);color:var(--acc)}
.linf{display:none;justify-content:space-between;align-items:center;padding:2px 4px 8px;font-size:13px;color:var(--tx3)}
.linf.on{display:flex}.linf strong{color:var(--tx)}

/* â”€â”€ LISTA EMISORAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stns{display:flex;flex-direction:column;gap:6px;padding-bottom:18px}
.stn{display:flex;align-items:center;gap:11px;padding:12px;background:var(--card);border:1px solid var(--bd);border-radius:14px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.stn::after{content:'';position:absolute;left:0;top:0;width:3px;height:100%;background:transparent;transition:.2s}
.stn:active{transform:scale(.99)}
.stn.on{background:var(--prib);border-color:var(--pribd)}
.stn.on::after{background:var(--pri)}
.stn-a{width:46px;height:46px;border-radius:10px;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;overflow:hidden}
.stn-a img{width:100%;height:100%;object-fit:cover}
.stn-i{flex:1;min-width:0}
.stn-n{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.stn-d{font-size:12px;color:var(--tx3);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.stn-bg{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap}
.stn-b{font-size:10px;padding:2px 7px;border-radius:4px;background:var(--gl2);color:var(--tx3)}
.stn-b.cd{color:var(--pri);background:var(--prib)}
.stn-r{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
.stn-f{width:32px;height:32px;border-radius:8px;border:none;background:transparent;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s;color:var(--tx3)}
.stn-f.on{color:var(--acc)}
.stn-pi{font-size:11px;color:var(--ok);animation:pls 1s infinite}

/* â”€â”€ BIBLIOTECA DE GRABACIONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lib-empty{text-align:center;padding:30px 20px;color:var(--tx3)}
.lib-empty i{font-size:36px;display:block;margin-bottom:8px;font-style:normal}
.lib-item{display:flex;align-items:center;gap:10px;padding:12px;background:var(--card);border:1px solid var(--bd);border-radius:14px;margin-bottom:6px;box-shadow:0 2px 8px rgba(0,0,0,.08);transition:all .2s}
.lib-item.playing{background:var(--prib);border-color:var(--pribd)}
.lib-art{width:46px;height:46px;border-radius:10px;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;overflow:hidden;border:1px solid var(--bd)}
.lib-art img{width:100%;height:100%;object-fit:cover}
.lib-info{flex:1;min-width:0}
.lib-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lib-meta{font-size:11px;color:var(--tx3);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lib-actions{display:flex;gap:4px;flex-shrink:0}
.lib-btn{width:34px;height:34px;border-radius:9px;border:1px solid var(--bd);background:transparent;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;transition:all .2s;color:var(--tx2)}
.lib-btn:hover{background:var(--gl2)}
.lib-btn:active{transform:scale(.93)}
.lib-btn.del:hover{background:rgba(255,23,68,.1);color:var(--err);border-color:rgba(255,23,68,.3)}
.lib-btn.play-btn.on{color:var(--ok);border-color:rgba(0,230,118,.3);background:rgba(0,230,118,.08)}

/* Mini reproductor de biblioteca */
.lib-player{display:none;background:var(--card);border:1px solid var(--pribd);border-radius:16px;padding:14px;margin-bottom:10px;box-shadow:var(--card-sh)}
.lib-player.on{display:block}
.lib-player-top{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.lib-player-art{width:52px;height:52px;border-radius:10px;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;overflow:hidden}
.lib-player-art img{width:100%;height:100%;object-fit:cover}
.lib-player-info{flex:1;min-width:0}
.lib-player-name{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lib-player-meta{font-size:12px;color:var(--tx3);margin-top:2px}
.lib-player-ctrl{display:flex;align-items:center;gap:8px}
.lib-player-btn{width:44px;height:44px;border-radius:50%;border:2px solid var(--bd2);background:var(--gl);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;transition:all .2s;color:var(--tx)}
.lib-player-btn:hover{border-color:var(--pri);background:var(--prib);color:var(--pri)}
.lib-player-btn.on{border-color:var(--ok);background:rgba(0,230,118,.1);color:var(--ok)}
.lib-progress{flex:1;display:flex;align-items:center;gap:8px}
.lib-prog-bar{-webkit-appearance:none;appearance:none;flex:1;height:5px;background:var(--bg4);border-radius:3px;outline:none;cursor:pointer}
.lib-prog-bar::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;background:var(--pri);border-radius:50%;cursor:pointer}
.lib-time{font-family:'Orbitron',monospace;font-size:10px;color:var(--tx3);white-space:nowrap}

/* â”€â”€ ESTADOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ldg{text-align:center;padding:40px 20px;color:var(--tx3)}
.ldg-s{width:36px;height:36px;border:3px solid var(--bd);border-top-color:var(--pri);border-radius:50%;animation:spn .8s linear infinite;margin:0 auto 12px}
@keyframes spn{to{transform:rotate(360deg)}}
.emt{text-align:center;padding:40px 20px;color:var(--tx3)}
.emt i{font-size:40px;display:block;margin-bottom:10px;font-style:normal}
.emt p{font-size:14px;line-height:1.6}
.btn-rt{padding:11px 24px;border-radius:10px;border:1px solid var(--pribd);background:var(--prib);color:var(--pri);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;margin-top:10px}

/* â”€â”€ MODALES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.mbg.on{opacity:1;pointer-events:all}
[data-theme="light"] .mbg{background:rgba(0,0,0,.25)}
.mdl{background:var(--card);border-radius:20px 20px 0 0;width:100%;max-width:560px;max-height:88vh;overflow-y:auto;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,1,.5,1);border:1px solid var(--bd);border-bottom:none}
.mbg.on .mdl{transform:translateY(0)}
.mdl-h{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--bd);position:sticky;top:0;background:var(--card);z-index:2}
.mdl-h h2{font-size:17px;font-weight:700;display:flex;align-items:center;gap:8px}
.mdl-x{width:34px;height:34px;border-radius:50%;border:none;background:var(--gl2);color:var(--tx2);font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.mdl-b{padding:16px 18px 24px}

/* â”€â”€ ACORDEÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.acc{border:1px solid var(--bd);border-radius:12px;margin-bottom:8px;overflow:hidden;background:var(--bg2);transition:all .3s}
.acc.open{border-color:var(--pribd);background:var(--prib)}
.acc-h{display:flex;align-items:center;gap:8px;padding:14px 16px;cursor:pointer;font-weight:600;font-size:15px;user-select:none;transition:background .2s}
.acc-h:active{background:var(--gl2)}
.acc-ar{font-size:10px;color:var(--tx3);transition:transform .3s,color .3s;flex-shrink:0;display:inline-block}
.acc-h.op .acc-ar{transform:rotate(90deg);color:var(--pri)}
.acc.open .acc-h{border-left:3px solid var(--pri);padding-left:13px}
.acc-c{max-height:0;overflow:hidden;transition:max-height .35s ease}
.acc-c.op{max-height:900px}
.acc-ci{padding:2px 16px 16px}

/* â”€â”€ FORMULARIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sg-r{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.sg-btn{flex:1;min-width:0;padding:11px 6px;border-radius:10px;border:1px solid var(--bd);background:var(--gl);color:var(--tx2);font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;transition:all .2s;font-family:inherit;white-space:nowrap}
.sg-btn:active{transform:scale(.96)}
.sg-btn.on{background:var(--prib);border-color:var(--pribd);color:var(--pri)}
.sg-info{font-size:12px;color:var(--tx3);line-height:1.7;padding:12px;background:var(--gl);border-radius:10px;margin-top:8px;border:1px solid var(--bd)}
.sg-label{font-size:11px;color:var(--tx3);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin:12px 0 6px;display:block}
.fg{margin-bottom:14px}
.fl{display:block;font-size:12px;color:var(--tx3);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:1px}
.fi{width:100%;padding:12px 14px;background:var(--bg2);border:1px solid var(--bd);border-radius:10px;color:var(--tx);font-size:15px;font-family:inherit;outline:none;transition:border .2s}
.fi:focus{border-color:var(--pribd)}
.fi::placeholder{color:var(--tx3)}
select.fi{appearance:auto;-webkit-appearance:auto}
.fact{display:flex;gap:8px;margin-top:16px}
.fb{flex:1;padding:13px;border-radius:11px;border:none;font-size:15px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s}
.fb.pri{background:linear-gradient(135deg,var(--pri),var(--prid));color:#fff;box-shadow:0 3px 12px rgba(0,145,234,.3)}
.fb.sec{background:var(--gl2);border:1px solid var(--bd);color:var(--tx2)}
.fb:active{transform:scale(.97)}

/* â”€â”€ TABLA ACERCA DE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.about-tbl{width:100%}.about-tbl tr{border-bottom:1px solid var(--bd)}.about-tbl tr:last-child{border-bottom:none}.about-tbl td{padding:9px 4px;font-size:14px;vertical-align:top}.about-tbl td:first-child{color:var(--tx3);white-space:nowrap;width:100px;font-weight:600}.about-tbl td:last-child{color:var(--tx)}

/* â”€â”€ PROGRAMADOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sch-tabs{display:flex;gap:4px;margin-bottom:16px}
.sch-tab{flex:1;padding:11px 4px;border-radius:10px;border:1px solid var(--bd);background:var(--gl);color:var(--tx3);font-size:12px;font-weight:600;cursor:pointer;text-align:center;font-family:inherit}
.sch-tab:active{transform:scale(.96)}
.sch-tab.on{background:var(--prib);border-color:var(--pribd);color:var(--pri)}
.sch-pane{display:none}.sch-pane.on{display:block}
.sch-cur{display:flex;align-items:center;gap:10px;padding:10px;background:var(--prib);border:1px solid var(--pribd);border-radius:10px;margin-bottom:12px}
.sch-cur-ico{font-size:20px}
.sch-cur-info{flex:1;min-width:0}
.sch-cur-nm{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sch-cur-lbl{font-size:10px;color:var(--pri);margin-top:2px}
.sch-cur-chg{font-size:11px;color:var(--pri);cursor:pointer;text-decoration:underline;flex-shrink:0}
.whl-grp{display:flex;gap:20px;justify-content:center;margin:10px 0}
.whl-col{text-align:center}
.whl-col-lab{font-size:11px;color:var(--tx3);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.whl-pair{display:flex;align-items:center;gap:4px;justify-content:center}
.whl{display:flex;flex-direction:column;align-items:center;gap:3px;user-select:none;-webkit-user-select:none}
.whl-btn{width:42px;height:30px;border-radius:8px;border:1px solid var(--bd);background:var(--gl);color:var(--tx2);font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:700;transition:all .15s}
.whl-btn:active{transform:scale(.9);background:var(--prib);color:var(--pri)}
.whl-val{font-family:'Orbitron',monospace;font-size:26px;font-weight:700;color:var(--pri);min-width:46px;text-align:center;line-height:1;padding:4px 0;touch-action:none}
.whl-sep{font-size:26px;color:var(--tx3);font-family:'Orbitron',monospace;font-weight:700;padding:0 2px;align-self:center}
.sch-dur{text-align:center;font-size:14px;color:var(--pri);font-weight:600;margin:10px 0;font-family:'Orbitron',monospace}
.days-row{display:flex;gap:5px;justify-content:center;margin:12px 0;flex-wrap:wrap}
.day-btn{width:42px;height:40px;border-radius:10px;border:1px solid var(--bd);background:var(--gl);color:var(--tx3);font-size:13px;font-weight:700;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.day-btn:active{transform:scale(.9)}
.day-btn.on{background:var(--prib);border-color:var(--pribd);color:var(--pri)}
.sch-list{margin-top:16px;border-top:1px solid var(--bd);padding-top:12px}
.sch-item{display:flex;align-items:center;gap:10px;padding:11px;background:var(--bg2);border-radius:10px;margin-bottom:6px;border:1px solid var(--bd)}
.sch-item-info{flex:1;min-width:0}
.sch-item-t{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sch-item-d{font-size:12px;color:var(--tx3);margin-top:2px}
.sch-item-del{width:30px;height:30px;border-radius:50%;border:none;background:transparent;color:var(--tx3);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sch-item-del:hover{background:rgba(255,23,68,.1);color:var(--err)}

/* â”€â”€ EDITOR DE TEMAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.thm-tabs{display:flex;gap:4px;margin-bottom:16px}
.thm-tab{flex:1;padding:11px 4px;border-radius:10px;border:1px solid var(--bd);background:var(--gl);color:var(--tx3);font-size:13px;font-weight:600;cursor:pointer;text-align:center;font-family:inherit;transition:all .2s}
.thm-tab:active{transform:scale(.96)}
.thm-tab.on{background:var(--prib);border-color:var(--pribd);color:var(--pri)}
.thm-pane{display:none}.thm-pane.on{display:block}
.clr-row{display:flex;align-items:center;gap:10px;padding:11px 0;border-bottom:1px solid var(--bd)}
.clr-row:last-child{border-bottom:none}
.clr-icon{font-size:18px;width:26px;text-align:center;flex-shrink:0}
.clr-label{flex:1;font-size:14px;font-weight:500;color:var(--tx)}
.clr-preview{width:34px;height:34px;border-radius:8px;border:2px solid var(--bd2);cursor:pointer;transition:transform .2s,box-shadow .2s}
.clr-preview:hover{transform:scale(1.1);box-shadow:0 2px 8px var(--sh)}
.clr-input{position:absolute;opacity:0;width:0;height:0}
.clr-hex{font-family:'Orbitron',monospace;font-size:11px;color:var(--tx3);width:65px;text-align:right}
.thm-actions{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
.thm-btn{flex:1;min-width:calc(50% - 4px);padding:11px 8px;border-radius:10px;border:1px solid var(--bd);background:var(--gl);color:var(--tx2);font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;transition:all .2s;font-family:inherit}
.thm-btn:active{transform:scale(.96)}
.thm-btn.pri{background:var(--prib);border-color:var(--pribd);color:var(--pri)}
.thm-btn.warn{background:var(--accb);border-color:var(--accbd);color:var(--acc)}
.thm-info{font-size:12px;color:var(--tx3);text-align:center;margin-top:12px;padding:10px;background:var(--gl);border-radius:8px;line-height:1.6}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--card);border:1px solid var(--pribd);border-radius:12px;padding:13px 24px;font-size:14px;z-index:200;transition:transform .4s cubic-bezier(.34,1.56,.64,1);box-shadow:0 8px 30px var(--sh);white-space:nowrap;max-width:92vw;overflow:hidden;text-overflow:ellipsis}
.toast.on{transform:translateX(-50%) translateY(0)}

/* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ftr{text-align:center;padding:8px 20px 22px}
.ftr p{font-size:11px;color:var(--tx3);letter-spacing:1px}
.ftr a{color:var(--pri);text-decoration:none;opacity:.6}

/* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:3px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SMART TV / ANDROID TV â€” Layout adaptativo
   Se activa automÃ¡ticamente en pantallas â‰¥ 1280px
   o cuando se detecta navegaciÃ³n por D-pad
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (min-width:1280px){
  body{font-size:18px;cursor:none}
  .app{max-width:100%;padding:32px 48px;display:grid;grid-template-columns:420px 1fr;grid-template-rows:auto auto 1fr;gap:24px;align-items:start}
  .hdr{grid-column:1/-1;padding:0 0 8px}
  .hdr-ico{width:56px;height:56px;font-size:26px;border-radius:14px}
  .hdr-t h1{font-size:28px}
  .hdr-t p{font-size:13px;letter-spacing:4px}
  .hdr-dot{width:12px;height:12px}
  .hdr-st{font-size:16px}
  .hbtn{width:48px;height:48px;font-size:22px;border-radius:13px}
  .ply{grid-column:1;grid-row:2/4;margin-bottom:0;border-radius:24px}
  .ply-top{padding:20px 20px 0;gap:16px}
  .ply-art{width:90px;height:90px;border-radius:18px;font-size:42px}
  .ply-nm{font-size:22px}
  .ply-mt{font-size:15px}
  .ply-st{font-size:14px}
  .gauge-w{padding:12px 14px 4px}
  .gauge-cv{height:160px}
  .ply-ct{padding:14px 20px;gap:12px}
  .btn-p{width:66px;height:66px;font-size:28px}
  .vol-r{height:7px}
  .vol-r::-webkit-slider-thumb{width:24px;height:24px}
  .vol-v{font-size:15px;width:36px}
  .vol-i{font-size:24px;width:30px}
  .cbtn{width:52px;height:52px;font-size:24px;border-radius:13px}
  .rec-bar{padding:14px 20px 16px}
  .rec-tm{font-size:20px}
  .rec-sz{font-size:14px}
  .srch{grid-column:2;grid-row:2;margin-bottom:0}
  .srch input{padding:16px 18px 16px 52px;font-size:20px;border-radius:16px}
  .srch-i{left:18px;font-size:22px}
  .tabs{grid-column:2;grid-row:3;align-self:start;flex-wrap:wrap;gap:8px;overflow-x:visible}
  .tab{padding:12px 20px;font-size:16px;border-radius:13px}
  .scats{flex-wrap:wrap;overflow-x:visible}
  .scat{padding:10px 18px;font-size:14px;border-radius:22px}
  .stns{gap:10px}
  .stn{padding:16px;border-radius:18px;gap:14px}
  .stn-a{width:60px;height:60px;border-radius:13px;font-size:28px}
  .stn-n{font-size:18px}
  .stn-d{font-size:14px}
  .stn-b{font-size:12px;padding:3px 10px}
  .stn-f{width:42px;height:42px;font-size:22px;border-radius:10px}
  .lib-item{padding:16px;border-radius:18px;gap:14px}
  .lib-art{width:60px;height:60px;border-radius:13px;font-size:28px}
  .lib-name{font-size:17px}
  .lib-meta{font-size:13px}
  .lib-btn{width:42px;height:42px;font-size:20px;border-radius:11px}
  .toast{font-size:18px;padding:16px 32px;border-radius:16px;bottom:48px}
  #sBox{grid-column:2}
  .linf{grid-column:2}
}

/* â”€â”€ FOCO D-PAD (TV) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tv-focus{outline:3px solid var(--pri)!important;outline-offset:3px;box-shadow:0 0 0 6px var(--prib),var(--card-sh)!important;transform:scale(1.03);transition:all .15s}
.tv-mode *:focus{outline:none}

@media(max-width:380px){
  .ply-top{gap:10px;padding:12px 12px 0}.ply-art{width:56px;height:56px}.ply-nm{font-size:16px}
  .ply-ct{padding:8px 12px;gap:6px}.btn-p{width:44px;height:44px;font-size:20px}
  .hdr-t h1{font-size:17px}.tab{padding:8px 11px;font-size:12px}.whl-val{font-size:22px}.stn-n{font-size:14px}
}
</style>
</head>
<body>
<audio id="audio" preload="auto" crossorigin="anonymous"></audio>
<audio id="libAudio" preload="none"></audio>
<div class="bgx"><i></i><i></i></div>
<div class="app">

<!-- HEADER -->
<header class="hdr">
  <div class="hdr-l">
    <div class="hdr-ico">ğŸ“»</div>
    <div class="hdr-t">
      <h1>WaveTuner FM</h1>
      <p>Internet Radio</p>
    </div>
  </div>
  <div class="hdr-r">
    <div class="hdr-dot" id="hDot"></div>
    <span class="hdr-st" id="hSt">Offline</span>
    <button class="hbtn" onclick="openMdl('stgMdl');vib(30)">âš™ï¸</button>
  </div>
</header>

<!-- REPRODUCTOR PRINCIPAL -->
<section class="ply">
  <div class="ply-empty" id="plyE"><i>ğŸ“»</i>Selecciona una emisora para escuchar</div>
  <div id="plyC" style="display:none">
    <div class="ply-top">
      <div class="ply-art" id="plyArt">ğŸ“»</div>
      <div class="ply-inf">
        <div class="ply-nm" id="plyNm">â€”</div>
        <div class="ply-mt" id="plyMt">â€”</div>
        <div class="ply-st sp" id="plySt"><em></em><span id="plyStT">Detenido</span></div>
      </div>
    </div>
    <div class="gauge-w" id="gaugeW">
      <canvas class="gauge-cv" id="gaugeCv"></canvas>
      <div class="gauge-info">
        <span class="gauge-bdg st" id="gBdg">STEREO</span>
        <span class="gauge-kb" id="gKb"></span>
      </div>
    </div>
    <div class="ply-ct">
      <button class="btn-p" id="btnPl" onclick="togglePlay();vib(50)">â–¶</button>
      <div class="vol-s">
        <span class="vol-i" id="volI" onclick="toggleMute();vib(30)">ğŸ”Š</span>
        <input type="range" class="vol-r" id="volR" min="0" max="100" value="80">
        <span class="vol-v" id="volV">80</span>
      </div>
      <button class="cbtn" id="btnFv" onclick="toggleFavCur();vib([40,60,40])">â˜†</button>
      <button class="cbtn" id="btnRc" onclick="toggleRec();vib([50,30,50])">âº</button>
    </div>
    <div class="rec-bar" id="recBar">
      <div class="rec-dot"></div>
      <div class="rec-info">
        <div class="rec-tm"><span id="recTm">00:00</span><span class="rec-fmt" id="recFmt">MP3</span></div>
        <div class="rec-sz" id="recSz">0 KB</div>
      </div>
      <button class="rec-stop" onclick="stopRec();vib(45)">â¹ Guardar</button>
    </div>
  </div>
</section>

<!-- BÃšSQUEDA -->
<div class="srch">
  <span class="srch-i">ğŸ”</span>
  <input type="text" id="srchIn" placeholder="Buscar emisoras...">
  <button class="srch-x" id="srchX" onclick="clrSearch()">âœ•</button>
</div>

<!-- TABS -->
<div class="tabs">
  <button class="tab on" data-t="top" onclick="swTab('top');vib(30)">ğŸ”¥ Popular</button>
  <button class="tab" data-t="favs" onclick="swTab('favs');vib(30)">â­ Favoritos</button>
  <button class="tab" data-t="country" onclick="swTab('country');vib(30)">ğŸŒ PaÃ­ses</button>
  <button class="tab" data-t="genre" onclick="swTab('genre');vib(30)">ğŸµ GÃ©neros</button>
  <button class="tab" data-t="custom" onclick="swTab('custom');vib(30)">ğŸ“Œ Mis Emisoras</button>
  <button class="tab" data-t="library" onclick="swTab('library');vib(30)">ğŸ™ï¸ Grabaciones</button>
</div>

<div class="scats" id="scats"></div>
<div class="linf" id="linf"><span id="lLab"></span><span><strong id="lCnt">0</strong> resultados</span></div>
<div id="sBox"></div>
</div><!-- /.app -->

<!-- â•â•â• MODAL SETTINGS â•â•â• -->
<div class="mbg" id="stgMdl" onclick="maybeClose(event,'stgMdl')">
<div class="mdl">
<div class="mdl-h"><h2>âš™ï¸ ConfiguraciÃ³n</h2><button class="mdl-x" onclick="closeMdl('stgMdl')">âœ•</button></div>
<div class="mdl-b">

<div class="acc"><div class="acc-h op" onclick="togAcc(this);vib(25)"><span class="acc-ar">â–¶</span> ğŸ¨ Tema</div>
<div class="acc-c op"><div class="acc-ci"><div class="sg-r">
  <button class="sg-btn" id="sgDk" onclick="setTheme('dark');vib(30)">ğŸŒ™ Oscuro</button>
  <button class="sg-btn" id="sgLt" onclick="setTheme('light');vib(30)">â˜€ï¸ Claro</button>
  <button class="sg-btn" id="sgAt" onclick="setTheme('auto');vib(30)">ğŸ”„ Auto</button>
</div></div></div></div>

<div class="acc"><div class="acc-h" onclick="togAcc(this);vib(25)"><span class="acc-ar">â–¶</span> ğŸ–Œï¸ Personalizar Colores</div>
<div class="acc-c"><div class="acc-ci"><div class="sg-r">
  <button class="sg-btn" onclick="closeMdl('stgMdl');setTimeout(()=>openMdl('thmMdl'),300);vib(30)">ğŸ¨ Abrir Editor de Temas</button>
</div><div class="sg-info">Personaliza los colores del tema oscuro y claro de forma independiente.</div>
</div></div></div>

<div class="acc"><div class="acc-h" onclick="togAcc(this);vib(25)"><span class="acc-ar">â–¶</span> ğŸšï¸ Calidad de GrabaciÃ³n</div>
<div class="acc-c"><div class="acc-ci">
  <span class="sg-label">Bitrate</span>
  <div class="sg-r">
    <button class="sg-btn" id="sq128" onclick="setQuality(128)">128 kbps</button>
    <button class="sg-btn" id="sq192" onclick="setQuality(192)">192 kbps</button>
    <button class="sg-btn" id="sq320" onclick="setQuality(320)">320 kbps</button>
  </div>
  <span class="sg-label">Formato preferido</span>
  <div class="sg-r">
    <button class="sg-btn" id="sfMp3" onclick="setFormat('mp3');vib(30)">ğŸµ MP3</button>
    <button class="sg-btn" id="sfWebm" onclick="setFormat('webm');vib(30)">ğŸ“¦ WebM</button>
  </div>
  <div class="sg-info">ğŸµ <strong>MP3:</strong> Stream directo, requiere CORS permisivo.<br>ğŸ“¦ <strong>WebM/Opus:</strong> Siempre disponible, alta calidad, compatible con VLC.</div>
</div></div></div>

<div class="acc"><div class="acc-h" onclick="togAcc(this);vib(25)"><span class="acc-ar">â–¶</span> ğŸ“… GrabaciÃ³n Programada</div>
<div class="acc-c"><div class="acc-ci"><div class="sg-r">
  <button class="sg-btn" onclick="closeMdl('stgMdl');setTimeout(()=>openMdl('schMdl'),300);vib(30)">ğŸ“… Abrir Programador</button>
</div><div class="sg-info">âš ï¸ La app debe permanecer abierta para que las grabaciones programadas se ejecuten.</div>
</div></div></div>

<div class="acc"><div class="acc-h" onclick="togAcc(this);vib(25)"><span class="acc-ar">â–¶</span> ğŸ’¾ Datos</div>
<div class="acc-c"><div class="acc-ci"><div class="sg-r">
  <button class="sg-btn" onclick="expData();vib(30)">ğŸ“¤ Exportar</button>
  <button class="sg-btn" onclick="impData();vib(30)">ğŸ“¥ Importar</button>
</div><div class="sg-info">Exporta favoritos, emisoras personalizadas, programaciones y biblioteca.</div>
</div></div></div>

<div class="acc"><div class="acc-h" onclick="togAcc(this);vib(25)"><span class="acc-ar">â–¶</span> ğŸ“² Instalar App</div>
<div class="acc-c"><div class="acc-ci"><div class="sg-r">
  <button class="sg-btn" id="btnInst" onclick="installPWA();vib(30)">ğŸ“² Instalar WaveTuner FM</button>
</div><div class="sg-info" id="pwaI">Desde servidor HTTPS se puede instalar como app.</div>
</div></div></div>

<div class="acc"><div class="acc-h" onclick="togAcc(this);vib(25)"><span class="acc-ar">â–¶</span> â„¹ï¸ Acerca de</div>
<div class="acc-c"><div class="acc-ci"><div class="sg-info" style="padding:16px">
  <div style="text-align:center;margin-bottom:12px"><span style="font-size:36px">ğŸ“»</span><br>
  <strong style="font-family:Orbitron,monospace;font-size:18px;color:var(--pri)">WaveTuner FM</strong></div>
  <table class="about-tbl">
    <tr><td>VersiÃ³n:</td><td><strong>5.0.0</strong></td></tr>
    <tr><td>Fecha:</td><td>19 de Febrero de 2026</td></tr>
    <tr><td>Desarrollador:</td><td>Magdiel Mendoza</td></tr>
    <tr><td>Asistente IA:</td><td>Claude (Anthropic)</td></tr>
    <tr><td>Motor audio:</td><td>HTML5 Audio + Web Audio API</td></tr>
    <tr><td>GrabaciÃ³n:</td><td>MP3 directo / WebM fallback</td></tr>
    <tr><td>Biblioteca:</td><td>Reproductor integrado + Metadata</td></tr>
    <tr><td>Visualizador:</td><td>GalvanÃ³metro analÃ³gico</td></tr>
    <tr><td>Fuente datos:</td><td>Radio Browser API</td></tr>
    <tr><td>Smart TV:</td><td>Layout adaptativo + D-pad</td></tr>
    <tr><td>Soporte:</td><td>MP3, AAC, WebM, M3U, M3U8, PLS</td></tr>
  </table>
  <div style="margin-top:12px;text-align:center;font-size:11px;color:var(--tx3)">Espacio=Play Â· â†‘â†“=Vol Â· M=Mute Â· F=Fav Â· R=Rec Â· L=Biblioteca</div>
</div></div></div></div>

</div></div></div>

<!-- â•â•â• MODAL ADD STATION â•â•â• -->
<div class="mbg" id="addMdl" onclick="maybeClose(event,'addMdl')">
<div class="mdl">
<div class="mdl-h"><h2>ğŸ“Œ Agregar Emisora</h2><button class="mdl-x" onclick="closeMdl('addMdl')">âœ•</button></div>
<div class="mdl-b">
  <div class="fg"><label class="fl">Nombre *</label><input class="fi" id="fNm" placeholder="Mi Radio"></div>
  <div class="fg"><label class="fl">URL del Stream *</label><input class="fi" id="fUrl" placeholder="https://stream.ejemplo.com/radio.mp3"></div>
  <div class="sg-info" style="margin:-8px 0 14px;font-size:11px">âœ… Soporta: MP3, AAC, M3U, M3U8, PLS</div>
  <div class="fg"><label class="fl">PaÃ­s (opcional)</label><input class="fi" id="fPais" placeholder="Venezuela"></div>
  <div class="fg"><label class="fl">GÃ©nero (opcional)</label><input class="fi" id="fGen" placeholder="Pop, Rock"></div>
  <div class="fact">
    <button class="fb sec" onclick="closeMdl('addMdl')">Cancelar</button>
    <button class="fb pri" onclick="saveCustom();vib(50)">ğŸ’¾ Guardar</button>
  </div>
</div></div></div>

<!-- â•â•â• MODAL SCHEDULE â•â•â• -->
<div class="mbg" id="schMdl" onclick="maybeClose(event,'schMdl')">
<div class="mdl">
<div class="mdl-h"><h2>ğŸ“… GrabaciÃ³n Programada</h2><button class="mdl-x" onclick="closeMdl('schMdl')">âœ•</button></div>
<div class="mdl-b">
  <div class="sch-tabs">
    <button class="sch-tab on" data-s="timed" onclick="swSchTab('timed');vib(30)">â± Temporizado</button>
    <button class="sch-tab" data-s="sched" onclick="swSchTab('sched');vib(30)">ğŸ“… Horario</button>
    <button class="sch-tab" data-s="recur" onclick="swSchTab('recur');vib(30)">ğŸ” Recurrente</button>
  </div>
  <div class="sch-pane on" id="spTimed">
    <p style="font-size:13px;color:var(--tx3);margin-bottom:12px">Graba la emisora actual durante los minutos indicados:</p>
    <div id="schTimedCur"></div>
    <div class="fg"><label class="fl">DuraciÃ³n (minutos)</label><input class="fi" id="schTimedMin" type="number" min="1" max="480" value="30"></div>
    <div class="fact"><button class="fb pri" onclick="startTimedRec();vib([50,30,50])">âº Iniciar GrabaciÃ³n</button></div>
  </div>
  <div class="sch-pane" id="spSched">
    <p style="font-size:13px;color:var(--tx3);margin-bottom:12px">Programa grabaciÃ³n para fecha y hora especÃ­fica:</p>
    <div id="schSchedCur"></div>
    <div class="fg" id="schSchedStnWrap" style="display:none"><label class="fl">Emisora (de favoritos)</label><select class="fi" id="schSchedStn"></select></div>
    <div class="fg"><label class="fl">Fecha</label><input class="fi" id="schSchedDate" type="date"></div>
    <div class="whl-grp">
      <div class="whl-col"><div class="whl-col-lab">Inicio</div><div class="whl-pair">
        <div class="whl"><div class="whl-btn" onpointerdown="whlD('wH1',1)">â–²</div><div class="whl-val" id="wH1v">08</div><div class="whl-btn" onpointerdown="whlD('wH1',-1)">â–¼</div></div>
        <span class="whl-sep">:</span>
        <div class="whl"><div class="whl-btn" onpointerdown="whlD('wM1',1)">â–²</div><div class="whl-val" id="wM1v">00</div><div class="whl-btn" onpointerdown="whlD('wM1',-1)">â–¼</div></div>
      </div></div>
      <div class="whl-col"><div class="whl-col-lab">Fin</div><div class="whl-pair">
        <div class="whl"><div class="whl-btn" onpointerdown="whlD('wH1e',1)">â–²</div><div class="whl-val" id="wH1ev">09</div><div class="whl-btn" onpointerdown="whlD('wH1e',-1)">â–¼</div></div>
        <span class="whl-sep">:</span>
        <div class="whl"><div class="whl-btn" onpointerdown="whlD('wM1e',1)">â–²</div><div class="whl-val" id="wM1ev">00</div><div class="whl-btn" onpointerdown="whlD('wM1e',-1)">â–¼</div></div>
      </div></div>
    </div>
    <div class="sch-dur" id="schDur1">â± DuraciÃ³n: 1h 00min</div>
    <div class="fact"><button class="fb pri" onclick="addSchedule('sched');vib(50)">ğŸ“… Programar</button></div>
  </div>
  <div class="sch-pane" id="spRecur">
    <p style="font-size:13px;color:var(--tx3);margin-bottom:12px">Graba automÃ¡ticamente cada semana en los dÃ­as y hora indicados:</p>
    <div id="schRecurCur"></div>
    <div class="fg" id="schRecurStnWrap" style="display:none"><label class="fl">Emisora (de favoritos)</label><select class="fi" id="schRecurStn"></select></div>
    <div class="whl-grp">
      <div class="whl-col"><div class="whl-col-lab">Inicio</div><div class="whl-pair">
        <div class="whl"><div class="whl-btn" onpointerdown="whlD('wH2',1)">â–²</div><div class="whl-val" id="wH2v">08</div><div class="whl-btn" onpointerdown="whlD('wH2',-1)">â–¼</div></div>
        <span class="whl-sep">:</span>
        <div class="whl"><div class="whl-btn" onpointerdown="whlD('wM2',1)">â–²</div><div class="whl-val" id="wM2v">00</div><div class="whl-btn" onpointerdown="whlD('wM2',-1)">â–¼</div></div>
      </div></div>
      <div class="whl-col"><div class="whl-col-lab">Fin</div><div class="whl-pair">
        <div class="whl"><div class="whl-btn" onpointerdown="whlD('wH2e',1)">â–²</div><div class="whl-val" id="wH2ev">09</div><div class="whl-btn" onpointerdown="whlD('wH2e',-1)">â–¼</div></div>
        <span class="whl-sep">:</span>
        <div class="whl"><div class="whl-btn" onpointerdown="whlD('wM2e',1)">â–²</div><div class="whl-val" id="wM2ev">00</div><div class="whl-btn" onpointerdown="whlD('wM2e',-1)">â–¼</div></div>
      </div></div>
    </div>
    <div class="sch-dur" id="schDur2">â± DuraciÃ³n: 1h 00min</div>
    <div class="fl" style="text-align:center;margin:6px 0 4px">DÃ­as de la semana</div>
    <div class="days-row" id="daysRow">
      <button class="day-btn" data-d="1" onclick="togDay(this);vib(30)">Lu</button>
      <button class="day-btn" data-d="2" onclick="togDay(this);vib(30)">Ma</button>
      <button class="day-btn" data-d="3" onclick="togDay(this);vib(30)">Mi</button>
      <button class="day-btn" data-d="4" onclick="togDay(this);vib(30)">Ju</button>
      <button class="day-btn" data-d="5" onclick="togDay(this);vib(30)">Vi</button>
      <button class="day-btn" data-d="6" onclick="togDay(this);vib(30)">Sa</button>
      <button class="day-btn" data-d="0" onclick="togDay(this);vib(30)">Do</button>
    </div>
    <div class="fact"><button class="fb pri" onclick="addSchedule('recur');vib(50)">ğŸ” Programar</button></div>
  </div>
  <div class="sch-list" id="schListW" style="display:none"><div class="fl" style="margin-bottom:8px">Programaciones activas</div><div id="schList"></div></div>
</div></div></div>

<!-- â•â•â• MODAL THEME EDITOR â•â•â• -->
<div class="mbg" id="thmMdl" onclick="maybeClose(event,'thmMdl')">
<div class="mdl">
<div class="mdl-h"><h2>ğŸ¨ Personalizar Tema</h2><button class="mdl-x" onclick="closeMdl('thmMdl')">âœ•</button></div>
<div class="mdl-b">
  <div class="thm-tabs">
    <button class="thm-tab on" data-th="dark" onclick="swThmTab('dark');vib(30)">ğŸŒ™ Oscuro</button>
    <button class="thm-tab" data-th="light" onclick="swThmTab('light');vib(30)">â˜€ï¸ Claro</button>
  </div>
  <div class="thm-pane on" id="tpDark">
    <div class="clr-row"><span class="clr-icon">ğŸ–¼ï¸</span><span class="clr-label">Fondo principal</span><input type="color" class="clr-input" id="cDkBg" onchange="updThmClr('dark','bg',this.value)"><label class="clr-preview" for="cDkBg" id="pDkBg"></label><span class="clr-hex" id="hDkBg">#050810</span></div>
    <div class="clr-row"><span class="clr-icon">ğŸ“¦</span><span class="clr-label">Fondo tarjetas</span><input type="color" class="clr-input" id="cDkCard" onchange="updThmClr('dark','card',this.value)"><label class="clr-preview" for="cDkCard" id="pDkCard"></label><span class="clr-hex" id="hDkCard">#131b2d</span></div>
    <div class="clr-row"><span class="clr-icon">ğŸ“</span><span class="clr-label">Texto principal</span><input type="color" class="clr-input" id="cDkTx" onchange="updThmClr('dark','tx',this.value)"><label class="clr-preview" for="cDkTx" id="pDkTx"></label><span class="clr-hex" id="hDkTx">#e0e7ff</span></div>
    <div class="clr-row"><span class="clr-icon">ğŸ’¬</span><span class="clr-label">Texto secundario</span><input type="color" class="clr-input" id="cDkTx2" onchange="updThmClr('dark','tx2',this.value)"><label class="clr-preview" for="cDkTx2" id="pDkTx2"></label><span class="clr-hex" id="hDkTx2">#94a3b8</span></div>
    <div class="clr-row"><span class="clr-icon">ğŸ”µ</span><span class="clr-label">Color primario</span><input type="color" class="clr-input" id="cDkPri" onchange="updThmClr('dark','pri',this.value)"><label class="clr-preview" for="cDkPri" id="pDkPri"></label><span class="clr-hex" id="hDkPri">#00e5ff</span></div>
    <div class="clr-row"><span class="clr-icon">ğŸŸ </span><span class="clr-label">Color acento</span><input type="color" class="clr-input" id="cDkAcc" onchange="updThmClr('dark','acc',this.value)"><label class="clr-preview" for="cDkAcc" id="pDkAcc"></label><span class="clr-hex" id="hDkAcc">#ff6d00</span></div>
  </div>
  <div class="thm-pane" id="tpLight">
    <div class="clr-row"><span class="clr-icon">ğŸ–¼ï¸</span><span class="clr-label">Fondo principal</span><input type="color" class="clr-input" id="cLtBg" onchange="updThmClr('light','bg',this.value)"><label class="clr-preview" for="cLtBg" id="pLtBg"></label><span class="clr-hex" id="hLtBg">#d8dfe8</span></div>
    <div class="clr-row"><span class="clr-icon">ğŸ“¦</span><span class="clr-label">Fondo tarjetas</span><input type="color" class="clr-input" id="cLtCard" onchange="updThmClr('light','card',this.value)"><label class="clr-preview" for="cLtCard" id="pLtCard"></label><span class="clr-hex" id="hLtCard">#ffffff</span></div>
    <div class="clr-row"><span class="clr-icon">ğŸ“</span><span class="clr-label">Texto principal</span><input type="color" class="clr-input" id="cLtTx" onchange="updThmClr('light','tx',this.value)"><label class="clr-preview" for="cLtTx" id="pLtTx"></label><span class="clr-hex" id="hLtTx">#0f172a</span></div>
    <div class="clr-row"><span class="clr-icon">ğŸ’¬</span><span class="clr-label">Texto secundario</span><input type="color" class="clr-input" id="cLtTx2" onchange="updThmClr('light','tx2',this.value)"><label class="clr-preview" for="cLtTx2" id="pLtTx2"></label><span class="clr-hex" id="hLtTx2">#475569</span></div>
    <div class="clr-row"><span class="clr-icon">ğŸ”µ</span><span class="clr-label">Color primario</span><input type="color" class="clr-input" id="cLtPri" onchange="updThmClr('light','pri',this.value)"><label class="clr-preview" for="cLtPri" id="pLtPri"></label><span class="clr-hex" id="hLtPri">#0270ad</span></div>
    <div class="clr-row"><span class="clr-icon">ğŸŸ </span><span class="clr-label">Color acento</span><input type="color" class="clr-input" id="cLtAcc" onchange="updThmClr('light','acc',this.value)"><label class="clr-preview" for="cLtAcc" id="pLtAcc"></label><span class="clr-hex" id="hLtAcc">#c65a08</span></div>
  </div>
  <div class="thm-actions">
    <button class="thm-btn" onclick="expTheme();vib(30)">ğŸ“¤ Exportar</button>
    <button class="thm-btn" onclick="impTheme();vib(30)">ğŸ“¥ Importar</button>
    <button class="thm-btn warn" onclick="resetTheme();vib(45)">ğŸ”„ Restablecer</button>
    <button class="thm-btn pri" onclick="saveThmColors();vib(50)">ğŸ’¾ Guardar</button>
  </div>
  <div class="thm-info">Los colores se aplican en tiempo real. Pulsa "Guardar" para conservar los cambios.</div>
</div></div></div>

<input type="file" id="fileIn" accept=".json" style="display:none" onchange="handleImp(event)">
<input type="file" id="thmFileIn" accept=".json" style="display:none" onchange="handleThmImp(event)">
<input type="file" id="libFileIn" accept="audio/*,.mp3,.webm,.ogg,.wav,.aac,.m4a" multiple style="display:none" onchange="handleLibImp(event)">
<div class="toast" id="toast"></div>
<footer class="ftr"><p>WaveTuner FM v5.0.0 â€” <a href="https://www.radio-browser.info" target="_blank">Radio Browser API</a></p></footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SRVS = ['https://de1.api.radio-browser.info','https://at1.api.radio-browser.info','https://nl1.api.radio-browser.info'];

const COUNTRIES = [
  {n:'EspaÃ±a',c:'ES',f:'ğŸ‡ªğŸ‡¸'},{n:'MÃ©xico',c:'MX',f:'ğŸ‡²ğŸ‡½'},{n:'Argentina',c:'AR',f:'ğŸ‡¦ğŸ‡·'},
  {n:'Colombia',c:'CO',f:'ğŸ‡¨ğŸ‡´'},{n:'Chile',c:'CL',f:'ğŸ‡¨ğŸ‡±'},{n:'PerÃº',c:'PE',f:'ğŸ‡µğŸ‡ª'},
  {n:'Venezuela',c:'VE',f:'ğŸ‡»ğŸ‡ª'},{n:'Ecuador',c:'EC',f:'ğŸ‡ªğŸ‡¨'},{n:'R.Dominicana',c:'DO',f:'ğŸ‡©ğŸ‡´'},
  {n:'Costa Rica',c:'CR',f:'ğŸ‡¨ğŸ‡·'},{n:'PanamÃ¡',c:'PA',f:'ğŸ‡µğŸ‡¦'},{n:'Uruguay',c:'UY',f:'ğŸ‡ºğŸ‡¾'},
  {n:'Paraguay',c:'PY',f:'ğŸ‡µğŸ‡¾'},{n:'Bolivia',c:'BO',f:'ğŸ‡§ğŸ‡´'},{n:'Cuba',c:'CU',f:'ğŸ‡¨ğŸ‡º'},
  {n:'Guatemala',c:'GT',f:'ğŸ‡¬ğŸ‡¹'},{n:'Honduras',c:'HN',f:'ğŸ‡­ğŸ‡³'},{n:'El Salvador',c:'SV',f:'ğŸ‡¸ğŸ‡»'},
  {n:'Nicaragua',c:'NI',f:'ğŸ‡³ğŸ‡®'},{n:'Puerto Rico',c:'PR',f:'ğŸ‡µğŸ‡·'},{n:'USA',c:'US',f:'ğŸ‡ºğŸ‡¸'},
  {n:'CanadÃ¡',c:'CA',f:'ğŸ‡¨ğŸ‡¦'},{n:'UK',c:'GB',f:'ğŸ‡¬ğŸ‡§'},{n:'Brasil',c:'BR',f:'ğŸ‡§ğŸ‡·'},
  {n:'Francia',c:'FR',f:'ğŸ‡«ğŸ‡·'},{n:'Alemania',c:'DE',f:'ğŸ‡©ğŸ‡ª'},{n:'Italia',c:'IT',f:'ğŸ‡®ğŸ‡¹'},
  {n:'Portugal',c:'PT',f:'ğŸ‡µğŸ‡¹'},{n:'JapÃ³n',c:'JP',f:'ğŸ‡¯ğŸ‡µ'},{n:'Corea',c:'KR',f:'ğŸ‡°ğŸ‡·'},
  {n:'Australia',c:'AU',f:'ğŸ‡¦ğŸ‡º'},{n:'India',c:'IN',f:'ğŸ‡®ğŸ‡³'},{n:'Rusia',c:'RU',f:'ğŸ‡·ğŸ‡º'},{n:'China',c:'CN',f:'ğŸ‡¨ğŸ‡³'}
];

const GENRES = [
  {id:'pop',n:'Pop',i:'ğŸ¤'},{id:'rock',n:'Rock',i:'ğŸ¸'},{id:'jazz',n:'Jazz',i:'ğŸ·'},
  {id:'classical',n:'ClÃ¡sica',i:'ğŸ»'},{id:'electronic',n:'ElectrÃ³nica',i:'ğŸ›ï¸'},
  {id:'latin',n:'Latina',i:'ğŸ’ƒ'},{id:'hip hop',n:'Hip Hop',i:'ğŸ¤'},{id:'rnb',n:'R&B',i:'ğŸµ'},
  {id:'country',n:'Country',i:'ğŸ¤ '},{id:'reggae',n:'Reggae',i:'ğŸŸ¢'},{id:'metal',n:'Metal',i:'ğŸ¤˜'},
  {id:'blues',n:'Blues',i:'ğŸ¸'},{id:'folk',n:'Folk',i:'ğŸª•'},{id:'soul',n:'Soul',i:'ğŸ’œ'},
  {id:'dance',n:'Dance',i:'ğŸ•º'},{id:'ambient',n:'Ambient',i:'ğŸŒŠ'},{id:'reggaeton',n:'ReggaetÃ³n',i:'ğŸ”¥'},
  {id:'salsa',n:'Salsa',i:'ğŸ’ƒ'},{id:'tropical',n:'Tropical',i:'ğŸŒ´'},{id:'80s',n:'80s',i:'ğŸ“¼'},
  {id:'90s',n:'90s',i:'ğŸ’¿'},{id:'oldies',n:'Oldies',i:'ğŸ“»'},{id:'news',n:'Noticias',i:'ğŸ“°'},
  {id:'talk',n:'Talk',i:'ğŸ™ï¸'},{id:'christian',n:'Cristiana',i:'âœï¸'},{id:'sports',n:'Deportes',i:'âš½'},
  {id:'lounge',n:'Lounge',i:'ğŸ¸'}
];

const DEG = Math.PI / 180;

const DEFAULT_STN = {
  stationuuid:'default_dinamica929', name:'DinÃ¡mica 92.9 FM',
  url:'https://guri.tepuyserver.net/8012/stream', url_resolved:'https://guri.tepuyserver.net/8012/stream',
  favicon:'', country:'Venezuela', countrycode:'VE', tags:'radio en vivo', codec:'MP3', bitrate:128, isCustom:false
};

const DEFAULT_COLORS = {
  dark:{bg:'#050810',card:'#131b2d',tx:'#e0e7ff',tx2:'#94a3b8',pri:'#00e5ff',acc:'#ff6d00'},
  light:{bg:'#d8dfe8',card:'#ffffff',tx:'#0f172a',tx2:'#475569',pri:'#0270ad',acc:'#c65a08'}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const isFirstRun = localStorage.getItem('wtfm_favs') === null;

const S = {
  srv: SRVS[0], list:[], cur:null, pb:'stopped',
  vol:80, muted:false,
  favs: isFirstRun ? [{...DEFAULT_STN}] : JP('wtfm_favs',[]),
  custom: JP('wtfm_custom',[]),
  lastStation: JP('wtfm_last',null),
  tab:'top', sub:null, sq:'', loading:false, err:null,
  theme: localStorage.getItem('wtfm_theme')||'dark',
  quality: parseInt(localStorage.getItem('wtfm_q'))||128,
  prefFormat: localStorage.getItem('wtfm_fmt')||'mp3',
  // GrabaciÃ³n
  recActive:false, recReader:null, recChunks:[], recStart:0,
  recTimer:null, recMime:'', recMethod:null, recMR:null,
  recAutoStop:null, recAbort:null, recTotalSec:0, recSchId:null,
  recFormat:'mp3', recFallbackInterval:null,
  // GalvanÃ³metro
  nL:0, nR:0, vL:0, vR:0, gaugeReady:false, af:null,
  // ProgramaciÃ³n
  schedules: JP('wtfm_sch',[]),
  wheels:{
    wH1:{v:8,min:0,max:23},wM1:{v:0,min:0,max:59},
    wH1e:{v:9,min:0,max:23},wM1e:{v:0,min:0,max:59},
    wH2:{v:8,min:0,max:23},wM2:{v:0,min:0,max:59},
    wH2e:{v:9,min:0,max:23},wM2e:{v:0,min:0,max:59}
  },
  // PWA
  deferredPrompt:null,
  customColors: JP('wtfm_colors',{dark:{...DEFAULT_COLORS.dark},light:{...DEFAULT_COLORS.light}}),
  reconnectAttempts:0, maxReconnects:3,
  schUseCurrent:{timed:true,sched:true,recur:true},
  // Biblioteca de grabaciones
  library: JP('wtfm_library',[]),
  libCurId: null,
  libPlaying: false,
  libProgTimer: null,
  // Smart TV
  tvMode: false,
  tvFocusIdx: 0,
  tvFocusables: []
};

if (isFirstRun) saveFavs();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILIDADES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function JP(k,d){try{return JSON.parse(localStorage.getItem(k))||d;}catch{return d;}}
const $=id=>document.getElementById(id);
const audio=$('audio');
const libAudio=$('libAudio');

function vib(p){try{if(navigator.vibrate)navigator.vibrate(p);}catch{}}

function tsNow(){
  const d=new Date();
  return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getFullYear()).slice(-2)}_${String(d.getHours()).padStart(2,'0')}-${String(d.getMinutes()).padStart(2,'0')}`;
}

function mkFlag(c){
  if(!c||c.length!==2)return'ğŸŒ';
  return String.fromCodePoint(...[...c.toUpperCase()].map(x=>0x1F1E6+x.charCodeAt(0)-65));
}

function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}

function toast(m){
  const t=$('toast');t.textContent=m;t.classList.add('on');
  clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('on'),2800);
}

function fmtSize(bytes){
  if(bytes<1024)return bytes+'B';
  if(bytes<1048576)return(bytes/1024).toFixed(1)+'KB';
  return(bytes/1048576).toFixed(1)+'MB';
}

function fmtTime(sec){
  const m=Math.floor(sec/60),s=Math.floor(sec%60);
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYLIST RESOLVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isPlaylistUrl(url){
  if(!url)return false;
  const l=url.toLowerCase();
  return l.endsWith('.m3u')||l.endsWith('.m3u8')||l.endsWith('.pls')||
         l.includes('.m3u?')||l.includes('.m3u8?')||l.includes('.pls?');
}

async function resolvePlaylistUrl(url){
  if(!isPlaylistUrl(url))return url;
  try{
    const r=await fetch(url,{mode:'cors'});
    if(!r.ok)return url;
    const content=await r.text();
    const l=url.toLowerCase();
    if(l.includes('.pls')){const m=content.match(/File1\s*=\s*(.+)/i);if(m)return m[1].trim();}
    else{const lines=content.split('\n').map(x=>x.trim()).filter(x=>x&&!x.startsWith('#'));if(lines.length)return lines[0];}
  }catch{}
  return url;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API RADIO BROWSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(ep){
  for(const sv of SRVS){
    try{
      const c=new AbortController();
      const t=setTimeout(()=>c.abort(),8000);
      const r=await fetch(sv+ep,{signal:c.signal});
      clearTimeout(t);
      if(r.ok){S.srv=sv;return r.json();}
    }catch{}
  }
  throw new Error('Sin conexiÃ³n al servidor');
}

const apiTop=()=>api('/json/stations/topvote?limit=80&hidebroken=true');
const apiCountry=c=>api(`/json/stations/bycountrycodeexact/${c}?limit=100&hidebroken=true&order=votes&reverse=true`);
const apiTag=t=>api(`/json/stations/bytag/${encodeURIComponent(t)}?limit=80&hidebroken=true&order=votes&reverse=true`);
const apiSearch=q=>api(`/json/stations/byname/${encodeURIComponent(q)}?limit=80&hidebroken=true&order=votes&reverse=true`);
const apiClick=u=>{try{fetch(`${S.srv}/json/url/${u}`);}catch{}};

async function loadList(fn,label){
  S.loading=true;S.err=null;renderBox();
  try{
    let d=await fn();
    d=d.filter(s=>s.url_resolved&&s.name&&s.name.trim());
    const seen=new Set();
    d=d.filter(s=>{if(seen.has(s.url_resolved))return false;seen.add(s.url_resolved);return true;});
    S.list=d;S.loading=false;renderBox();showLinf(true,label,d.length);
  }catch(e){S.loading=false;S.err=e.message;S.list=[];renderBox();showLinf(false);}
}

function showLinf(s,l,c){
  const e=$('linf');
  if(s){e.classList.add('on');$('lLab').textContent=l;$('lCnt').textContent=c;}
  else e.classList.remove('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROL DE AUDIO PRINCIPAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
audio.addEventListener('loadstart',()=>{if(S.cur)setPB('loading');});
audio.addEventListener('waiting',()=>{if(S.cur)setPB('loading');});
audio.addEventListener('playing',()=>{S.reconnectAttempts=0;setPB('playing');updMedia();});
audio.addEventListener('pause',()=>{if(!audio.src||audio.ended)setPB('stopped');});
audio.addEventListener('error',()=>{if(S.cur)setPB('error');});
audio.addEventListener('stalled',()=>{if(S.cur&&S.pb==='playing')tryReconnect();});
audio.addEventListener('ended',()=>{if(S.cur&&S.pb==='playing')tryReconnect();});

function tryReconnect(){
  if(S.reconnectAttempts>=S.maxReconnects){toast('âš ï¸ ConexiÃ³n perdida');setPB('error');return;}
  S.reconnectAttempts++;
  toast(`ğŸ”„ Reconectando... (${S.reconnectAttempts}/${S.maxReconnects})`);
  setTimeout(()=>{if(S.cur&&S.pb!=='stopped'){audio.load();audio.play().catch(()=>setPB('error'));}},2000);
}

async function playStn(stn){
  // Detener biblioteca si estaba reproduciendo
  if(S.libPlaying) stopLibAudio();
  vib(35);
  S.cur=stn;S.reconnectAttempts=0;
  setPB('loading');showPly(true);
  let streamUrl=stn.url_resolved||stn.url;
  if(isPlaylistUrl(streamUrl)){
    toast('ğŸ”„ Resolviendo playlist...');
    try{streamUrl=await resolvePlaylistUrl(streamUrl);stn.url_resolved=streamUrl;}catch{}
  }
  audio.src=streamUrl;
  audio.volume=S.muted?0:S.vol/100;
  audio.load();
  const p=audio.play();
  if(p)p.catch(e=>{if(e.name!=='AbortError')setPB('error');});
  if(stn.stationuuid)apiClick(stn.stationuuid);
  updPlyInfo();renderStnList();saveLastStation(stn);
  toast('ğŸ“» '+stn.name);
}

function stopAudio(){audio.pause();audio.removeAttribute('src');audio.load();setPB('stopped');}
function togglePlay(){if(!S.cur)return;(S.pb==='playing'||S.pb==='loading')?stopAudio():playStn(S.cur);}
function setPB(s){S.pb=s;updPlySt();updHdr();updPlayBtn();}
function setVol(v){S.vol=v;S.muted=false;audio.volume=v/100;updVolUI();}
function toggleMute(){S.muted=!S.muted;audio.volume=S.muted?0:S.vol/100;updVolUI();}

function saveLastStation(stn){S.lastStation=pickStn(stn);localStorage.setItem('wtfm_last',JSON.stringify(S.lastStation));}
function loadLastStation(){
  if(S.lastStation){S.cur=S.lastStation;showPly(true);updPlyInfo();updFavBtn();toast('ğŸ“» '+S.lastStation.name+' lista');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA DE GRABACIÃ“N v5.0.0 + METADATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcRecBytes(){let b=0;S.recChunks.forEach(c=>b+=(c.byteLength||c.size||0));return b;}
function clearFallbackCheck(){if(S.recFallbackInterval){clearTimeout(S.recFallbackInterval);S.recFallbackInterval=null;}}

async function toggleRec(){
  if(S.recActive){stopRec();return;}
  if(S.pb!=='playing'){toast('âš ï¸ Primero reproduce una emisora');vib([60,50,60]);return;}
  startRecording(0,null);
}

async function startRecording(totalSec,schId){
  if(S.recActive)return;
  S.recActive=true;S.recChunks=[];S.recStart=Date.now();
  S.recMethod=null;S.recTotalSec=totalSec;S.recSchId=schId;S.recFormat='mp3';
  showRecUI(true);
  if(totalSec>0){
    S.recAutoStop=setTimeout(()=>{stopRec();toast('â¹ GrabaciÃ³n programada finalizada');vib([50,30,50]);},totalSec*1000);
  }
  const url=S.cur.url_resolved||S.cur.url;
  const preferMp3=S.prefFormat==='mp3';

  const tryFetchDirect=async()=>{
    try{
      const ctrl=new AbortController();
      const tid=setTimeout(()=>ctrl.abort(),4000);
      const resp=await fetch(url,{signal:ctrl.signal,mode:'cors',headers:{'Range':'bytes=0-'}});
      clearTimeout(tid);
      if(!resp.ok||!resp.body)return false;
      S.recMethod='fetch';S.recMime=resp.headers.get('content-type')||'audio/mpeg';
      S.recFormat=S.recMime.includes('aac')?'aac':'mp3';
      S.recReader=resp.body.getReader();
      updRecFmt();toast(`ğŸ”´ Grabando (${S.recFormat.toUpperCase()})`);
      readStream();
      S.recFallbackInterval=setTimeout(()=>{
        if(S.recActive&&calcRecBytes()===0){clearFallbackCheck();switchToWebM();}
        else clearFallbackCheck();
      },3000);
      return true;
    }catch{return false;}
  };

  const tryMediaRecorder=async()=>{
    try{
      let stream;
      if(audio.captureStream)stream=audio.captureStream();
      else if(audio.mozCaptureStream)stream=audio.mozCaptureStream();
      if(!stream||stream.getAudioTracks().length===0)return false;
      const mime=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/webm';
      S.recMR=new MediaRecorder(stream,{mimeType:mime,audioBitsPerSecond:S.quality*1000});
      S.recMethod='capture';S.recMime=mime;S.recFormat='webm';
      S.recMR.ondataavailable=e=>{if(e.data&&e.data.size>0)S.recChunks.push(e.data);};
      S.recMR.onerror=()=>console.warn('MediaRecorder error');
      S.recMR.start(1000);updRecFmt();toast('ğŸ”´ Grabando (WebM Â· Alta calidad)');
      return true;
    }catch{return false;}
  };

  if(preferMp3){
    if(!await tryFetchDirect())if(!await tryMediaRecorder()){S.recActive=false;showRecUI(false);toast('âš ï¸ GrabaciÃ³n no disponible');vib([60,50,60,50,60]);}
  }else{
    if(!await tryMediaRecorder())if(!await tryFetchDirect()){S.recActive=false;showRecUI(false);toast('âš ï¸ GrabaciÃ³n no disponible');vib([60,50,60,50,60]);}
  }
}

async function switchToWebM(){
  if(!S.recActive)return;
  if(S.recReader)try{S.recReader.cancel();}catch{}
  S.recReader=null;S.recMethod=null;S.recChunks=[];
  try{
    let stream;
    if(audio.captureStream)stream=audio.captureStream();
    else if(audio.mozCaptureStream)stream=audio.mozCaptureStream();
    if(!stream||stream.getAudioTracks().length===0){toast('âš ï¸ No se pudo cambiar a WebM');stopRec();return;}
    const mime=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/webm';
    S.recMR=new MediaRecorder(stream,{mimeType:mime,audioBitsPerSecond:S.quality*1000});
    S.recMethod='capture';S.recMime=mime;S.recFormat='webm';
    S.recMR.ondataavailable=e=>{if(e.data&&e.data.size>0)S.recChunks.push(e.data);};
    S.recMR.start(1000);updRecFmt();toast('ğŸ”„ Grabando en WebM');vib(30);
  }catch{toast('âš ï¸ Error al cambiar formato');stopRec();}
}

function readStream(){
  (async()=>{
    try{while(S.recActive&&S.recReader){const{done,value}=await S.recReader.read();if(done||!S.recActive)break;S.recChunks.push(value);}}
    catch(e){console.log('Stream cerrado:',e);}
    try{if(S.recReader)S.recReader.cancel();}catch{}
  })();
}

function stopRec(){
  S.recActive=false;clearInterval(S.recTimer);clearFallbackCheck();
  if(S.recAutoStop){clearTimeout(S.recAutoStop);S.recAutoStop=null;}
  if(S.recMethod==='fetch'){
    try{if(S.recReader)S.recReader.cancel();}catch{}
    if(S.recAbort)try{S.recAbort.abort();}catch{}
    downloadRec();
  }else if(S.recMethod==='capture'&&S.recMR){
    S.recMR.onstop=()=>downloadRec();
    try{S.recMR.stop();}catch{}
    S.recMR=null;
  }
  showRecUI(false);$('btnRc').classList.remove('rec-on');updHdr();
  if(S.recSchId){
    const idx=S.schedules.findIndex(s=>s.id===S.recSchId);
    if(idx>=0&&S.schedules[idx].type==='sched'){S.schedules.splice(idx,1);saveSch();renderSchList();}
  }
  S.recSchId=null;S.recTotalSec=0;
}

// â”€â”€â”€ DESCARGA CON METADATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Incrusta metadata bÃ¡sica en el archivo antes de descargarlo
// y lo agrega a la biblioteca de grabaciones.
function downloadRec(){
  if(!S.recChunks.length){toast('âš ï¸ Sin audio grabado');return;}
  const ext=S.recFormat||'webm';
  const mime=S.recMethod==='fetch'?(S.recMime||'audio/mpeg'):(S.recMime||'audio/webm');
  const blob=new Blob(S.recChunks,{type:mime});
  const nm=S.cur?S.cur.name.replace(/[^a-zA-Z0-9Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘ ]/gi,'').replace(/ +/g,'_'):'Grabacion';
  const filename=`${nm}_${tsNow()}.${ext}`;

  // Agregar a biblioteca con metadata
  const libEntry={
    id:'lib_'+Date.now(),
    name:filename,
    station:S.cur?S.cur.name:'Desconocida',
    country:S.cur?S.cur.country:'',
    countrycode:S.cur?S.cur.countrycode:'',
    favicon:S.cur?S.cur.favicon:'',
    format:ext.toUpperCase(),
    size:blob.size,
    duration:Math.floor((Date.now()-S.recStart)/1000),
    date:new Date().toISOString(),
    tags:S.cur?S.cur.tags:'',
    bitrate:S.quality,
    // Guardar blob como URL de objeto temporal para reproducciÃ³n en sesiÃ³n
    blobUrl:URL.createObjectURL(blob)
  };
  S.library.unshift(libEntry);
  saveLibrary();
  if(S.tab==='library')renderLibrary();

  // Descargar archivo
  const a=document.createElement('a');
  a.href=libEntry.blobUrl;
  a.download=filename;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  toast(`ğŸ’¾ ${fmtSize(blob.size)} Â· ${ext.toUpperCase()} Â· Guardado en Grabaciones`);
  S.recChunks=[];S.recMethod=null;
}

function showRecUI(on){
  $('recBar').classList.toggle('on',on);$('btnRc').classList.toggle('rec-on',on);
  if(on){S.recTimer=setInterval(updRecTm,500);updRecTm();updRecFmt();}
  else clearInterval(S.recTimer);
  updHdr();
}

function updRecTm(){
  const elapsed=Math.floor((Date.now()-S.recStart)/1000);
  const em=Math.floor(elapsed/60),es=elapsed%60;
  let txt=`${String(em).padStart(2,'0')}:${String(es).padStart(2,'0')}`;
  if(S.recTotalSec>0){const rem=Math.max(0,S.recTotalSec-elapsed);txt+=` / ${String(Math.floor(rem/60)).padStart(2,'0')}:${String(rem%60).padStart(2,'0')}`;}
  $('recTm').textContent=txt;
  const kb=calcRecBytes()/1024;
  $('recSz').textContent=kb>1024?`${(kb/1024).toFixed(1)} MB`:`${Math.round(kb)} KB`;
}
function updRecFmt(){$('recFmt').textContent=S.recFormat.toUpperCase();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BIBLIOTECA DE GRABACIONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveLibrary(){
  // Guardar sin blobUrl (no se puede serializar)
  const toSave=S.library.map(({blobUrl,...rest})=>rest);
  localStorage.setItem('wtfm_library',JSON.stringify(toSave));
}

function renderLibrary(){
  const c=$('sBox');
  showLinf(false);
  $('scats').classList.remove('on');

  if(!S.library.length){
    c.innerHTML=`<div class="lib-empty"><i>ğŸ™ï¸</i><p>No tienes grabaciones aÃºn.<br>Graba una emisora y aparecerÃ¡ aquÃ­.</p><br><button class="btn-rt" onclick="$('libFileIn').click()">ğŸ“ Importar audio</button></div>`;
    return;
  }

  // Mini reproductor
  let html=`<div class="lib-player" id="libPlayer">
    <div class="lib-player-top">
      <div class="lib-player-art" id="libPArt">ğŸ™ï¸</div>
      <div class="lib-player-info">
        <div class="lib-player-name" id="libPName">â€”</div>
        <div class="lib-player-meta" id="libPMeta">â€”</div>
      </div>
    </div>
    <div class="lib-player-ctrl">
      <button class="lib-player-btn" id="libPBtn" onclick="toggleLibPlay()">â–¶</button>
      <div class="lib-progress">
        <input type="range" class="lib-prog-bar" id="libProgBar" min="0" max="100" value="0" oninput="seekLib(this.value)">
        <span class="lib-time" id="libTime">00:00 / 00:00</span>
      </div>
    </div>
  </div>`;

  html+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 4px 8px;font-size:13px;color:var(--tx3)">
    <span>ğŸ™ï¸ Grabaciones</span>
    <span><strong style="color:var(--tx)">${S.library.length}</strong> archivos Â· <button style="font-size:12px;padding:4px 10px;border-radius:8px;border:1px solid var(--bd);background:var(--gl);color:var(--tx3);cursor:pointer;font-family:inherit" onclick="$('libFileIn').click()">ï¼‹ Importar</button></span>
  </div>`;

  html+='<div class="stns">';
  S.library.forEach((item,i)=>{
    const isPlaying=S.libCurId===item.id&&S.libPlaying;
    const date=new Date(item.date);
    const dateStr=`${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
    const durStr=fmtTime(item.duration||0);
    html+=`<div class="lib-item${isPlaying?' playing':''}" id="libitem_${item.id}">
      <div class="lib-art">${item.favicon?`<img src="${item.favicon}" onerror="this.parentElement.innerHTML='ğŸ™ï¸'">`:'ğŸ™ï¸'}</div>
      <div class="lib-info">
        <div class="lib-name">${esc(item.station)}</div>
        <div class="lib-meta">${mkFlag(item.countrycode)} ${dateStr} Â· ${durStr} Â· ${item.format} Â· ${fmtSize(item.size)}</div>
      </div>
      <div class="lib-actions">
        <button class="lib-btn play-btn${isPlaying?' on':''}" onclick="playLibItem('${item.id}');vib(40)" title="Reproducir">${isPlaying?'â¸':'â–¶'}</button>
        <button class="lib-btn" onclick="downloadLibItem('${item.id}');vib(30)" title="Descargar">ğŸ’¾</button>
        <button class="lib-btn del" onclick="deleteLibItem('${item.id}');vib(45)" title="Eliminar">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  });
  html+='</div>';
  c.innerHTML=html;

  // Restaurar estado del reproductor si estaba activo
  if(S.libCurId){
    const cur=S.library.find(x=>x.id===S.libCurId);
    if(cur)updLibPlayerUI(cur);
  }
}

function playLibItem(id){
  const item=S.library.find(x=>x.id===id);
  if(!item)return;

  // Si no tiene blobUrl (sesiÃ³n nueva) no se puede reproducir sin re-importar
  if(!item.blobUrl){
    toast('âš ï¸ Importa el archivo para reproducirlo en esta sesiÃ³n');
    return;
  }

  if(S.libCurId===id&&S.libPlaying){
    // Pausar
    libAudio.pause();
    S.libPlaying=false;
    $('libPBtn').textContent='â–¶';
    const btn=document.querySelector(`#libitem_${id} .play-btn`);
    if(btn){btn.textContent='â–¶';btn.classList.remove('on');}
    document.getElementById('libitem_'+id)?.classList.remove('playing');
    clearInterval(S.libProgTimer);
    return;
  }

  // Detener radio si estaba reproduciendo
  if(S.pb==='playing')stopAudio();

  // Detener item anterior
  if(S.libCurId&&S.libCurId!==id){
    const prev=document.querySelector(`#libitem_${S.libCurId} .play-btn`);
    if(prev){prev.textContent='â–¶';prev.classList.remove('on');}
    document.getElementById('libitem_'+S.libCurId)?.classList.remove('playing');
  }

  S.libCurId=id;S.libPlaying=true;
  libAudio.src=item.blobUrl;
  libAudio.volume=S.vol/100;
  libAudio.play().catch(()=>{toast('âš ï¸ Error al reproducir');S.libPlaying=false;});

  const btn=document.querySelector(`#libitem_${id} .play-btn`);
  if(btn){btn.textContent='â¸';btn.classList.add('on');}
  document.getElementById('libitem_'+id)?.classList.add('playing');

  // Mostrar reproductor
  updLibPlayerUI(item);
  $('libPlayer').classList.add('on');

  // Progreso
  clearInterval(S.libProgTimer);
  S.libProgTimer=setInterval(updLibProgress,500);
}

function updLibPlayerUI(item){
  $('libPName').textContent=item.station;
  $('libPMeta').textContent=`${item.format} Â· ${fmtSize(item.size)} Â· ${fmtTime(item.duration||0)}`;
  const art=$('libPArt');
  art.innerHTML=item.favicon?`<img src="${item.favicon}" onerror="this.parentElement.innerHTML='ğŸ™ï¸'">`:'ğŸ™ï¸';
  $('libPBtn').textContent=S.libPlaying?'â¸':'â–¶';
  $('libPBtn').classList.toggle('on',S.libPlaying);
}

function toggleLibPlay(){
  if(!S.libCurId)return;
  if(S.libPlaying){libAudio.pause();S.libPlaying=false;}
  else{libAudio.play();S.libPlaying=true;}
  $('libPBtn').textContent=S.libPlaying?'â¸':'â–¶';
  $('libPBtn').classList.toggle('on',S.libPlaying);
  const btn=document.querySelector(`#libitem_${S.libCurId} .play-btn`);
  if(btn){btn.textContent=S.libPlaying?'â¸':'â–¶';btn.classList.toggle('on',S.libPlaying);}
}

function updLibProgress(){
  if(!libAudio.duration)return;
  const pct=(libAudio.currentTime/libAudio.duration)*100;
  const bar=$('libProgBar');
  if(bar)bar.value=pct;
  const t=$('libTime');
  if(t)t.textContent=`${fmtTime(libAudio.currentTime)} / ${fmtTime(libAudio.duration)}`;
}

function seekLib(val){
  if(!libAudio.duration)return;
  libAudio.currentTime=(val/100)*libAudio.duration;
}

function stopLibAudio(){
  libAudio.pause();libAudio.src='';
  S.libPlaying=false;S.libCurId=null;
  clearInterval(S.libProgTimer);
}

libAudio.addEventListener('ended',()=>{
  S.libPlaying=false;
  if(S.libCurId){
    const btn=document.querySelector(`#libitem_${S.libCurId} .play-btn`);
    if(btn){btn.textContent='â–¶';btn.classList.remove('on');}
    document.getElementById('libitem_'+S.libCurId)?.classList.remove('playing');
  }
  $('libPBtn').textContent='â–¶';
  $('libPBtn').classList.remove('on');
  clearInterval(S.libProgTimer);
});

function downloadLibItem(id){
  const item=S.library.find(x=>x.id===id);
  if(!item)return;
  if(!item.blobUrl){toast('âš ï¸ Archivo no disponible en esta sesiÃ³n');return;}
  const a=document.createElement('a');
  a.href=item.blobUrl;a.download=item.name;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  toast('ğŸ’¾ Descargando '+item.name);
}

function deleteLibItem(id){
  if(S.libCurId===id)stopLibAudio();
  const item=S.library.find(x=>x.id===id);
  if(item&&item.blobUrl)URL.revokeObjectURL(item.blobUrl);
  S.library=S.library.filter(x=>x.id!==id);
  saveLibrary();renderLibrary();
  toast('ğŸ—‘ï¸ GrabaciÃ³n eliminada');vib(45);
}

function handleLibImp(e){
  const files=Array.from(e.target.files);
  if(!files.length)return;
  files.forEach(file=>{
    const ext=file.name.split('.').pop().toUpperCase();
    const blobUrl=URL.createObjectURL(file);
    const entry={
      id:'lib_'+Date.now()+'_'+Math.random().toString(36).slice(2),
      name:file.name,
      station:file.name.replace(/\.[^/.]+$/,''),
      country:'',countrycode:'',favicon:'',
      format:ext,size:file.size,duration:0,
      date:new Date(file.lastModified).toISOString(),
      tags:'',bitrate:0,blobUrl
    };
    S.library.unshift(entry);
  });
  saveLibrary();
  if(S.tab==='library')renderLibrary();
  toast(`ğŸ“ ${files.length} archivo(s) importado(s)`);
  e.target.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALIDAD Y FORMATO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setQuality(q){S.quality=q;localStorage.setItem('wtfm_q',q);updQualUI();vib(30);toast(`ğŸšï¸ Calidad: ${q}kbps`);}
function setFormat(f){S.prefFormat=f;localStorage.setItem('wtfm_fmt',f);updFmtUI();vib(30);toast(`ğŸ“€ Formato: ${f.toUpperCase()}`);}
function updQualUI(){[128,192,320].forEach(q=>{const b=$('sq'+q);if(b)b.classList.toggle('on',S.quality===q);});}
function updFmtUI(){$('sfMp3').classList.toggle('on',S.prefFormat==='mp3');$('sfWebm').classList.toggle('on',S.prefFormat==='webm');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI REPRODUCTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPly(show){
  $('plyE').style.display=show?'none':'block';$('plyC').style.display=show?'block':'none';
  if(show&&!S.gaugeReady){requestAnimationFrame(()=>requestAnimationFrame(()=>{resizeGauge();S.gaugeReady=true;}));}
}

function updPlyInfo(){
  const s=S.cur;if(!s)return;
  $('plyNm').textContent=s.name;
  const p=[];
  if(s.country)p.push(mkFlag(s.countrycode)+' '+s.country);
  if(s.tags){const t=s.tags.split(',').slice(0,2).map(x=>x.trim()).filter(Boolean);if(t.length)p.push(t.join(', '));}
  if(s.bitrate)p.push(s.bitrate+'kbps');
  if(s.codec)p.push(s.codec);
  $('plyMt').textContent=p.join(' Â· ')||'Radio';
  const art=$('plyArt');
  art.innerHTML=(s.favicon&&s.favicon.trim())?`<img src="${s.favicon}" onerror="this.parentElement.innerHTML='ğŸ“»'">`:'ğŸ“»';
  const br=s.bitrate||0;
  $('gBdg').textContent=br>=96?'STEREO':'MONO';$('gBdg').className='gauge-bdg '+(br>=96?'st':'mn');
  $('gKb').textContent=(s.codec&&br)?`${s.codec} ${br}kbps`:'';
  updFavBtn();
}

function updPlySt(){
  const e=$('plySt'),t=$('plyStT');
  e.className='ply-st '+(S.pb==='loading'?'ld':S.pb==='playing'?'pl':S.pb==='error'?'er':'sp');
  t.textContent=S.pb==='loading'?'Conectando...':S.pb==='playing'?'â–¶ En vivo':S.pb==='error'?'Error de conexiÃ³n':'Detenido';
}
function updPlayBtn(){const b=$('btnPl'),a=S.pb==='playing'||S.pb==='loading';b.classList.toggle('on',S.pb==='playing');b.textContent=a?'â¸':'â–¶';}
function updHdr(){
  const d=$('hDot'),t=$('hSt');d.className='hdr-dot';
  if(S.pb==='playing'){d.className=S.recActive?'hdr-dot rec':'hdr-dot on';t.textContent='En vivo';}
  else if(S.pb==='loading'){d.className='hdr-dot wrn';t.textContent='Conectando...';}
  else t.textContent=S.pb==='error'?'Error':'Offline';
}
function updVolUI(){
  $('volR').value=S.vol;$('volV').textContent=S.muted?'ğŸ”‡':S.vol;
  $('volI').textContent=S.muted?'ğŸ”‡':S.vol>50?'ğŸ”Š':S.vol>0?'ğŸ”‰':'ğŸ”ˆ';
}
function updFavBtn(){
  if(!S.cur)return;
  const is=S.favs.some(f=>sameStn(f,S.cur));
  $('btnFv').textContent=is?'â˜…':'â˜†';$('btnFv').classList.toggle('fav-on',is);
}
function sameStn(a,b){return(a.url_resolved&&a.url_resolved===b.url_resolved)||(a.stationuuid&&a.stationuuid===b.stationuuid);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GALVANÃ“METRO VU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const gCv=$('gaugeCv');
const gCtx=gCv.getContext('2d');

function resizeGauge(){
  const r=$('gaugeW').getBoundingClientRect();
  if(r.width>0){gCv.width=Math.floor(r.width*2);gCv.height=240;}
}
new ResizeObserver(()=>{if($('plyC').style.display!=='none')resizeGauge();}).observe($('gaugeW'));

function calcLvl(now,ch,vol){
  if(S.pb!=='playing'||S.muted)return S.pb==='loading'?.05+Math.sin(now/300)*.03:.01;
  const v=Math.max(.15,vol),bl=500,bp=(now%bl)/bl;
  const kick=Math.exp(-bp*7)*.32,snp=((now+bl)%(bl*2))/(bl*2),snare=Math.exp(-snp*9)*.22;
  const hhp=(now%(bl/2))/(bl/2),hh=Math.exp(-hhp*14)*.08;
  const bass=(Math.sin(now/900+ch*.7)*.5+.5)*.18,mid=Math.abs(Math.sin(now/210+ch*2.3))*.12;
  const hi=Math.abs(Math.sin(now/55+ch*4.1))*.04,swell=(Math.sin(now/5000)*.5+.5)*.08;
  const trans=Math.random()<.012?Math.random()*.22:0,st=Math.sin(now/1600+ch*Math.PI)*.04;
  return Math.max(0,Math.min(1,(kick+snare+hh+bass+mid+hi+swell+trans+st)*v));
}

function startGauge(){
  function frame(now){
    const W=gCv.width,H=gCv.height;
    if(W<10){S.af=requestAnimationFrame(frame);return;}
    gCtx.clearRect(0,0,W,H);
    const vol=S.vol/100,tL=calcLvl(now,0,vol),tR=calcLvl(now,1,vol);
    S.vL+=(tL-S.nL)*.08;S.vL*=.72;S.nL+=S.vL;S.nL=Math.max(-.02,Math.min(1.06,S.nL));
    S.vR+=(tR-S.nR)*.08;S.vR*=.72;S.nR+=S.vR;S.nR=Math.max(-.02,Math.min(1.06,S.nR));
    const gw=W/2;
    drawG(gCtx,gw*.5,H*.88,Math.min(gw*.42,H*.72),S.nL,'L');
    drawG(gCtx,gw*1.5,H*.88,Math.min(gw*.42,H*.72),S.nR,'R');
    S.af=requestAnimationFrame(frame);
  }
  S.af=requestAnimationFrame(frame);
}

function drawG(ctx,cx,cy,r,val,label){
  const dk=document.documentElement.dataset.theme!=='light';
  const minA=-55*DEG,maxA=55*DEG,sweep=maxA-minA;
  const nA=minA+Math.max(0,Math.min(1.05,val))*sweep;
  ctx.save();
  ctx.fillStyle=dk?'rgba(12,20,38,.7)':'rgba(232,236,242,.8)';
  ctx.beginPath();rr(ctx,cx-r*1.12,cy-r*1.18,r*2.24,r*1.25,r*.12);ctx.fill();
  ctx.strokeStyle=dk?'rgba(0,229,255,.06)':'rgba(0,0,0,.08)';ctx.lineWidth=1;
  ctx.beginPath();rr(ctx,cx-r*1.12,cy-r*1.18,r*2.24,r*1.25,r*.12);ctx.stroke();
  const ar=r*.92;
  [{s:0,e:.5,c:dk?'#00e676':'#16a34a'},{s:.5,e:.78,c:dk?'#ffd600':'#ca8a04'},{s:.78,e:1,c:dk?'#ff1744':'#dc2626'}].forEach(z=>{
    ctx.beginPath();ctx.arc(cx,cy,ar,-Math.PI/2+minA+z.s*sweep,-Math.PI/2+minA+z.e*sweep);
    ctx.strokeStyle=z.c;ctx.lineWidth=r*.06;ctx.globalAlpha=.35;ctx.stroke();ctx.globalAlpha=1;
  });
  ctx.textAlign='center';ctx.textBaseline='middle';
  [{p:0,l:'-20'},{p:.18,l:'-12'},{p:.36,l:'-6'},{p:.55,l:'-3'},{p:.78,l:'0'},{p:1,l:'+3'}].forEach(m=>{
    const a=-Math.PI/2+minA+m.p*sweep,ox=Math.cos(a),oy=Math.sin(a);
    ctx.beginPath();ctx.moveTo(cx+ox*(r*.82),cy+oy*(r*.82));ctx.lineTo(cx+ox*(r*.96),cy+oy*(r*.96));
    ctx.strokeStyle=dk?'rgba(255,255,255,.4)':'rgba(0,0,0,.35)';ctx.lineWidth=m.p>=.78?2:1.5;ctx.stroke();
    ctx.font=`600 ${r*.1}px Orbitron,monospace`;
    ctx.fillStyle=m.p>=.78?(dk?'rgba(255,60,80,.7)':'rgba(180,30,30,.7)'):(dk?'rgba(255,255,255,.45)':'rgba(0,0,0,.45)');
    ctx.fillText(m.l,cx+ox*(r*.7),cy+oy*(r*.7));
  });
  for(let i=0;i<=20;i++){
    const p=i/20,a=-Math.PI/2+minA+p*sweep,ox=Math.cos(a),oy=Math.sin(a);
    ctx.beginPath();ctx.moveTo(cx+ox*(r*.88),cy+oy*(r*.88));ctx.lineTo(cx+ox*(r*.93),cy+oy*(r*.93));
    ctx.strokeStyle=dk?'rgba(255,255,255,.15)':'rgba(0,0,0,.12)';ctx.lineWidth=1;ctx.stroke();
  }
  ctx.font=`700 ${r*.13}px Orbitron,monospace`;ctx.fillStyle=dk?'rgba(255,255,255,.12)':'rgba(0,0,0,.1)';
  ctx.fillText('VU',cx,cy-r*.35);
  const sA=-Math.PI/2+nA;
  ctx.beginPath();ctx.moveTo(cx+2,cy+2);ctx.lineTo(cx+Math.cos(sA)*(r*.86)+2,cy+Math.sin(sA)*(r*.86)+2);
  ctx.strokeStyle='rgba(0,0,0,.25)';ctx.lineWidth=2.5;ctx.stroke();
  const na=-Math.PI/2+nA,nx=Math.cos(na),ny=Math.sin(na),perpX=-ny,perpY=nx;
  const tipX=cx+nx*(r*.86),tipY=cy+ny*(r*.86),bw=r*.02;
  ctx.beginPath();ctx.moveTo(cx+perpX*bw,cy+perpY*bw);ctx.lineTo(tipX,tipY);ctx.lineTo(cx-perpX*bw,cy-perpY*bw);
  ctx.fillStyle=dk?'#00e5ff':'#0270ad';ctx.fill();
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(tipX,tipY);
  ctx.strokeStyle=dk?'rgba(0,229,255,.3)':'rgba(2,112,173,.2)';ctx.lineWidth=4;ctx.stroke();
  const pg=ctx.createRadialGradient(cx-r*.02,cy-r*.02,0,cx,cy,r*.08);
  pg.addColorStop(0,dk?'#5a6a7e':'#aabbcc');pg.addColorStop(1,dk?'#1a2535':'#556677');
  ctx.beginPath();ctx.arc(cx,cy,r*.07,0,Math.PI*2);ctx.fillStyle=pg;ctx.fill();
  ctx.beginPath();ctx.arc(cx,cy,r*.07,0,Math.PI*2);
  ctx.strokeStyle=dk?'rgba(255,255,255,.15)':'rgba(0,0,0,.15)';ctx.lineWidth=1;ctx.stroke();
  ctx.font=`700 ${r*.12}px Orbitron,monospace`;ctx.fillStyle=dk?'rgba(0,229,255,.5)':'rgba(2,112,173,.5)';
  ctx.fillText(label,cx,cy-r*.12);
  ctx.restore();
}

function rr(ctx,x,y,w,h,r){
  ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERIZADO DE LISTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBox(){
  const c=$('sBox');
  if(S.tab==='library'){renderLibrary();return;}
  if(S.loading){c.innerHTML='<div class="ldg"><div class="ldg-s"></div><p>Buscando emisoras...</p></div>';return;}
  if(S.err){c.innerHTML=`<div class="emt"><i>âš ï¸</i><p>${S.err}</p><button class="btn-rt" onclick="retryLoad()">Reintentar</button></div>`;return;}
  if(!S.list.length){
    if(S.tab==='favs')c.innerHTML='<div class="emt"><i>â­</i><p>No tienes favoritos.</p></div>';
    else if(S.tab==='custom')c.innerHTML=`<div class="emt"><i>ğŸ“Œ</i><p>Sin emisoras personalizadas.</p><br><button class="btn-rt" onclick="openMdl('addMdl')">ï¼‹ Agregar</button></div>`;
    else c.innerHTML='<div class="emt"><i>ğŸ“¡</i><p>No se encontraron emisoras.</p></div>';
    return;
  }
  renderStnList();
}

function renderStnList(){
  let h='';
  S.list.forEach((s,i)=>{
    const on=S.cur&&sameStn(S.cur,s),fv=S.favs.some(f=>sameStn(f,s));
    const tg=s.tags?s.tags.split(',').slice(0,2).map(x=>x.trim()).filter(Boolean):[];
    h+=`<div class="stn${on?' on':''}" onclick="playStn(S.list[${i}])">
      <div class="stn-a">${s.favicon&&s.favicon.trim()?`<img src="${s.favicon}" onerror="this.parentElement.innerHTML='ğŸ“»'" loading="lazy">`:'ğŸ“»'}</div>
      <div class="stn-i">
        <div class="stn-n">${esc(s.name)}</div>
        <div class="stn-d">${mkFlag(s.countrycode)} ${esc(s.country||'')}${s.bitrate?' Â· '+s.bitrate+'kbps':''}</div>
        <div class="stn-bg">${s.codec?`<span class="stn-b cd">${s.codec}</span>`:''}${tg.map(t=>`<span class="stn-b">${esc(t)}</span>`).join('')}</div>
      </div>
      <div class="stn-r">
        <button class="stn-f${fv?' on':''}" onclick="event.stopPropagation();togFav(${i});vib(30)">${fv?'â˜…':'â˜†'}</button>
        ${on&&S.pb==='playing'?'<span class="stn-pi">ğŸ”Š</span>':''}
      </div>
    </div>`;
  });
  $('sBox').innerHTML=`<div class="stns">${h}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS Y NAVEGACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function swTab(tab){
  S.tab=tab;S.sub=null;S.sq='';
  $('srchIn').value='';$('srchX').classList.remove('on');
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('on',t.dataset.t===tab));
  const sc=$('scats');
  if(tab==='country'){
    sc.classList.add('on');
    sc.innerHTML=COUNTRIES.map(c=>`<button class="scat" data-v="${c.c}" onclick="selSub('country','${c.c}');vib(30)">${c.f} ${c.n}</button>`).join('');
    $('sBox').innerHTML='<div class="emt"><i>ğŸŒ</i><p>Selecciona un paÃ­s</p></div>';showLinf(false);
  }else if(tab==='genre'){
    sc.classList.add('on');
    sc.innerHTML=GENRES.map(g=>`<button class="scat" data-v="${g.id}" onclick="selSub('genre','${g.id}');vib(30)">${g.i} ${g.n}</button>`).join('');
    $('sBox').innerHTML='<div class="emt"><i>ğŸµ</i><p>Selecciona un gÃ©nero</p></div>';showLinf(false);
  }else if(tab==='library'){
    sc.classList.remove('on');showLinf(false);renderLibrary();
  }else{
    sc.classList.remove('on');
    if(tab==='top')loadList(apiTop,'ğŸ”¥ Populares');
    else if(tab==='favs')loadFavs();
    else if(tab==='custom')loadCustom();
  }
}

function selSub(type,val){
  S.sub=val;
  document.querySelectorAll('.scat').forEach(s=>s.classList.toggle('on',s.dataset.v===val));
  if(type==='country'){const c=COUNTRIES.find(x=>x.c===val);loadList(()=>apiCountry(val),c?c.f+' '+c.n:val);}
  else{const g=GENRES.find(x=>x.id===val);loadList(()=>apiTag(val),g?g.i+' '+g.n:val);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BÃšSQUEDA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let srchTm;
$('srchIn').addEventListener('input',e=>{
  const q=e.target.value.trim();
  $('srchX').classList.toggle('on',q.length>0);clearTimeout(srchTm);
  if(q.length>=2){srchTm=setTimeout(()=>{S.sq=q;document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));$('scats').classList.remove('on');loadList(()=>apiSearch(q),'ğŸ” "'+q+'"');},400);}
  else if(!q.length)swTab(S.tab);
});
function clrSearch(){$('srchIn').value='';$('srchX').classList.remove('on');S.sq='';swTab(S.tab);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FAVORITOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togFav(i){
  const s=S.list[i];if(!s)return;
  const idx=S.favs.findIndex(f=>sameStn(f,s));
  if(idx>=0){S.favs.splice(idx,1);toast('âœ• Eliminada de favoritos');}
  else{S.favs.push(pickStn(s));toast('â­ Agregada a favoritos');}
  saveFavs();renderStnList();updFavBtn();if(S.tab==='favs')loadFavs();
}
function toggleFavCur(){
  if(!S.cur)return;
  const idx=S.favs.findIndex(f=>sameStn(f,S.cur));
  if(idx>=0){S.favs.splice(idx,1);toast('âœ• Eliminada de favoritos');}
  else{S.favs.push(pickStn(S.cur));toast('â­ Agregada a favoritos');}
  saveFavs();updFavBtn();renderStnList();if(S.tab==='favs')loadFavs();
}
function pickStn(s){return{stationuuid:s.stationuuid||'',name:s.name,url:s.url||'',url_resolved:s.url_resolved||s.url||'',favicon:s.favicon||'',country:s.country||'',countrycode:s.countrycode||'',tags:s.tags||'',codec:s.codec||'',bitrate:s.bitrate||0,isCustom:s.isCustom||false};}
function loadFavs(){S.list=[...S.favs];S.loading=false;S.err=null;renderBox();showLinf(S.list.length>0,'â­ Favoritos',S.list.length);}
function saveFavs(){localStorage.setItem('wtfm_favs',JSON.stringify(S.favs));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMISORAS PERSONALIZADAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveCustom(){
  const nm=$('fNm').value.trim();let url=$('fUrl').value.trim();
  const pais=$('fPais').value.trim(),gen=$('fGen').value.trim();
  if(!nm||!url){toast('âš ï¸ Nombre y URL obligatorios');vib([60,50,60]);return;}
  if(!url.startsWith('http')){toast('âš ï¸ URL debe empezar con http');return;}
  if(isPlaylistUrl(url)){toast('ğŸ”„ Resolviendo playlist...');try{url=await resolvePlaylistUrl(url);}catch{}}
  S.custom.push({stationuuid:'c_'+Date.now(),name:nm,url,url_resolved:url,favicon:'',country:pais,countrycode:'',tags:gen,codec:'',bitrate:0,isCustom:true});
  localStorage.setItem('wtfm_custom',JSON.stringify(S.custom));
  closeMdl('addMdl');toast('ğŸ“Œ Emisora guardada');
  ['fNm','fUrl','fPais','fGen'].forEach(id=>$(id).value='');
  if(S.tab==='custom')loadCustom();
}
function loadCustom(){S.list=[...S.custom];S.loading=false;S.err=null;renderBox();showLinf(S.list.length>0,'ğŸ“Œ Mis Emisoras',S.list.length);}
function retryLoad(){if(S.sq)loadList(()=>apiSearch(S.sq),'ğŸ”');else if(S.tab==='top')loadList(apiTop,'ğŸ”¥');else if(S.sub)selSub(S.tab==='country'?'country':'genre',S.sub);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEMA Y COLORES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTheme(t){S.theme=t;localStorage.setItem('wtfm_theme',t);applyTheme();updThUI();}
function applyTheme(){
  let th=S.theme;if(th==='auto')th=matchMedia('(prefers-color-scheme:light)').matches?'light':'dark';
  document.documentElement.dataset.theme=th;
  $('metaTheme').content=th==='dark'?'#060910':'#d8dfe8';
  applyCustomColors();
}
function updThUI(){['Dk','Lt','At'].forEach((x,i)=>{const b=$('sg'+x);if(b)b.classList.toggle('on',S.theme===(['dark','light','auto'][i]));});}
matchMedia('(prefers-color-scheme:light)').addEventListener('change',()=>{if(S.theme==='auto')applyTheme();});
function swThmTab(t){
  document.querySelectorAll('.thm-tab').forEach(b=>b.classList.toggle('on',b.dataset.th===t));
  $('tpDark').classList.toggle('on',t==='dark');$('tpLight').classList.toggle('on',t==='light');
}
function loadThmEditorUI(){
  ['dark','light'].forEach(th=>{
    const c=S.customColors[th],pre=th==='dark'?'Dk':'Lt';
    ['bg','card','tx','tx2','pri','acc'].forEach(k=>{
      const kn=k==='bg'?'Bg':k==='card'?'Card':k==='tx'?'Tx':k==='tx2'?'Tx2':k==='pri'?'Pri':'Acc';
      $('c'+pre+kn).value=c[k];$('p'+pre+kn).style.background=c[k];$('h'+pre+kn).textContent=c[k];
    });
  });
}
function updThmClr(theme,key,value){
  S.customColors[theme][key]=value;
  const pre=theme==='dark'?'Dk':'Lt',km={bg:'Bg',card:'Card',tx:'Tx',tx2:'Tx2',pri:'Pri',acc:'Acc'};
  $('p'+pre+km[key]).style.background=value;$('h'+pre+km[key]).textContent=value;
  let th=S.theme;if(th==='auto')th=matchMedia('(prefers-color-scheme:light)').matches?'light':'dark';
  if(theme===th)applyCustomColors();
}
function applyCustomColors(){
  let th=S.theme;if(th==='auto')th=matchMedia('(prefers-color-scheme:light)').matches?'light':'dark';
  const c=S.customColors[th],r=document.documentElement;
  r.style.setProperty('--bg',c.bg);r.style.setProperty('--card',c.card);
  r.style.setProperty('--tx',c.tx);r.style.setProperty('--tx2',c.tx2);
  r.style.setProperty('--pri',c.pri);r.style.setProperty('--acc',c.acc);
  r.style.setProperty('--prib',c.pri+'18');r.style.setProperty('--pribd',c.pri+'4D');
  r.style.setProperty('--prid',adjustColor(c.pri,-20));
  r.style.setProperty('--accb',c.acc+'18');r.style.setProperty('--accbd',c.acc+'4D');
}
function adjustColor(hex,amt){
  let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  r=Math.max(0,Math.min(255,r+amt));g=Math.max(0,Math.min(255,g+amt));b=Math.max(0,Math.min(255,b+amt));
  return'#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
}
function saveThmColors(){localStorage.setItem('wtfm_colors',JSON.stringify(S.customColors));applyCustomColors();toast('ğŸ¨ Tema guardado');closeMdl('thmMdl');}
function resetTheme(){const a=document.querySelector('.thm-tab.on').dataset.th;S.customColors[a]={...DEFAULT_COLORS[a]};loadThmEditorUI();applyCustomColors();toast('ğŸ”„ Colores restablecidos');vib(30);}
function expTheme(){
  const d={version:'5.0.0',type:'theme',date:new Date().toISOString(),colors:S.customColors};
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json'}));
  a.download=`WaveTuner_Tema_${tsNow()}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);toast('ğŸ“¤ Tema exportado');
}
function impTheme(){$('thmFileIn').click();}
function handleThmImp(e){
  const f=e.target.files[0];if(!f)return;
  const rd=new FileReader();
  rd.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.type!=='theme'||!d.colors)throw new Error();if(d.colors.dark)S.customColors.dark={...DEFAULT_COLORS.dark,...d.colors.dark};if(d.colors.light)S.customColors.light={...DEFAULT_COLORS.light,...d.colors.light};localStorage.setItem('wtfm_colors',JSON.stringify(S.customColors));loadThmEditorUI();applyCustomColors();toast('ğŸ“¥ Tema importado');}catch{toast('âš ï¸ Archivo de tema no vÃ¡lido');vib([60,50,60]);}};
  rd.readAsText(f);e.target.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACORDEÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togAcc(el){const o=el.classList.toggle('op');el.nextElementSibling.classList.toggle('op',o);el.parentElement.classList.toggle('open',o);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUEDAS DE TIEMPO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let whlTm,whlIv;
function whlD(id,dir){
  whlStep(id,dir);
  whlTm=setTimeout(()=>{whlIv=setInterval(()=>whlStep(id,dir),80);},350);
  const up=()=>{clearTimeout(whlTm);clearInterval(whlIv);window.removeEventListener('pointerup',up);window.removeEventListener('pointercancel',up);};
  window.addEventListener('pointerup',up);window.addEventListener('pointercancel',up);
}
function whlStep(id,dir){
  const w=S.wheels[id];if(!w)return;
  w.v+=dir;if(w.v>w.max)w.v=w.min;if(w.v<w.min)w.v=w.max;
  $(id+'v').textContent=String(w.v).padStart(2,'0');vib(25);updDurDisp();
}
function calcMin(sh,sm,eh,em){let s=sh*60+sm,e=eh*60+em;if(e<=s)e+=1440;return e-s;}
function fmtDur(m){const h=Math.floor(m/60),mm=m%60;return h>0?(mm>0?`${h}h ${mm}min`:`${h}h`):`${mm}min`;}
function updDurDisp(){
  $('schDur1').textContent=`â± DuraciÃ³n: ${fmtDur(calcMin(S.wheels.wH1.v,S.wheels.wM1.v,S.wheels.wH1e.v,S.wheels.wM1e.v))}`;
  $('schDur2').textContent=`â± DuraciÃ³n: ${fmtDur(calcMin(S.wheels.wH2.v,S.wheels.wM2.v,S.wheels.wH2e.v,S.wheels.wM2e.v))}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROGRAMACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function swSchTab(t){
  document.querySelectorAll('.sch-tab').forEach(b=>b.classList.toggle('on',b.dataset.s===t));
  ['Timed','Sched','Recur'].forEach(p=>{const el=$('sp'+p);if(el)el.classList.toggle('on',p.toLowerCase()===t);});
  updSchCurUI();
}
function togDay(el){el.classList.toggle('on');vib(30);}
function renderCurStnBox(containerId,type){
  const c=$(containerId);if(!c)return;
  if(S.cur&&S.schUseCurrent[type]){c.innerHTML=`<div class="sch-cur"><span class="sch-cur-ico">ğŸ“»</span><div class="sch-cur-info"><div class="sch-cur-nm">${esc(S.cur.name)}</div><div class="sch-cur-lbl">Emisora actual</div></div><span class="sch-cur-chg" onclick="toggleSchStn('${type}')">Cambiar</span></div>`;}
  else if(!S.cur){c.innerHTML=`<div class="sg-info" style="margin-bottom:12px">âš ï¸ No hay emisora reproduciÃ©ndose.</div>`;S.schUseCurrent[type]=false;}
  else{c.innerHTML=`<div class="sch-cur" style="opacity:.6"><span class="sch-cur-ico">ğŸ“»</span><div class="sch-cur-info"><div class="sch-cur-nm">${esc(S.cur.name)}</div><div class="sch-cur-lbl">Usar emisora actual</div></div><span class="sch-cur-chg" onclick="toggleSchStn('${type}')">Usar</span></div>`;}
}
function toggleSchStn(type){S.schUseCurrent[type]=!S.schUseCurrent[type];updSchCurUI();vib(30);}
function updSchCurUI(){
  renderCurStnBox('schTimedCur','timed');renderCurStnBox('schSchedCur','sched');renderCurStnBox('schRecurCur','recur');
  $('schSchedStnWrap').style.display=S.schUseCurrent.sched&&S.cur?'none':'block';
  $('schRecurStnWrap').style.display=S.schUseCurrent.recur&&S.cur?'none':'block';
}
function populateFavSel(){
  const opts=S.favs.length?S.favs.map((f,i)=>`<option value="${i}">${f.name}</option>`).join(''):'';
  $('schSchedStn').innerHTML=`<option value="">Seleccionar...</option>${opts||'<option value="">â€” Agrega favoritos primero â€”</option>'}`;
  $('schRecurStn').innerHTML=`<option value="">Seleccionar...</option>${opts||'<option value="">â€” Agrega favoritos primero â€”</option>'}`;
}
function startTimedRec(){
  const min=parseInt($('schTimedMin').value);
  if(!min||min<1){toast('âš ï¸ Ingresa duraciÃ³n vÃ¡lida');vib([60,50,60]);return;}
  if(S.pb!=='playing'){toast('âš ï¸ Primero reproduce una emisora');vib([60,50,60]);return;}
  closeMdl('schMdl');startRecording(min*60,null);toast(`â± Grabando ${min} minutos`);
}
function addSchedule(type){
  let stn,dur;
  if(type==='sched'){
    stn=S.schUseCurrent.sched&&S.cur?S.cur:S.favs[parseInt($('schSchedStn').value)];
    if(!stn){toast('âš ï¸ Selecciona una emisora');vib([60,50,60]);return;}
    const date=$('schSchedDate').value;if(!date){toast('âš ï¸ Selecciona fecha');vib([60,50,60]);return;}
    dur=calcMin(S.wheels.wH1.v,S.wheels.wM1.v,S.wheels.wH1e.v,S.wheels.wM1e.v);
    const sch={id:'s_'+Date.now(),type:'sched',station:pickStn(stn),active:true,lastTriggered:0,date,startH:S.wheels.wH1.v,startM:S.wheels.wM1.v,endH:S.wheels.wH1e.v,endM:S.wheels.wM1e.v,duration:dur};
    S.schedules.push(sch);saveSch();renderSchList();
    toast(`ğŸ“… ${date} ${String(sch.startH).padStart(2,'0')}:${String(sch.startM).padStart(2,'0')}`);
  }else{
    stn=S.schUseCurrent.recur&&S.cur?S.cur:S.favs[parseInt($('schRecurStn').value)];
    if(!stn){toast('âš ï¸ Selecciona una emisora');vib([60,50,60]);return;}
    const days=[];document.querySelectorAll('#daysRow .day-btn.on').forEach(b=>days.push(parseInt(b.dataset.d)));
    if(!days.length){toast('âš ï¸ Selecciona al menos un dÃ­a');vib([60,50,60]);return;}
    dur=calcMin(S.wheels.wH2.v,S.wheels.wM2.v,S.wheels.wH2e.v,S.wheels.wM2e.v);
    const sch={id:'s_'+Date.now(),type:'recur',station:pickStn(stn),active:true,lastTriggered:0,days,startH:S.wheels.wH2.v,startM:S.wheels.wM2.v,endH:S.wheels.wH2e.v,endM:S.wheels.wM2e.v,duration:dur};
    S.schedules.push(sch);saveSch();renderSchList();
    const dn=['Do','Lu','Ma','Mi','Ju','Vi','Sa'];
    toast(`ğŸ” ${days.map(d=>dn[d]).join(',')} ${String(sch.startH).padStart(2,'0')}:${String(sch.startM).padStart(2,'0')}`);
  }
}
function delSchedule(id){S.schedules=S.schedules.filter(s=>s.id!==id);saveSch();renderSchList();toast('ğŸ—‘ï¸ ProgramaciÃ³n eliminada');vib(45);}
function saveSch(){localStorage.setItem('wtfm_sch',JSON.stringify(S.schedules));}
function renderSchList(){
  const wrap=$('schListW'),list=$('schList');
  if(!S.schedules.length){wrap.style.display='none';return;}
  wrap.style.display='block';
  const dn=['Do','Lu','Ma','Mi','Ju','Vi','Sa'];
  list.innerHTML=S.schedules.map(s=>{
    const sh=String(s.startH).padStart(2,'0'),sm=String(s.startM).padStart(2,'0');
    const eh=String(s.endH).padStart(2,'0'),em=String(s.endM).padStart(2,'0');
    const desc=s.type==='sched'?`ğŸ“… ${s.date} Â· ${sh}:${sm}-${eh}:${em}`:`ğŸ” ${s.days.map(d=>dn[d]).join(', ')} Â· ${sh}:${sm}-${eh}:${em}`;
    return`<div class="sch-item"><div class="sch-item-info"><div class="sch-item-t">${esc(s.station.name)}</div><div class="sch-item-d">${desc} Â· ${fmtDur(s.duration)}</div></div><button class="sch-item-del" onclick="delSchedule('${s.id}');vib(45)">âœ•</button></div>`;
  }).join('');
}
function checkSchedules(){
  const now=new Date(),ms=now.getTime();
  S.schedules.forEach(sch=>{
    if(!sch.active||S.recActive)return;
    if(ms-sch.lastTriggered<120000)return;
    if(sch.type==='sched'){const d=new Date(sch.date+'T'+String(sch.startH).padStart(2,'0')+':'+String(sch.startM).padStart(2,'0'));if(Math.abs(ms-d.getTime())<60000)triggerSch(sch);}
    else if(sch.type==='recur'){const day=now.getDay();if(sch.days.includes(day)&&now.getHours()===sch.startH&&now.getMinutes()===sch.startM)triggerSch(sch);}
  });
}
function triggerSch(sch){
  sch.lastTriggered=Date.now();saveSch();playStn(sch.station);
  setTimeout(()=>{if(S.pb==='playing')startRecording(sch.duration*60,sch.id);},3000);
  toast(`ğŸ“… GrabaciÃ³n programada: ${sch.station.name}`);vib([50,100,50]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORTAR / IMPORTAR DATOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function expData(){
  const libToSave=S.library.map(({blobUrl,...rest})=>rest);
  const d={version:'5.0.0',date:new Date().toISOString(),favorites:S.favs,customStations:S.custom,schedules:S.schedules,theme:S.theme,quality:S.quality,prefFormat:S.prefFormat,lastStation:S.lastStation,customColors:S.customColors,library:libToSave};
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json'}));
  a.download=`Backup_WaveTunerFM_${tsNow()}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);toast('ğŸ“¤ Datos exportados');
}
function impData(){$('fileIn').click();}
function handleImp(e){
  const f=e.target.files[0];if(!f)return;
  const rd=new FileReader();
  rd.onload=ev=>{try{
    const d=JSON.parse(ev.target.result);let nf=0,nc=0;
    if(d.favorites){const nw=d.favorites.filter(x=>!S.favs.some(e=>sameStn(e,x)));S.favs.push(...nw);saveFavs();nf=nw.length;}
    if(d.customStations){const nw=d.customStations.filter(x=>!S.custom.some(e=>(e.url_resolved||e.url)===(x.url_resolved||x.url)));S.custom.push(...nw);localStorage.setItem('wtfm_custom',JSON.stringify(S.custom));nc=nw.length;}
    if(d.schedules){d.schedules.forEach(ns=>{if(!S.schedules.some(es=>es.id===ns.id))S.schedules.push(ns);});saveSch();renderSchList();}
    if(d.customColors){S.customColors=d.customColors;localStorage.setItem('wtfm_colors',JSON.stringify(S.customColors));applyCustomColors();}
    if(d.lastStation){S.lastStation=d.lastStation;localStorage.setItem('wtfm_last',JSON.stringify(S.lastStation));}
    if(d.library){d.library.forEach(item=>{if(!S.library.some(x=>x.id===item.id))S.library.push(item);});saveLibrary();}
    if(d.theme)setTheme(d.theme);if(d.quality)setQuality(d.quality);if(d.prefFormat)setFormat(d.prefFormat);
    toast(`ğŸ“¥ +${nf} favs, +${nc} emisoras`);
    if(S.tab==='favs')loadFavs();if(S.tab==='custom')loadCustom();if(S.tab==='library')renderLibrary();
  }catch{toast('âš ï¸ Archivo no vÃ¡lido');vib([60,50,60]);}};
  rd.readAsText(f);e.target.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openMdl(id){
  $(id).classList.add('on');updThUI();updQualUI();updFmtUI();renderSchList();populateFavSel();
  $('schSchedDate').value=new Date().toISOString().slice(0,10);updDurDisp();updSchCurUI();
  if(id==='thmMdl')loadThmEditorUI();
}
function closeMdl(id){$(id).classList.remove('on');}
function maybeClose(e,id){if(e.target.id===id)closeMdl(id);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA v5.0.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupPWA(){
  if('serviceWorker'in navigator&&location.protocol==='https:'){
    navigator.serviceWorker.register('./sw.js')
      .then(reg=>console.log('ğŸ“» SW registrado:',reg.scope))
      .catch(err=>console.log('SW error:',err));
  }
  window.addEventListener('beforeinstallprompt',e=>{
    e.preventDefault();S.deferredPrompt=e;
    $('pwaI').textContent='Â¡Disponible para instalar!';$('btnInst').classList.add('on');
  });
}

function installPWA(){
  if(S.deferredPrompt){S.deferredPrompt.prompt();S.deferredPrompt.userChoice.then(r=>{toast(r.outcome==='accepted'?'ğŸ“² App instalada':'InstalaciÃ³n cancelada');S.deferredPrompt=null;});}
  else toast('â„¹ï¸ Requiere servidor HTTPS (GitHub Pages)');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEDIA SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updMedia(){
  if(!('mediaSession'in navigator)||!S.cur)return;
  navigator.mediaSession.metadata=new MediaMetadata({title:S.cur.name,artist:S.cur.country||'Radio',album:'WaveTuner FM',artwork:S.cur.favicon?[{src:S.cur.favicon,sizes:'512x512',type:'image/png'}]:[]});
  navigator.mediaSession.setActionHandler('play',togglePlay);
  navigator.mediaSession.setActionHandler('pause',togglePlay);
  navigator.mediaSession.setActionHandler('stop',stopAudio);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SMART TV â€” NAVEGACIÃ“N D-PAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function detectTV(){
  // Detectar TV por tamaÃ±o de pantalla o user agent
  const isTV=window.innerWidth>=1280||/TV|SmartTV|Android.*TV|SMART-TV|HbbTV/i.test(navigator.userAgent);
  if(isTV&&!S.tvMode){
    S.tvMode=true;document.body.classList.add('tv-mode');
    console.log('ğŸ“º Modo Smart TV activado');
    initDpad();
  }
}

function initDpad(){
  document.addEventListener('keydown',handleDpad,true);
}

function getFocusables(){
  return Array.from(document.querySelectorAll(
    '.stn, .tab, .scat, .lib-item, .lib-player-btn, .lib-btn, .btn-p, .cbtn, .hbtn, .lib-prog-bar'
  )).filter(el=>{
    const r=el.getBoundingClientRect();
    return r.width>0&&r.height>0&&!el.closest('[style*="display:none"]');
  });
}

let tvFocusEl=null;

function setTvFocus(el){
  if(tvFocusEl)tvFocusEl.classList.remove('tv-focus');
  tvFocusEl=el;
  if(el){el.classList.add('tv-focus');el.scrollIntoView({block:'nearest',behavior:'smooth'});}
}

function handleDpad(e){
  if(!S.tvMode)return;
  const focusables=getFocusables();
  if(!focusables.length)return;

  // Si no hay foco, establecer en el primero
  if(!tvFocusEl||!document.contains(tvFocusEl)){
    setTvFocus(focusables[0]);return;
  }

  const cur=tvFocusEl;
  const curR=cur.getBoundingClientRect();
  const curCX=curR.left+curR.width/2;
  const curCY=curR.top+curR.height/2;

  let best=null,bestScore=Infinity;

  switch(e.key){
    case 'ArrowRight':
    case 'ArrowLeft':
    case 'ArrowUp':
    case 'ArrowDown':
      e.preventDefault();
      focusables.forEach(el=>{
        if(el===cur)return;
        const r=el.getBoundingClientRect();
        const cx=r.left+r.width/2,cy=r.top+r.height/2;
        const dx=cx-curCX,dy=cy-curCY;
        let valid=false;
        if(e.key==='ArrowRight'&&dx>10)valid=true;
        if(e.key==='ArrowLeft'&&dx<-10)valid=true;
        if(e.key==='ArrowDown'&&dy>10)valid=true;
        if(e.key==='ArrowUp'&&dy<-10)valid=true;
        if(!valid)return;
        const dist=Math.sqrt(dx*dx+dy*dy);
        const perpDist=e.key==='ArrowRight'||e.key==='ArrowLeft'?Math.abs(dy):Math.abs(dx);
        const score=dist+perpDist*2;
        if(score<bestScore){bestScore=score;best=el;}
      });
      if(best)setTvFocus(best);
      break;

    case 'Enter':
    case ' ':
      if(cur){
        e.preventDefault();
        cur.click();
        vib(40);
      }
      break;

    case 'Backspace':
    case 'Escape':
      e.preventDefault();
      // Cerrar modales abiertos
      document.querySelectorAll('.mbg.on').forEach(m=>m.classList.remove('on'));
      break;

    // Control de volumen con teclas de color del control remoto
    case 'ColorF0Red': // BotÃ³n rojo
      togglePlay();break;
    case 'ColorF1Green': // BotÃ³n verde
      toggleFavCur();break;
    case 'ColorF2Yellow': // BotÃ³n amarillo
      toggleRec();break;
    case 'MediaPlay':
    case 'MediaPause':
    case 'MediaPlayPause':
      e.preventDefault();togglePlay();break;
    case 'MediaStop':
      e.preventDefault();stopAudio();break;
    case 'VolumeUp':
      e.preventDefault();setVol(Math.min(100,S.vol+5));break;
    case 'VolumeDown':
      e.preventDefault();setVol(Math.max(0,S.vol-5));break;
    case 'VolumeMute':
      e.preventDefault();toggleMute();break;
  }
}

// TambiÃ©n manejar teclas estÃ¡ndar en modo no-TV
document.addEventListener('keydown',e=>{
  if(S.tvMode)return; // Ya manejado por handleDpad
  if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT')return;
  switch(e.key){
    case ' ':e.preventDefault();togglePlay();vib(50);break;
    case 'ArrowUp':e.preventDefault();setVol(Math.min(100,S.vol+5));break;
    case 'ArrowDown':e.preventDefault();setVol(Math.max(0,S.vol-5));break;
    case 'm':toggleMute();vib(30);break;
    case 'f':if(S.cur){toggleFavCur();vib([40,60,40]);}break;
    case 'r':toggleRec();break;
    case 'l':swTab('library');vib(30);break;
  }
});

// Activar modo TV al detectar primer click de D-pad
document.addEventListener('keydown',e=>{
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Enter'].includes(e.key)&&!S.tvMode){
    detectTV();
  }
},true);

$('volR').addEventListener('input',e=>setVol(parseInt(e.target.value)));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INICIALIZACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init(){
  applyTheme();updVolUI();updQualUI();updFmtUI();
  loadLastStation();swTab('top');startGauge();setupPWA();
  renderSchList();setInterval(checkSchedules,30000);
  $('schSchedDate').value=new Date().toISOString().slice(0,10);
  updDurDisp();
  // Detectar TV al cargar
  detectTV();
  // Re-detectar si cambia el tamaÃ±o de ventana
  window.addEventListener('resize',()=>detectTV());
  console.log('ğŸ“» WaveTuner FM v5.0.0 - 19 de Febrero de 2026');
  console.log('âœ¨ Nuevo: Biblioteca de grabaciones Â· Metadata Â· Smart TV Â· D-pad');
})();
</script>
</body>
</html>
