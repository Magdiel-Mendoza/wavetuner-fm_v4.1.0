<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" id="metaTheme" content="#060910">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="icon" type="image/png" id="favIco" href="">
<link rel="apple-touch-icon" id="applIco" href="">
<title>WaveTuner FM</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Inter:wght@300;400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root,[data-theme="dark"]{
--bg:#050810;--bg2:#0e1525;--bg3:#151e30;--bg4:#0b1120;
--card:#131b2d;--card2:#182340;--cardb:rgba(0,229,255,.06);
--tx:#e0e7ff;--tx2:#94a3b8;--tx3:#546380;
--bd:rgba(255,255,255,.07);--bd2:rgba(255,255,255,.14);
--pri:#00e5ff;--prid:#0091ea;--prib:rgba(0,229,255,.1);--pribd:rgba(0,229,255,.3);
--acc:#ff6d00;--accb:rgba(255,109,0,.1);--accbd:rgba(255,109,0,.3);
--ok:#00e676;--err:#ff1744;--wrn:#ffd600;
--sh:rgba(0,0,0,.5);--gl:rgba(255,255,255,.05);--gl2:rgba(255,255,255,.08);
--card-sh:0 8px 32px rgba(0,0,0,.5),0 0 1px rgba(0,229,255,.08);
--needle:#00e5ff;--needleg:rgba(0,229,255,.4);
--scale:rgba(255,255,255,.35);--scaletx:rgba(255,255,255,.45);
--pvt1:#3a4a5e;--pvt2:#1a2535;
}
[data-theme="light"]{
--bg:#d8dfe8;--bg2:#edf0f5;--bg3:#f5f7fa;--bg4:#e0e5ed;
--card:#ffffff;--card2:#f0f3f7;--cardb:rgba(2,132,199,.06);
--tx:#0f172a;--tx2:#475569;--tx3:#8494a7;
--bd:rgba(0,0,0,.08);--bd2:rgba(0,0,0,.14);
--pri:#0270ad;--prid:#025e90;--prib:rgba(2,132,199,.08);--pribd:rgba(2,132,199,.2);
--acc:#c65a08;--accb:rgba(198,90,8,.08);--accbd:rgba(198,90,8,.2);
--ok:#15803d;--err:#b91c1c;--wrn:#a16207;
--sh:rgba(0,0,0,.08);--gl:rgba(0,0,0,.03);--gl2:rgba(0,0,0,.05);
--card-sh:0 4px 16px rgba(0,0,0,.08),0 1px 3px rgba(0,0,0,.06);
--needle:#0270ad;--needleg:rgba(2,112,173,.3);
--scale:rgba(0,0,0,.3);--scaletx:rgba(0,0,0,.45);
--pvt1:#8899aa;--pvt2:#556677;
}
html{scroll-behavior:smooth}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;min-height:100dvh;overflow-x:hidden;transition:background .4s,color .4s}
.bgx{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.bgx i{position:absolute;border-radius:50%;filter:blur(100px);opacity:.06;font-style:normal}
[data-theme="light"] .bgx i{opacity:.03}
.bgx i:nth-child(1){width:400px;height:400px;background:var(--pri);top:-120px;right:-100px;animation:gf 22s ease-in-out infinite}
.bgx i:nth-child(2){width:350px;height:350px;background:var(--acc);bottom:-100px;left:-80px;animation:gf 28s ease-in-out infinite reverse}
@keyframes gf{0%,100%{transform:translate(0)}50%{transform:translate(40px,25px)}}
.app{position:relative;z-index:1;max-width:560px;margin:0 auto;padding:12px}
.hdr{display:flex;align-items:center;justify-content:space-between;padding:8px 4px 14px;gap:6px}
.hdr-l{display:flex;align-items:center;gap:10px;min-width:0}
.hdr-ico{width:40px;height:40px;background:linear-gradient(135deg,var(--pri),var(--prid));border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:19px;box-shadow:0 3px 12px rgba(0,229,255,.2);flex-shrink:0}
.hdr-t h1{font-family:'Orbitron',monospace;font-size:19px;font-weight:700;background:linear-gradient(90deg,var(--pri),var(--tx));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap}
.hdr-t p{font-size:9px;color:var(--tx3);letter-spacing:3px;text-transform:uppercase;margin-top:1px}
.hdr-r{display:flex;align-items:center;gap:5px;flex-shrink:0}
.hdr-dot{width:7px;height:7px;border-radius:50%;background:var(--tx3);transition:.3s;flex-shrink:0}
.hdr-dot.on{background:var(--ok);box-shadow:0 0 8px rgba(0,230,118,.6);animation:pls 1.5s infinite}
@keyframes pls{0%,100%{opacity:1}50%{opacity:.35}}
.hdr-st{font-size:11px;color:var(--tx3);white-space:nowrap;margin-right:2px}
.hbtn{width:34px;height:34px;border-radius:10px;border:1px solid var(--bd);background:var(--gl);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;transition:all .2s;color:var(--tx2);flex-shrink:0}
.hbtn:hover{background:var(--gl2);border-color:var(--bd2);color:var(--tx)}
.hbtn:active{transform:scale(.93)}
.ply{background:var(--card);border-radius:20px;border:1px solid var(--cardb);overflow:hidden;margin-bottom:12px;box-shadow:var(--card-sh);transition:background .4s,border-color .4s}
.ply-empty{text-align:center;padding:28px 20px;color:var(--tx3);font-size:14px}
.ply-empty i{font-size:34px;display:block;margin-bottom:8px;font-style:normal}
.ply-top{display:flex;gap:12px;padding:14px 14px 0}
.ply-art{width:64px;height:64px;border-radius:13px;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0;overflow:hidden;border:1px solid var(--bd)}
.ply-art img{width:100%;height:100%;object-fit:cover}
.ply-inf{flex:1;min-width:0;display:flex;flex-direction:column;justify-content:center}
.ply-nm{font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ply-mt{font-size:12px;color:var(--tx3);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ply-st{font-size:11px;margin-top:4px;display:flex;align-items:center;gap:5px;font-weight:600}
.ply-st.ld{color:var(--wrn)}.ply-st.pl{color:var(--ok)}.ply-st.er{color:var(--err)}.ply-st.sp{color:var(--tx3)}
.ply-st em{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;font-style:normal}
.ply-st.ld em,.ply-st.pl em{animation:pls 1s infinite}
.gauge-w{padding:8px 10px 2px;position:relative}
.gauge-cv{width:100%;height:120px;display:block}
.gauge-info{display:flex;justify-content:center;align-items:center;gap:8px;padding:2px 0 0}
.gauge-bdg{font-family:'Orbitron',monospace;font-size:9px;padding:2px 7px;border-radius:3px;letter-spacing:1px;font-weight:600}
.gauge-bdg.st{background:rgba(0,230,118,.12);color:var(--ok);border:1px solid rgba(0,230,118,.25)}
.gauge-bdg.mn{background:rgba(255,214,0,.1);color:var(--wrn);border:1px solid rgba(255,214,0,.2)}
.gauge-kb{font-family:'Orbitron',monospace;font-size:9px;color:var(--tx3)}
.ply-ct{display:flex;align-items:center;gap:8px;padding:10px 14px}
.btn-p{width:48px;height:48px;border-radius:50%;border:2px solid var(--bd2);background:var(--gl);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .25s;flex-shrink:0;color:var(--tx);font-size:20px}
.btn-p:hover{border-color:var(--pri);background:var(--prib);color:var(--pri)}
.btn-p:active{transform:scale(.92)}
.btn-p.on{border-color:var(--ok);background:rgba(0,230,118,.1);color:var(--ok);box-shadow:0 0 16px rgba(0,230,118,.15)}
.vol-s{flex:1;display:flex;align-items:center;gap:7px}
.vol-i{font-size:16px;cursor:pointer;flex-shrink:0;width:22px;text-align:center;user-select:none}
.vol-r{-webkit-appearance:none;appearance:none;flex:1;height:4px;background:var(--bg4);border-radius:2px;outline:none}
.vol-r::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;background:var(--tx);border-radius:50%;cursor:pointer;box-shadow:0 2px 6px var(--sh)}
.vol-r::-moz-range-thumb{width:16px;height:16px;background:var(--tx);border-radius:50%;cursor:pointer;border:none}
.vol-v{font-family:'Orbitron',monospace;font-size:11px;color:var(--tx3);width:26px;text-align:right;flex-shrink:0}
.cbtn{width:38px;height:38px;border-radius:10px;border:1px solid var(--bd);background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all .2s;flex-shrink:0;color:var(--tx2)}
.cbtn:hover{background:var(--gl2)}
.cbtn:active{transform:scale(.93)}
.cbtn.fav-on{border-color:var(--accbd);background:var(--accb);color:var(--acc)}
.cbtn.rec-on{border-color:rgba(255,23,68,.4);background:rgba(255,23,68,.1);color:var(--err);animation:pls 1s infinite}
.rec-bar{display:none;align-items:center;gap:8px;padding:8px 14px 12px;background:rgba(255,23,68,.06);border-top:1px solid rgba(255,23,68,.15)}
.rec-bar.on{display:flex}
.rec-dot{width:10px;height:10px;border-radius:50%;background:var(--err);animation:pls .8s infinite;flex-shrink:0}
.rec-info{flex:1;min-width:0}
.rec-tm{font-family:'Orbitron',monospace;font-size:14px;color:var(--err)}
.rec-sz{font-size:11px;color:var(--tx3);margin-top:1px}
.rec-stop{padding:7px 12px;border-radius:8px;border:1px solid rgba(255,23,68,.3);background:rgba(255,23,68,.1);color:var(--err);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap}
.srch{position:relative;margin-bottom:10px}
.srch input{width:100%;padding:12px 14px 12px 42px;background:var(--card);border:1px solid var(--bd);border-radius:13px;color:var(--tx);font-size:15px;outline:none;font-family:inherit;transition:border .2s,background .4s;box-shadow:var(--card-sh)}
.srch input:focus{border-color:var(--pribd)}
.srch input::placeholder{color:var(--tx3)}
.srch-i{position:absolute;left:13px;top:50%;transform:translateY(-50%);font-size:15px;color:var(--tx3);pointer-events:none}
.srch-x{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:26px;height:26px;border-radius:50%;border:none;background:var(--gl2);color:var(--tx3);font-size:13px;cursor:pointer;display:none;align-items:center;justify-content:center}
.srch-x.on{display:flex}
.tabs{display:flex;gap:5px;margin-bottom:8px;overflow-x:auto;scrollbar-width:none;padding:2px 0;-webkit-overflow-scrolling:touch}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:8px 14px;border-radius:10px;background:var(--card);border:1px solid var(--bd);font-size:12px;font-weight:600;color:var(--tx3);cursor:pointer;white-space:nowrap;transition:all .2s;flex-shrink:0;box-shadow:0 2px 8px var(--sh)}
.tab:active{transform:scale(.96)}
.tab.on{background:var(--prib);border-color:var(--pribd);color:var(--pri)}
.scats{display:none;gap:5px;margin-bottom:10px;overflow-x:auto;scrollbar-width:none;padding:2px 0;-webkit-overflow-scrolling:touch;flex-wrap:nowrap}
.scats.on{display:flex}
.scats::-webkit-scrollbar{display:none}
.scat{padding:6px 12px;border-radius:18px;background:var(--gl);border:1px solid var(--bd);font-size:11px;color:var(--tx3);cursor:pointer;white-space:nowrap;transition:all .2s;flex-shrink:0}
.scat:active{transform:scale(.95)}
.scat.on{background:var(--accb);border-color:var(--accbd);color:var(--acc)}
.linf{display:none;justify-content:space-between;align-items:center;padding:2px 4px 8px;font-size:12px;color:var(--tx3)}.linf.on{display:flex}.linf strong{color:var(--tx)}
.stns{display:flex;flex-direction:column;gap:5px;padding-bottom:18px}
.stn{display:flex;align-items:center;gap:11px;padding:11px;background:var(--card);border:1px solid var(--bd);border-radius:13px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.stn::after{content:'';position:absolute;left:0;top:0;width:3px;height:100%;background:transparent;transition:.2s}
.stn:active{transform:scale(.99)}
.stn.on{background:var(--prib);border-color:var(--pribd)}
.stn.on::after{background:var(--pri)}
.stn-a{width:42px;height:42px;border-radius:9px;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;overflow:hidden}
.stn-a img{width:100%;height:100%;object-fit:cover}
.stn-i{flex:1;min-width:0}
.stn-n{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.stn-d{font-size:11px;color:var(--tx3);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.stn-bg{display:flex;gap:3px;margin-top:3px;flex-wrap:wrap}
.stn-b{font-size:9px;padding:2px 6px;border-radius:3px;background:var(--gl2);color:var(--tx3)}
.stn-b.cd{color:var(--pri);background:var(--prib)}
.stn-r{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0}
.stn-f{width:30px;height:30px;border-radius:7px;border:none;background:transparent;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;transition:all .2s;color:var(--tx3)}
.stn-f.on{color:var(--acc)}
.stn-pi{font-size:10px;color:var(--ok);animation:pls 1s infinite}
.ldg{text-align:center;padding:36px 20px;color:var(--tx3)}
.ldg-s{width:32px;height:32px;border:3px solid var(--bd);border-top-color:var(--pri);border-radius:50%;animation:spn .8s linear infinite;margin:0 auto 10px}
@keyframes spn{to{transform:rotate(360deg)}}
.emt{text-align:center;padding:36px 20px;color:var(--tx3)}
.emt i{font-size:36px;display:block;margin-bottom:8px;font-style:normal}
.emt p{font-size:13px;line-height:1.6}
.btn-rt{padding:10px 22px;border-radius:9px;border:1px solid var(--pribd);background:var(--prib);color:var(--pri);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;margin-top:8px}
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.mbg.on{opacity:1;pointer-events:all}
[data-theme="light"] .mbg{background:rgba(0,0,0,.25)}
.mdl{background:var(--card);border-radius:20px 20px 0 0;width:100%;max-width:560px;max-height:88vh;overflow-y:auto;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,1,.5,1);border:1px solid var(--bd);border-bottom:none}
.mbg.on .mdl{transform:translateY(0)}
.mdl-h{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--bd);position:sticky;top:0;background:var(--card);z-index:2}
.mdl-h h2{font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}
.mdl-x{width:32px;height:32px;border-radius:50%;border:none;background:var(--gl2);color:var(--tx2);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.mdl-b{padding:16px 18px 24px}
.acc{border:1px solid var(--bd);border-radius:12px;margin-bottom:8px;overflow:hidden;background:var(--bg2);transition:all .3s}
.acc.open{border-color:var(--pribd);background:var(--prib)}
.acc-h{display:flex;align-items:center;gap:8px;padding:13px 16px;cursor:pointer;font-weight:600;font-size:14px;user-select:none;transition:background .2s;position:relative}
.acc-h:active{background:var(--gl2)}
.acc-ar{font-size:10px;color:var(--tx3);transition:transform .3s,color .3s;flex-shrink:0;display:inline-block}
.acc-h.op .acc-ar{transform:rotate(90deg);color:var(--pri)}
.acc.open .acc-h{border-left:3px solid var(--pri);padding-left:13px}
.acc-c{max-height:0;overflow:hidden;transition:max-height .35s ease}
.acc-c.op{max-height:900px}
.acc-ci{padding:2px 16px 16px}
.sg-r{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.sg-btn{flex:1;min-width:0;padding:10px 6px;border-radius:10px;border:1px solid var(--bd);background:var(--gl);color:var(--tx2);font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;transition:all .2s;font-family:inherit;white-space:nowrap}
.sg-btn:active{transform:scale(.96)}
.sg-btn.on{background:var(--prib);border-color:var(--pribd);color:var(--pri)}
.sg-info{font-size:12px;color:var(--tx3);line-height:1.7;padding:12px;background:var(--gl);border-radius:10px;margin-top:8px;border:1px solid var(--bd)}
.about-tbl{width:100%}.about-tbl tr{border-bottom:1px solid var(--bd)}.about-tbl tr:last-child{border-bottom:none}.about-tbl td{padding:8px 4px;font-size:13px;vertical-align:top}.about-tbl td:first-child{color:var(--tx3);white-space:nowrap;width:100px;font-weight:600}.about-tbl td:last-child{color:var(--tx)}
.fg{margin-bottom:14px}
.fl{display:block;font-size:11px;color:var(--tx3);margin-bottom:5px;font-weight:600;text-transform:uppercase;letter-spacing:1px}
.fi{width:100%;padding:11px 12px;background:var(--bg2);border:1px solid var(--bd);border-radius:10px;color:var(--tx);font-size:14px;font-family:inherit;outline:none;transition:border .2s}
.fi:focus{border-color:var(--pribd)}
.fi::placeholder{color:var(--tx3)}
select.fi{appearance:auto;-webkit-appearance:auto}
.fact{display:flex;gap:8px;margin-top:16px}
.fb{flex:1;padding:12px;border-radius:11px;border:none;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s}
.fb.pri{background:linear-gradient(135deg,var(--pri),var(--prid));color:#fff;box-shadow:0 3px 12px rgba(0,145,234,.3)}
.fb.sec{background:var(--gl2);border:1px solid var(--bd);color:var(--tx2)}
.fb:active{transform:scale(.97)}
.sch-tabs{display:flex;gap:4px;margin-bottom:16px}
.sch-tab{flex:1;padding:10px 4px;border-radius:10px;border:1px solid var(--bd);background:var(--gl);color:var(--tx3);font-size:11px;font-weight:600;cursor:pointer;text-align:center;font-family:inherit}
.sch-tab:active{transform:scale(.96)}
.sch-tab.on{background:var(--prib);border-color:var(--pribd);color:var(--pri)}
.sch-pane{display:none}.sch-pane.on{display:block}
.whl-grp{display:flex;gap:20px;justify-content:center;margin:10px 0}
.whl-col{text-align:center}
.whl-col-lab{font-size:10px;color:var(--tx3);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.whl-pair{display:flex;align-items:center;gap:4px;justify-content:center}
.whl{display:flex;flex-direction:column;align-items:center;gap:3px;user-select:none;-webkit-user-select:none}
.whl-btn{width:40px;height:28px;border-radius:7px;border:1px solid var(--bd);background:var(--gl);color:var(--tx2);font-size:13px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:700;transition:all .15s}
.whl-btn:active{transform:scale(.9);background:var(--prib);color:var(--pri)}
.whl-val{font-family:'Orbitron',monospace;font-size:24px;font-weight:700;color:var(--pri);min-width:44px;text-align:center;line-height:1;padding:3px 0;touch-action:none}
.whl-sep{font-size:24px;color:var(--tx3);font-family:'Orbitron',monospace;font-weight:700;padding:0 2px;align-self:center}
.sch-dur{text-align:center;font-size:13px;color:var(--pri);font-weight:600;margin:8px 0;font-family:'Orbitron',monospace}
.days-row{display:flex;gap:5px;justify-content:center;margin:12px 0;flex-wrap:wrap}
.day-btn{width:40px;height:38px;border-radius:10px;border:1px solid var(--bd);background:var(--gl);color:var(--tx3);font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.day-btn:active{transform:scale(.9)}
.day-btn.on{background:var(--prib);border-color:var(--pribd);color:var(--pri)}
.sch-list{margin-top:16px;border-top:1px solid var(--bd);padding-top:12px}
.sch-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg2);border-radius:10px;margin-bottom:6px;border:1px solid var(--bd)}
.sch-item-info{flex:1;min-width:0}
.sch-item-t{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sch-item-d{font-size:11px;color:var(--tx3);margin-top:2px}
.sch-item-del{width:28px;height:28px;border-radius:50%;border:none;background:transparent;color:var(--tx3);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sch-item-del:hover{background:rgba(255,23,68,.1);color:var(--err)}
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--card);border:1px solid var(--pribd);border-radius:12px;padding:12px 22px;font-size:13px;z-index:200;transition:transform .4s cubic-bezier(.34,1.56,.64,1);box-shadow:0 8px 30px var(--sh);white-space:nowrap;max-width:92vw;overflow:hidden;text-overflow:ellipsis}
.toast.on{transform:translateX(-50%) translateY(0)}
.ftr{text-align:center;padding:8px 20px 22px}
.ftr p{font-size:10px;color:var(--tx3);letter-spacing:1px}
.ftr a{color:var(--pri);text-decoration:none;opacity:.6}
/* EDITOR DE TEMAS */
.thm-tabs{display:flex;gap:4px;margin-bottom:16px}
.thm-tab{flex:1;padding:10px 4px;border-radius:10px;border:1px solid var(--bd);background:var(--gl);color:var(--tx3);font-size:12px;font-weight:600;cursor:pointer;text-align:center;font-family:inherit;transition:all .2s}
.thm-tab:active{transform:scale(.96)}
.thm-tab.on{background:var(--prib);border-color:var(--pribd);color:var(--pri)}
.thm-pane{display:none}.thm-pane.on{display:block}
.clr-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--bd)}
.clr-row:last-child{border-bottom:none}
.clr-icon{font-size:16px;width:24px;text-align:center;flex-shrink:0}
.clr-label{flex:1;font-size:13px;font-weight:500;color:var(--tx)}
.clr-preview{width:32px;height:32px;border-radius:8px;border:2px solid var(--bd2);cursor:pointer;transition:transform .2s,box-shadow .2s}
.clr-preview:hover{transform:scale(1.1);box-shadow:0 2px 8px var(--sh)}
.clr-input{position:absolute;opacity:0;width:0;height:0}
.clr-hex{font-family:'Orbitron',monospace;font-size:10px;color:var(--tx3);width:62px;text-align:right}
.thm-actions{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
.thm-btn{flex:1;min-width:calc(50% - 4px);padding:10px 8px;border-radius:10px;border:1px solid var(--bd);background:var(--gl);color:var(--tx2);font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;transition:all .2s;font-family:inherit}
.thm-btn:active{transform:scale(.96)}
.thm-btn.pri{background:var(--prib);border-color:var(--pribd);color:var(--pri)}
.thm-btn.warn{background:var(--accb);border-color:var(--accbd);color:var(--acc)}
.thm-info{font-size:11px;color:var(--tx3);text-align:center;margin-top:12px;padding:10px;background:var(--gl);border-radius:8px;line-height:1.6}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:3px}
@media(max-width:380px){
.ply-top{gap:9px;padding:11px 11px 0}.ply-art{width:52px;height:52px}.ply-nm{font-size:14px}.ply-ct{padding:8px 11px;gap:6px}.btn-p{width:42px;height:42px;font-size:18px}.hdr-t h1{font-size:16px}.tab{padding:7px 10px;font-size:11px}.whl-val{font-size:20px}.stn-n{font-size:13px}
}
</style>
</head>
<body>
<audio id="audio" preload="auto" crossorigin="anonymous"></audio>
<div class="bgx"><i></i><i></i></div>
<div class="app">
<header class="hdr">
<div class="hdr-l"><div class="hdr-ico">üìª</div><div class="hdr-t"><h1>WaveTuner FM</h1><p>Internet Radio</p></div></div>
<div class="hdr-r"><div class="hdr-dot" id="hDot"></div><span class="hdr-st" id="hSt">Offline</span>
<button class="hbtn" id="btnThm" onclick="toggleTheme();vib(30)">üåô</button>
<button class="hbtn" onclick="openMdl('stgMdl');vib(30)">‚öôÔ∏è</button></div>
</header>
<section class="ply">
<div class="ply-empty" id="plyE"><i>üìª</i>Selecciona una emisora para escuchar</div>
<div id="plyC" style="display:none">
<div class="ply-top"><div class="ply-art" id="plyArt">üìª</div><div class="ply-inf"><div class="ply-nm" id="plyNm">‚Äî</div><div class="ply-mt" id="plyMt">‚Äî</div><div class="ply-st sp" id="plySt"><em></em><span id="plyStT">Detenido</span></div></div></div>
<div class="gauge-w" id="gaugeW"><canvas class="gauge-cv" id="gaugeCv"></canvas><div class="gauge-info"><span class="gauge-bdg st" id="gBdg">STEREO</span><span class="gauge-kb" id="gKb"></span></div></div>
<div class="ply-ct">
<button class="btn-p" id="btnPl" onclick="togglePlay();vib(50)">‚ñ∂</button>
<div class="vol-s"><span class="vol-i" id="volI" onclick="toggleMute();vib(30)">üîä</span><input type="range" class="vol-r" id="volR" min="0" max="100" value="80"><span class="vol-v" id="volV">80</span></div>
<button class="cbtn" id="btnFv" onclick="toggleFavCur();vib([40,60,40])">‚òÜ</button>
<button class="cbtn" id="btnRc" onclick="toggleRec();vib([50,30,50])">‚è∫</button>
</div>
<div class="rec-bar" id="recBar"><div class="rec-dot"></div><div class="rec-info"><div class="rec-tm" id="recTm">00:00</div><div class="rec-sz" id="recSz">0 KB</div></div><button class="rec-stop" onclick="stopRec();vib(45)">‚èπ Guardar</button></div>
</div>
</section>
<div class="srch"><span class="srch-i">üîç</span><input type="text" id="srchIn" placeholder="Buscar emisoras..."><button class="srch-x" id="srchX" onclick="clrSearch()">‚úï</button></div>
<div class="tabs">
<button class="tab on" data-t="top" onclick="swTab('top');vib(30)">üî• Popular</button>
<button class="tab" data-t="country" onclick="swTab('country');vib(30)">üåé Pa√≠ses</button>
<button class="tab" data-t="genre" onclick="swTab('genre');vib(30)">üéµ G√©neros</button>
<button class="tab" data-t="favs" onclick="swTab('favs');vib(30)">‚≠ê Favoritos</button>
<button class="tab" data-t="custom" onclick="swTab('custom');vib(30)">üìå Mis Emisoras</button>
</div>
<div class="scats" id="scats"></div>
<div class="linf" id="linf"><span id="lLab"></span><span><strong id="lCnt">0</strong> resultados</span></div>
<div id="sBox"></div>
</div>

<!-- SETTINGS -->
<div class="mbg" id="stgMdl" onclick="maybeClose(event,'stgMdl')"><div class="mdl">
<div class="mdl-h"><h2>‚öôÔ∏è Configuraci√≥n</h2><button class="mdl-x" onclick="closeMdl('stgMdl')">‚úï</button></div>
<div class="mdl-b">

<div class="acc" id="accTheme"><div class="acc-h op" onclick="togAcc(this);vib(25)"><span class="acc-ar">‚ñ∂</span> üé® Tema</div><div class="acc-c op"><div class="acc-ci">
<div class="sg-r"><button class="sg-btn" id="sgDk" onclick="setTheme('dark');vib(30)">üåô Oscuro</button><button class="sg-btn" id="sgLt" onclick="setTheme('light');vib(30)">‚òÄÔ∏è Claro</button><button class="sg-btn" id="sgAt" onclick="setTheme('auto');vib(30)">üîÑ Auto</button></div>
</div></div></div>

<div class="acc" id="accCustomTheme"><div class="acc-h" onclick="togAcc(this);vib(25)"><span class="acc-ar">‚ñ∂</span> üñåÔ∏è Personalizar Colores</div><div class="acc-c"><div class="acc-ci">
<div class="sg-r"><button class="sg-btn" onclick="closeMdl('stgMdl');setTimeout(()=>openMdl('thmMdl'),300);vib(30)">üé® Abrir Editor de Temas</button></div>
<div class="sg-info">Personaliza los colores del tema oscuro y claro de forma independiente.</div>
</div></div></div>

<div class="acc" id="accQuality"><div class="acc-h" onclick="togAcc(this);vib(25)"><span class="acc-ar">‚ñ∂</span> üéöÔ∏è Calidad de Grabaci√≥n</div><div class="acc-c"><div class="acc-ci">
<div class="sg-r"><button class="sg-btn" id="sq128" onclick="setQuality(128)">128 kbps</button><button class="sg-btn" id="sq192" onclick="setQuality(192)">192 kbps</button><button class="sg-btn" id="sq320" onclick="setQuality(320)">320 kbps</button></div>
<div class="sg-info">128kbps ‚âà 1MB/min ¬∑ 192kbps ‚âà 1.5MB/min ¬∑ 320kbps ‚âà 2.5MB/min</div>
</div></div></div>

<div class="acc" id="accSchedule"><div class="acc-h" onclick="togAcc(this);vib(25)"><span class="acc-ar">‚ñ∂</span> üìÖ Grabaci√≥n Programada</div><div class="acc-c"><div class="acc-ci">
<div class="sg-r"><button class="sg-btn" onclick="closeMdl('stgMdl');setTimeout(()=>openMdl('schMdl'),300);vib(30)">üìÖ Abrir Programador</button></div>
<div class="sg-info">‚ö†Ô∏è La app debe permanecer abierta para que las grabaciones programadas se ejecuten.</div>
</div></div></div>

<div class="acc" id="accData"><div class="acc-h" onclick="togAcc(this);vib(25)"><span class="acc-ar">‚ñ∂</span> üíæ Datos</div><div class="acc-c"><div class="acc-ci">
<div class="sg-r"><button class="sg-btn" onclick="expData();vib(30)">üì§ Exportar</button><button class="sg-btn" onclick="impData();vib(30)">üì• Importar</button></div>
<div class="sg-info">Exporta favoritos, emisoras personalizadas y programaciones. Importa en otro dispositivo.</div>
</div></div></div>

<div class="acc" id="accInstall"><div class="acc-h" onclick="togAcc(this);vib(25)"><span class="acc-ar">‚ñ∂</span> üì≤ Instalar App</div><div class="acc-c"><div class="acc-ci">
<div class="sg-r"><button class="sg-btn" id="btnInst" onclick="installPWA();vib(30)">üì≤ Instalar WaveTuner FM</button></div>
<div class="sg-info" id="pwaI">Desde servidor HTTPS se puede instalar como app. GitHub Pages es gratis.</div>
</div></div></div>

<div class="acc" id="accAbout"><div class="acc-h" onclick="togAcc(this);vib(25)"><span class="acc-ar">‚ñ∂</span> ‚ÑπÔ∏è Acerca de</div><div class="acc-c"><div class="acc-ci">
<div class="sg-info" style="padding:16px">
<div style="text-align:center;margin-bottom:12px"><span style="font-size:32px">üìª</span><br><strong style="font-family:Orbitron,monospace;font-size:16px;color:var(--pri)">WaveTuner FM</strong></div>
<table class="about-tbl">
<tr><td>Versi√≥n:</td><td><strong>4.3.0</strong></td></tr>
<tr><td>Fecha:</td><td>16 de Febrero de 2026</td></tr>
<tr><td>Desarrollador:</td><td>Magdiel Mendoza</td></tr>
<tr><td>Asistente IA:</td><td>Claude (Anthropic)</td></tr>
<tr><td>Motor audio:</td><td>HTML5 Audio + Web Audio API</td></tr>
<tr><td>Grabaci√≥n:</td><td>Stream directo (MP3 nativo)</td></tr>
<tr><td>Visualizador:</td><td>Galvan√≥metro anal√≥gico</td></tr>
<tr><td>Fuente datos:</td><td>Radio Browser API</td></tr>
<tr><td>Dise√±o:</td><td>Glassmorphism + Adaptive Theme</td></tr>
<tr><td>Soporte:</td><td>MP3, AAC, M3U, M3U8, PLS</td></tr>
</table>
<div style="margin-top:10px;text-align:center;font-size:10px;color:var(--tx3)">Espacio=Play ¬∑ ‚Üë‚Üì=Vol ¬∑ M=Mute ¬∑ F=Fav ¬∑ R=Rec</div>
</div>
</div></div></div>

</div></div></div>

<!-- ADD STATION -->
<div class="mbg" id="addMdl" onclick="maybeClose(event,'addMdl')"><div class="mdl">
<div class="mdl-h"><h2>üìå Agregar Emisora</h2><button class="mdl-x" onclick="closeMdl('addMdl')">‚úï</button></div>
<div class="mdl-b">
<div class="fg"><label class="fl">Nombre *</label><input class="fi" id="fNm" placeholder="Mi Radio"></div>
<div class="fg"><label class="fl">URL del Stream *</label><input class="fi" id="fUrl" placeholder="https://stream.ejemplo.com/radio.mp3"></div>
<div class="sg-info" style="margin:-8px 0 14px;font-size:10px">‚úÖ Soporta: MP3, AAC, M3U, M3U8, PLS</div>
<div class="fg"><label class="fl">Pa√≠s (opcional)</label><input class="fi" id="fPais" placeholder="Venezuela"></div>
<div class="fg"><label class="fl">G√©nero (opcional)</label><input class="fi" id="fGen" placeholder="Pop, Rock"></div>
<div class="fact"><button class="fb sec" onclick="closeMdl('addMdl')">Cancelar</button><button class="fb pri" onclick="saveCustom();vib(50)">üíæ Guardar</button></div>
</div></div></div>

<!-- SCHEDULE -->
<div class="mbg" id="schMdl" onclick="maybeClose(event,'schMdl')"><div class="mdl">
<div class="mdl-h"><h2>üìÖ Grabaci√≥n Programada</h2><button class="mdl-x" onclick="closeMdl('schMdl')">‚úï</button></div>
<div class="mdl-b">
<div class="sch-tabs">
<button class="sch-tab on" data-s="timed" onclick="swSchTab('timed');vib(30)">‚è± Temporizado</button>
<button class="sch-tab" data-s="sched" onclick="swSchTab('sched');vib(30)">üìÖ Horario</button>
<button class="sch-tab" data-s="recur" onclick="swSchTab('recur');vib(30)">üîÅ Recurrente</button>
</div>

<div class="sch-pane on" id="spTimed">
<p style="font-size:12px;color:var(--tx3);margin-bottom:12px">Graba la emisora que suena durante los minutos indicados:</p>
<div class="fg"><label class="fl">Duraci√≥n (minutos)</label><input class="fi" id="schTimedMin" type="number" min="1" max="480" value="30"></div>
<div class="fact"><button class="fb pri" onclick="startTimedRec();vib([50,30,50])">‚è∫ Iniciar Grabaci√≥n</button></div>
</div>

<div class="sch-pane" id="spSched">
<p style="font-size:12px;color:var(--tx3);margin-bottom:12px">Programa grabaci√≥n para fecha y hora espec√≠fica:</p>
<div class="fg"><label class="fl">Emisora (de favoritos)</label><select class="fi" id="schSchedStn"></select></div>
<div class="fg"><label class="fl">Fecha</label><input class="fi" id="schSchedDate" type="date"></div>
<div class="whl-grp">
<div class="whl-col"><div class="whl-col-lab">Inicio</div><div class="whl-pair">
<div class="whl"><div class="whl-btn" onpointerdown="whlD('wH1',1)">‚ñ≤</div><div class="whl-val" id="wH1v">08</div><div class="whl-btn" onpointerdown="whlD('wH1',-1)">‚ñº</div></div>
<span class="whl-sep">:</span>
<div class="whl"><div class="whl-btn" onpointerdown="whlD('wM1',1)">‚ñ≤</div><div class="whl-val" id="wM1v">00</div><div class="whl-btn" onpointerdown="whlD('wM1',-1)">‚ñº</div></div>
</div></div>
<div class="whl-col"><div class="whl-col-lab">Fin</div><div class="whl-pair">
<div class="whl"><div class="whl-btn" onpointerdown="whlD('wH1e',1)">‚ñ≤</div><div class="whl-val" id="wH1ev">09</div><div class="whl-btn" onpointerdown="whlD('wH1e',-1)">‚ñº</div></div>
<span class="whl-sep">:</span>
<div class="whl"><div class="whl-btn" onpointerdown="whlD('wM1e',1)">‚ñ≤</div><div class="whl-val" id="wM1ev">00</div><div class="whl-btn" onpointerdown="whlD('wM1e',-1)">‚ñº</div></div>
</div></div>
</div>
<div class="sch-dur" id="schDur1">‚è± Duraci√≥n: 1h 00min</div>
<div class="fact"><button class="fb pri" onclick="addSchedule('sched');vib(50)">üìÖ Programar</button></div>
</div>

<div class="sch-pane" id="spRecur">
<p style="font-size:12px;color:var(--tx3);margin-bottom:12px">Graba autom√°ticamente cada semana en los d√≠as y hora indicados:</p>
<div class="fg"><label class="fl">Emisora (de favoritos)</label><select class="fi" id="schRecurStn"></select></div>
<div class="whl-grp">
<div class="whl-col"><div class="whl-col-lab">Inicio</div><div class="whl-pair">
<div class="whl"><div class="whl-btn" onpointerdown="whlD('wH2',1)">‚ñ≤</div><div class="whl-val" id="wH2v">08</div><div class="whl-btn" onpointerdown="whlD('wH2',-1)">‚ñº</div></div>
<span class="whl-sep">:</span>
<div class="whl"><div class="whl-btn" onpointerdown="whlD('wM2',1)">‚ñ≤</div><div class="whl-val" id="wM2v">00</div><div class="whl-btn" onpointerdown="whlD('wM2',-1)">‚ñº</div></div>
</div></div>
<div class="whl-col"><div class="whl-col-lab">Fin</div><div class="whl-pair">
<div class="whl"><div class="whl-btn" onpointerdown="whlD('wH2e',1)">‚ñ≤</div><div class="whl-val" id="wH2ev">09</div><div class="whl-btn" onpointerdown="whlD('wH2e',-1)">‚ñº</div></div>
<span class="whl-sep">:</span>
<div class="whl"><div class="whl-btn" onpointerdown="whlD('wM2e',1)">‚ñ≤</div><div class="whl-val" id="wM2ev">00</div><div class="whl-btn" onpointerdown="whlD('wM2e',-1)">‚ñº</div></div>
</div></div>
</div>
<div class="sch-dur" id="schDur2">‚è± Duraci√≥n: 1h 00min</div>
<div class="fl" style="text-align:center;margin:6px 0 4px">D√≠as de la semana</div>
<div class="days-row" id="daysRow">
<button class="day-btn" data-d="1" onclick="togDay(this);vib(30)">Lu</button>
<button class="day-btn" data-d="2" onclick="togDay(this);vib(30)">Ma</button>
<button class="day-btn" data-d="3" onclick="togDay(this);vib(30)">Mi</button>
<button class="day-btn" data-d="4" onclick="togDay(this);vib(30)">Ju</button>
<button class="day-btn" data-d="5" onclick="togDay(this);vib(30)">Vi</button>
<button class="day-btn" data-d="6" onclick="togDay(this);vib(30)">Sa</button>
<button class="day-btn" data-d="0" onclick="togDay(this);vib(30)">Do</button>
</div>
<div class="fact"><button class="fb pri" onclick="addSchedule('recur');vib(50)">üîÅ Programar</button></div>
</div>

<div class="sch-list" id="schListW" style="display:none"><div class="fl" style="margin-bottom:8px">Programaciones activas</div><div id="schList"></div></div>
</div></div></div>

<!-- THEME EDITOR -->
<div class="mbg" id="thmMdl" onclick="maybeClose(event,'thmMdl')"><div class="mdl">
<div class="mdl-h"><h2>üé® Personalizar Tema</h2><button class="mdl-x" onclick="closeMdl('thmMdl')">‚úï</button></div>
<div class="mdl-b">

<div class="thm-tabs">
<button class="thm-tab on" data-th="dark" onclick="swThmTab('dark');vib(30)">üåô Tema Oscuro</button>
<button class="thm-tab" data-th="light" onclick="swThmTab('light');vib(30)">‚òÄÔ∏è Tema Claro</button>
</div>

<div class="thm-pane on" id="tpDark">
<div class="clr-row"><span class="clr-icon">üñºÔ∏è</span><span class="clr-label">Fondo principal</span><input type="color" class="clr-input" id="cDkBg" onchange="updThmClr('dark','bg',this.value)"><label class="clr-preview" for="cDkBg" id="pDkBg"></label><span class="clr-hex" id="hDkBg">#050810</span></div>
<div class="clr-row"><span class="clr-icon">üì¶</span><span class="clr-label">Fondo tarjetas</span><input type="color" class="clr-input" id="cDkCard" onchange="updThmClr('dark','card',this.value)"><label class="clr-preview" for="cDkCard" id="pDkCard"></label><span class="clr-hex" id="hDkCard">#131b2d</span></div>
<div class="clr-row"><span class="clr-icon">üìù</span><span class="clr-label">Texto principal</span><input type="color" class="clr-input" id="cDkTx" onchange="updThmClr('dark','tx',this.value)"><label class="clr-preview" for="cDkTx" id="pDkTx"></label><span class="clr-hex" id="hDkTx">#e0e7ff</span></div>
<div class="clr-row"><span class="clr-icon">üí¨</span><span class="clr-label">Texto secundario</span><input type="color" class="clr-input" id="cDkTx2" onchange="updThmClr('dark','tx2',this.value)"><label class="clr-preview" for="cDkTx2" id="pDkTx2"></label><span class="clr-hex" id="hDkTx2">#94a3b8</span></div>
<div class="clr-row"><span class="clr-icon">üîµ</span><span class="clr-label">Color primario</span><input type="color" class="clr-input" id="cDkPri" onchange="updThmClr('dark','pri',this.value)"><label class="clr-preview" for="cDkPri" id="pDkPri"></label><span class="clr-hex" id="hDkPri">#00e5ff</span></div>
<div class="clr-row"><span class="clr-icon">üü†</span><span class="clr-label">Color acento</span><input type="color" class="clr-input" id="cDkAcc" onchange="updThmClr('dark','acc',this.value)"><label class="clr-preview" for="cDkAcc" id="pDkAcc"></label><span class="clr-hex" id="hDkAcc">#ff6d00</span></div>
</div>

<div class="thm-pane" id="tpLight">
<div class="clr-row"><span class="clr-icon">üñºÔ∏è</span><span class="clr-label">Fondo principal</span><input type="color" class="clr-input" id="cLtBg" onchange="updThmClr('light','bg',this.value)"><label class="clr-preview" for="cLtBg" id="pLtBg"></label><span class="clr-hex" id="hLtBg">#d8dfe8</span></div>
<div class="clr-row"><span class="clr-icon">üì¶</span><span class="clr-label">Fondo tarjetas</span><input type="color" class="clr-input" id="cLtCard" onchange="updThmClr('light','card',this.value)"><label class="clr-preview" for="cLtCard" id="pLtCard"></label><span class="clr-hex" id="hLtCard">#ffffff</span></div>
<div class="clr-row"><span class="clr-icon">üìù</span><span class="clr-label">Texto principal</span><input type="color" class="clr-input" id="cLtTx" onchange="updThmClr('light','tx',this.value)"><label class="clr-preview" for="cLtTx" id="pLtTx"></label><span class="clr-hex" id="hLtTx">#0f172a</span></div>
<div class="clr-row"><span class="clr-icon">üí¨</span><span class="clr-label">Texto secundario</span><input type="color" class="clr-input" id="cLtTx2" onchange="updThmClr('light','tx2',this.value)"><label class="clr-preview" for="cLtTx2" id="pLtTx2"></label><span class="clr-hex" id="hLtTx2">#475569</span></div>
<div class="clr-row"><span class="clr-icon">üîµ</span><span class="clr-label">Color primario</span><input type="color" class="clr-input" id="cLtPri" onchange="updThmClr('light','pri',this.value)"><label class="clr-preview" for="cLtPri" id="pLtPri"></label><span class="clr-hex" id="hLtPri">#0270ad</span></div>
<div class="clr-row"><span class="clr-icon">üü†</span><span class="clr-label">Color acento</span><input type="color" class="clr-input" id="cLtAcc" onchange="updThmClr('light','acc',this.value)"><label class="clr-preview" for="cLtAcc" id="pLtAcc"></label><span class="clr-hex" id="hLtAcc">#c65a08</span></div>
</div>

<div class="thm-actions">
<button class="thm-btn" onclick="expTheme();vib(30)">üì§ Exportar</button>
<button class="thm-btn" onclick="impTheme();vib(30)">üì• Importar</button>
<button class="thm-btn warn" onclick="resetTheme();vib(45)">üîÑ Restablecer</button>
<button class="thm-btn pri" onclick="saveThmColors();vib(50)">üíæ Guardar</button>
</div>

<div class="thm-info">Los colores se aplican en tiempo real. Pulsa "Guardar" para conservar los cambios.</div>

</div></div></div>

<input type="file" id="fileIn" accept=".json" style="display:none" onchange="handleImp(event)">
<input type="file" id="thmFileIn" accept=".json" style="display:none" onchange="handleThmImp(event)">
<div class="toast" id="toast"></div>
<footer class="ftr"><p>WaveTuner FM v4.3.0 ‚Äî <a href="https://www.radio-browser.info" target="_blank">Radio Browser API</a></p></footer>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTES Y CONFIGURACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SRVS=['https://de1.api.radio-browser.info','https://at1.api.radio-browser.info','https://nl1.api.radio-browser.info'];
const CORS_PROXIES=['https://corsproxy.io/?','https://api.allorigins.win/raw?url='];
const COUNTRIES=[
{n:'Espa√±a',c:'ES',f:'üá™üá∏'},{n:'M√©xico',c:'MX',f:'üá≤üáΩ'},{n:'Argentina',c:'AR',f:'üá¶üá∑'},
{n:'Colombia',c:'CO',f:'üá®üá¥'},{n:'Chile',c:'CL',f:'üá®üá±'},{n:'Per√∫',c:'PE',f:'üáµüá™'},
{n:'Venezuela',c:'VE',f:'üáªüá™'},{n:'Ecuador',c:'EC',f:'üá™üá®'},
{n:'R.Dominicana',c:'DO',f:'üá©üá¥'},{n:'Costa Rica',c:'CR',f:'üá®üá∑'},
{n:'Panam√°',c:'PA',f:'üáµüá¶'},{n:'Uruguay',c:'UY',f:'üá∫üáæ'},
{n:'Paraguay',c:'PY',f:'üáµüáæ'},{n:'Bolivia',c:'BO',f:'üáßüá¥'},
{n:'Cuba',c:'CU',f:'üá®üá∫'},{n:'Guatemala',c:'GT',f:'üá¨üáπ'},
{n:'Honduras',c:'HN',f:'üá≠üá≥'},{n:'El Salvador',c:'SV',f:'üá∏üáª'},
{n:'Nicaragua',c:'NI',f:'üá≥üáÆ'},{n:'Puerto Rico',c:'PR',f:'üáµüá∑'},
{n:'USA',c:'US',f:'üá∫üá∏'},{n:'Canad√°',c:'CA',f:'üá®üá¶'},
{n:'UK',c:'GB',f:'üá¨üáß'},{n:'Brasil',c:'BR',f:'üáßüá∑'},
{n:'Francia',c:'FR',f:'üá´üá∑'},{n:'Alemania',c:'DE',f:'üá©üá™'},
{n:'Italia',c:'IT',f:'üáÆüáπ'},{n:'Portugal',c:'PT',f:'üáµüáπ'},
{n:'Jap√≥n',c:'JP',f:'üáØüáµ'},{n:'Corea',c:'KR',f:'üá∞üá∑'},
{n:'Australia',c:'AU',f:'üá¶üá∫'},{n:'India',c:'IN',f:'üáÆüá≥'},
{n:'Rusia',c:'RU',f:'üá∑üá∫'},{n:'China',c:'CN',f:'üá®üá≥'}
];
const GENRES=[
{id:'pop',n:'Pop',i:'üé§'},{id:'rock',n:'Rock',i:'üé∏'},{id:'jazz',n:'Jazz',i:'üé∑'},
{id:'classical',n:'Cl√°sica',i:'üéª'},{id:'electronic',n:'Electr√≥nica',i:'üéõÔ∏è'},
{id:'latin',n:'Latina',i:'üíÉ'},{id:'hip hop',n:'Hip Hop',i:'üé§'},
{id:'rnb',n:'R&B',i:'üéµ'},{id:'country',n:'Country',i:'ü§†'},
{id:'reggae',n:'Reggae',i:'üü¢'},{id:'metal',n:'Metal',i:'ü§ò'},
{id:'blues',n:'Blues',i:'üé∏'},{id:'folk',n:'Folk',i:'ü™ï'},
{id:'soul',n:'Soul',i:'üíú'},{id:'dance',n:'Dance',i:'üï∫'},
{id:'ambient',n:'Ambient',i:'üåä'},{id:'reggaeton',n:'Reggaet√≥n',i:'üî•'},
{id:'salsa',n:'Salsa',i:'üíÉ'},{id:'tropical',n:'Tropical',i:'üå¥'},
{id:'80s',n:'80s',i:'üìº'},{id:'90s',n:'90s',i:'üíø'},
{id:'oldies',n:'Oldies',i:'üìª'},{id:'news',n:'Noticias',i:'üì∞'},
{id:'talk',n:'Talk',i:'üéôÔ∏è'},{id:'christian',n:'Cristiana',i:'‚úùÔ∏è'},
{id:'sports',n:'Deportes',i:'‚öΩ'},{id:'lounge',n:'Lounge',i:'üç∏'}
];
const DEG=Math.PI/180;
const DEFAULT_STN={stationuuid:'default_dinamica929',name:'Din√°mica 92.9 FM',url:'https://guri.tepuyserver.net/8012/stream',url_resolved:'https://guri.tepuyserver.net/8012/stream',favicon:'',country:'Venezuela',countrycode:'VE',tags:'radio en vivo',codec:'MP3',bitrate:128,isCustom:false};
const DEFAULT_COLORS={
  dark:{bg:'#050810',card:'#131b2d',tx:'#e0e7ff',tx2:'#94a3b8',pri:'#00e5ff',acc:'#ff6d00'},
  light:{bg:'#d8dfe8',card:'#ffffff',tx:'#0f172a',tx2:'#475569',pri:'#0270ad',acc:'#c65a08'}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTADO DE LA APLICACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const isFirstRun=localStorage.getItem('wtfm_favs')===null;
const S={
  srv:SRVS[0],list:[],cur:null,pb:'stopped',vol:80,muted:false,
  favs:isFirstRun?[{...DEFAULT_STN}]:JP('wtfm_favs',[]),
  custom:JP('wtfm_custom',[]),
  lastStation:JP('wtfm_last',null),
  tab:'top',sub:null,sq:'',loading:false,err:null,
  theme:localStorage.getItem('wtfm_theme')||'dark',
  quality:parseInt(localStorage.getItem('wtfm_q'))||128,
  recActive:false,recReader:null,recChunks:[],recStart:0,recTimer:null,recMime:'',recMethod:null,recMR:null,recAutoStop:null,
  recTotalSec:0,recSchId:null,
  nL:0,nR:0,vL:0,vR:0,gaugeReady:false,af:null,
  schedules:JP('wtfm_sch',[]),
  wheels:{wH1:{v:8,min:0,max:23},wM1:{v:0,min:0,max:59},wH1e:{v:9,min:0,max:23},wM1e:{v:0,min:0,max:59},wH2:{v:8,min:0,max:23},wM2:{v:0,min:0,max:59},wH2e:{v:9,min:0,max:23},wM2e:{v:0,min:0,max:59}},
  deferredPrompt:null,
  customColors:JP('wtfm_colors',{dark:{...DEFAULT_COLORS.dark},light:{...DEFAULT_COLORS.light}}),
  reconnectAttempts:0,
  maxReconnects:3
};
if(isFirstRun)saveFavs();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILIDADES BASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function JP(k,d){try{return JSON.parse(localStorage.getItem(k))||d}catch{return d}}
const $=id=>document.getElementById(id);
const audio=$('audio');
function vib(p){try{if(navigator.vibrate)navigator.vibrate(p)}catch{}}
function tsNow(){const d=new Date(),dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),aa=String(d.getFullYear()).slice(-2),hh=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0');return`${dd}-${mm}-${aa}_${hh}-${mi}`}
function mkFlag(c){if(!c||c.length!==2)return'üåê';return String.fromCodePoint(...[...c.toUpperCase()].map(x=>0x1F1E6+x.charCodeAt(0)-65))}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function toast(m){const t=$('toast');t.textContent=m;t.classList.add('on');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('on'),2800)}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SOPORTE M3U / M3U8 / PLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isPlaylistUrl(url){
  if(!url)return false;
  const lower=url.toLowerCase();
  return lower.endsWith('.m3u')||lower.endsWith('.m3u8')||lower.endsWith('.pls')||lower.includes('.m3u?')||lower.includes('.m3u8?')||lower.includes('.pls?');
}

async function resolvePlaylistUrl(url){
  if(!isPlaylistUrl(url))return url;
  console.log('üéµ Detectado archivo playlist:',url);
  let content=null;
  try{
    const resp=await fetch(url,{mode:'cors'});
    if(resp.ok)content=await resp.text();
  }catch(e){console.log('Fetch directo fall√≥, probando proxies...')}
  if(!content){
    for(const proxy of CORS_PROXIES){
      try{
        const resp=await fetch(proxy+encodeURIComponent(url));
        if(resp.ok){content=await resp.text();break}
      }catch{}
    }
  }
  if(!content){
    console.warn('‚ö†Ô∏è No se pudo obtener la playlist');
    return url;
  }
  const lower=url.toLowerCase();
  let streamUrl=null;
  if(lower.includes('.pls')){
    const match=content.match(/File1\s*=\s*(.+)/i);
    if(match)streamUrl=match[1].trim();
  }else{
    const lines=content.split('\n').map(l=>l.trim()).filter(l=>l&&!l.startsWith('#'));
    if(lines.length>0)streamUrl=lines[0];
  }
  if(streamUrl){
    console.log('‚úÖ Stream extra√≠do:',streamUrl);
    return streamUrl;
  }
  return url;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API DE RADIO BROWSER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function api(ep){
  for(const sv of SRVS){
    try{
      const c=new AbortController(),t=setTimeout(()=>c.abort(),8000);
      const r=await fetch(sv+ep,{signal:c.signal});
      clearTimeout(t);
      if(r.ok){S.srv=sv;return r.json()}
    }catch{}
  }
  throw new Error('Sin conexi√≥n al servidor');
}
const apiTop=()=>api('/json/stations/topvote?limit=80&hidebroken=true');
const apiCountry=c=>api(`/json/stations/bycountrycodeexact/${c}?limit=100&hidebroken=true&order=votes&reverse=true`);
const apiTag=t=>api(`/json/stations/bytag/${encodeURIComponent(t)}?limit=80&hidebroken=true&order=votes&reverse=true`);
const apiSearch=q=>api(`/json/stations/byname/${encodeURIComponent(q)}?limit=80&hidebroken=true&order=votes&reverse=true`);
const apiClick=u=>{try{fetch(`${S.srv}/json/url/${u}`)}catch{}};

async function loadList(fn,label){
  S.loading=true;S.err=null;renderBox();
  try{
    let d=await fn();
    d=d.filter(s=>s.url_resolved&&s.name&&s.name.trim());
    const seen=new Set();
    d=d.filter(s=>{if(seen.has(s.url_resolved))return false;seen.add(s.url_resolved);return true});
    S.list=d;S.loading=false;renderBox();showLinf(true,label,d.length);
  }catch(e){
    S.loading=false;S.err=e.message;S.list=[];renderBox();showLinf(false);
  }
}
function showLinf(s,l,c){const e=$('linf');if(s){e.classList.add('on');$('lLab').textContent=l;$('lCnt').textContent=c}else e.classList.remove('on')}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTROL DE AUDIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
audio.addEventListener('loadstart',()=>{if(S.cur)setPB('loading')});
audio.addEventListener('waiting',()=>{if(S.cur)setPB('loading')});
audio.addEventListener('playing',()=>{S.reconnectAttempts=0;setPB('playing');updMedia()});
audio.addEventListener('pause',()=>{if(!audio.src||audio.ended)setPB('stopped')});
audio.addEventListener('error',()=>{if(S.cur)setPB('error')});
audio.addEventListener('stalled',()=>{
  if(S.cur&&S.pb==='playing'){
    console.log('‚ö†Ô∏è Stream estancado, intentando reconectar...');
    tryReconnect();
  }
});
audio.addEventListener('ended',()=>{
  if(S.cur&&S.pb==='playing'){
    console.log('‚ö†Ô∏è Stream termin√≥, intentando reconectar...');
    tryReconnect();
  }
});

function tryReconnect(){
  if(S.reconnectAttempts>=S.maxReconnects){
    toast('‚ö†Ô∏è Conexi√≥n perdida');
    setPB('error');
    return;
  }
  S.reconnectAttempts++;
  toast(`üîÑ Reconectando... (${S.reconnectAttempts}/${S.maxReconnects})`);
  setTimeout(()=>{
    if(S.cur&&S.pb!=='stopped'){
      audio.load();
      audio.play().catch(()=>setPB('error'));
    }
  },2000);
}

async function playStn(stn){
  vib(35);S.cur=stn;S.reconnectAttempts=0;setPB('loading');showPly(true);
  let streamUrl=stn.url_resolved||stn.url;
  if(isPlaylistUrl(streamUrl)){
    toast('üîÑ Resolviendo playlist...');
    try{
      streamUrl=await resolvePlaylistUrl(streamUrl);
      stn.url_resolved=streamUrl;
    }catch(e){
      console.warn('Error resolviendo playlist:',e);
    }
  }
  audio.src=streamUrl;
  audio.volume=S.muted?0:S.vol/100;
  audio.load();
  const p=audio.play();
  if(p)p.catch(e=>{if(e.name!=='AbortError')setPB('error')});
  if(stn.stationuuid)apiClick(stn.stationuuid);
  updPlyInfo();renderStnList();
  saveLastStation(stn);
  toast('üìª '+stn.name);
}

function stopAudio(){audio.pause();audio.removeAttribute('src');audio.load();setPB('stopped')}
function togglePlay(){if(!S.cur)return;(S.pb==='playing'||S.pb==='loading')?stopAudio():playStn(S.cur)}
function setPB(s){S.pb=s;updPlySt();updHdr();updPlayBtn()}
function setVol(v){S.vol=v;S.muted=false;audio.volume=v/100;updVolUI()}
function toggleMute(){S.muted=!S.muted;audio.volume=S.muted?0:S.vol/100;updVolUI()}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// √öLTIMA EMISORA ESCUCHADA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveLastStation(stn){
  S.lastStation=pickStn(stn);
  localStorage.setItem('wtfm_last',JSON.stringify(S.lastStation));
}

function loadLastStation(){
  if(S.lastStation){
    S.cur=S.lastStation;
    showPly(true);
    updPlyInfo();
    updFavBtn();
    toast('üìª '+S.lastStation.name+' lista');
  }
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SISTEMA DE GRABACI√ìN MEJORADO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function toggleRec(){
  if(S.recActive){stopRec();return}
  if(S.pb!=='playing'){toast('‚ö†Ô∏è Primero reproduce una emisora');vib([60,50,60]);return}
  startRecording(0,null);
}

async function startRecording(totalSec,schId){
  if(S.recActive)return;
  S.recActive=true;S.recChunks=[];S.recStart=Date.now();S.recMethod=null;
  S.recTotalSec=totalSec;S.recSchId=schId;showRecUI(true);
  
  if(totalSec>0){
    S.recAutoStop=setTimeout(()=>{
      stopRec();toast('‚èπ Grabaci√≥n programada finalizada');vib([50,30,50]);
    },totalSec*1000);
  }
  
  const isHTTPS=location.protocol==='https:';
  const url=S.cur.url_resolved||S.cur.url;
  
  if(isHTTPS){
    // En HTTPS: Priorizar MediaRecorder
    try{
      let stream;
      if(audio.captureStream)stream=audio.captureStream();
      else if(audio.mozCaptureStream)stream=audio.mozCaptureStream();
      
      if(stream&&stream.getAudioTracks().length>0){
        const mime=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/webm';
        S.recMR=new MediaRecorder(stream,{mimeType:mime,audioBitsPerSecond:S.quality*1000});
        S.recMethod='capture';S.recMime=mime;
        S.recMR.ondataavailable=e=>{if(e.data&&e.data.size>0)S.recChunks.push(e.data)};
        S.recMR.onerror=()=>{console.warn('MediaRecorder error');S.recMethod=null};
        S.recMR.start(1000);
        toast('üî¥ Grabando (WebM)');
        return;
      }
    }catch(e){console.log('captureStream no disponible:',e)}
    
    // Fallback: Proxies CORS
    for(const proxy of CORS_PROXIES){
      try{
        const ctrl=new AbortController();
        const resp=await fetch(proxy+encodeURIComponent(url),{signal:ctrl.signal});
        if(!resp.ok||!resp.body)continue;
        S.recMethod='fetch';
        S.recMime=resp.headers.get('content-type')||'audio/mpeg';
        S.recReader=resp.body.getReader();
        S.recAbort=ctrl;
        toast('üî¥ Grabando (MP3 v√≠a proxy)');
        (async()=>{
          try{
            while(S.recActive){
              const{done,value}=await S.recReader.read();
              if(done||!S.recActive)break;
              S.recChunks.push(value);
            }
          }catch(e){console.log('Fetch stream cerrado:',e)}
          try{S.recReader.cancel()}catch{}
        })();
        return;
      }catch(e){console.log('Proxy fall√≥:',proxy,e)}
    }
  }else{
    // En HTTP local: Fetch directo
    try{
      const resp=await fetch(url);
      if(resp.ok&&resp.body){
        S.recMethod='fetch';
        S.recMime=resp.headers.get('content-type')||'audio/mpeg';
        S.recReader=resp.body.getReader();
        toast('üî¥ Grabando (MP3 directo)');
        (async()=>{
          try{
            while(S.recActive){
              const{done,value}=await S.recReader.read();
              if(done||!S.recActive)break;
              S.recChunks.push(value);
            }
          }catch{}
          try{S.recReader.cancel()}catch{}
        })();
        return;
      }
    }catch{}
    
    // Fallback: MediaRecorder
    try{
      let stream;
      if(audio.captureStream)stream=audio.captureStream();
      else if(audio.mozCaptureStream)stream=audio.mozCaptureStream();
      if(stream){
        const mime=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/webm';
        S.recMR=new MediaRecorder(stream,{mimeType:mime,audioBitsPerSecond:S.quality*1000});
        S.recMethod='capture';S.recMime=mime;
        S.recMR.ondataavailable=e=>{if(e.data&&e.data.size>0)S.recChunks.push(e.data)};
        S.recMR.start(1000);
        toast('üî¥ Grabando (WebM)');
        return;
      }
    }catch{}
  }
  
  S.recActive=false;showRecUI(false);
  toast('‚ö†Ô∏è Grabaci√≥n no disponible');vib([60,50,60,50,60]);
}

function stopRec(){
  S.recActive=false;clearInterval(S.recTimer);
  if(S.recAutoStop){clearTimeout(S.recAutoStop);S.recAutoStop=null}
  
  if(S.recMethod==='fetch'){
    try{S.recReader.cancel()}catch{}
    if(S.recAbort)try{S.recAbort.abort()}catch{}
    downloadRec();
  }else if(S.recMethod==='capture'&&S.recMR){
    S.recMR.onstop=()=>downloadRec();
    try{S.recMR.stop()}catch{};
    S.recMR=null;
  }
  
  showRecUI(false);$('btnRc').classList.remove('rec-on');
  
  if(S.recSchId){
    const idx=S.schedules.findIndex(s=>s.id===S.recSchId);
    if(idx>=0&&S.schedules[idx].type==='sched'){
      S.schedules.splice(idx,1);saveSch();renderSchList();
    }
  }
  S.recSchId=null;S.recTotalSec=0;
}

function downloadRec(){
  if(!S.recChunks.length){toast('‚ö†Ô∏è Sin audio grabado');return}
  
  let blob,ext;
  if(S.recMethod==='fetch'){
    const m=S.recMime||'audio/mpeg';
    ext=m.includes('aac')?'aac':m.includes('ogg')?'ogg':'mp3';
    blob=new Blob(S.recChunks,{type:m});
  }else{
    ext='webm';
    blob=new Blob(S.recChunks,{type:S.recMime||'audio/webm'});
  }
  
  const nm=S.cur?S.cur.name.replace(/[^a-zA-Z0-9√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë ]/gi,'').replace(/ +/g,'_'):'Grabacion';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`${nm}_${tsNow()}.${ext}`;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
  toast(`üíæ ${(blob.size/1048576).toFixed(1)}MB (.${ext})`);
  S.recChunks=[];S.recMethod=null;
}

function showRecUI(on){
  $('recBar').classList.toggle('on',on);
  $('btnRc').classList.toggle('rec-on',on);
  if(on){S.recTimer=setInterval(updRecTm,500);updRecTm()}
  else clearInterval(S.recTimer);
}

function updRecTm(){
  const elapsed=Math.floor((Date.now()-S.recStart)/1000);
  const em=Math.floor(elapsed/60),es=elapsed%60;
  let txt=`${String(em).padStart(2,'0')}:${String(es).padStart(2,'0')}`;
  if(S.recTotalSec>0){
    const rem=Math.max(0,S.recTotalSec-elapsed);
    const rm=Math.floor(rem/60),rs=rem%60;
    txt+=` / ${String(rm).padStart(2,'0')}:${String(rs).padStart(2,'0')} restante`;
  }
  $('recTm').textContent=txt;
  let b=0;S.recChunks.forEach(c=>b+=(c.byteLength||c.size||0));
  const kb=b/1024;
  $('recSz').textContent=kb>1024?`${(kb/1024).toFixed(1)} MB`:`${Math.round(kb)} KB`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALIDAD DE GRABACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setQuality(q){S.quality=q;localStorage.setItem('wtfm_q',q);updQualUI();vib(30);toast(`üéöÔ∏è Calidad: ${q}kbps`)}
function updQualUI(){[128,192,320].forEach(q=>{const b=$('sq'+q);if(b)b.classList.toggle('on',S.quality===q)})}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTERFAZ DE USUARIO - REPRODUCTOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPly(show){
  $('plyE').style.display=show?'none':'block';
  $('plyC').style.display=show?'block':'none';
  if(show&&!S.gaugeReady){
    requestAnimationFrame(()=>requestAnimationFrame(()=>{resizeGauge();S.gaugeReady=true}));
  }
}

function updPlyInfo(){
  const s=S.cur;if(!s)return;
  $('plyNm').textContent=s.name;
  const p=[];
  if(s.country)p.push(mkFlag(s.countrycode)+' '+s.country);
  if(s.tags){const t=s.tags.split(',').slice(0,2).map(x=>x.trim()).filter(Boolean);if(t.length)p.push(t.join(', '))}
  if(s.bitrate)p.push(s.bitrate+'kbps');
  if(s.codec)p.push(s.codec);
  $('plyMt').textContent=p.join(' ¬∑ ')||'Radio';
  const art=$('plyArt');
  art.innerHTML=(s.favicon&&s.favicon.trim())?`<img src="${s.favicon}" onerror="this.parentElement.innerHTML='üìª'">`:'üìª';
  const br=s.bitrate||0;
  $('gBdg').textContent=br>=96?'STEREO':'MONO';
  $('gBdg').className='gauge-bdg '+(br>=96?'st':'mn');
  $('gKb').textContent=(s.codec&&br)?`${s.codec} ${br}kbps`:'';
  updFavBtn();
}

function updPlySt(){
  const e=$('plySt'),t=$('plyStT');
  e.className='ply-st '+(S.pb==='loading'?'ld':S.pb==='playing'?'pl':S.pb==='error'?'er':'sp');
  t.textContent=S.pb==='loading'?'Conectando...':S.pb==='playing'?'‚ñ∂ En vivo':S.pb==='error'?'Error de conexi√≥n':'Detenido';
}

function updPlayBtn(){
  const b=$('btnPl'),a=S.pb==='playing'||S.pb==='loading';
  b.classList.toggle('on',S.pb==='playing');
  b.textContent=a?'‚è∏':'‚ñ∂';
}

function updHdr(){
  const d=$('hDot'),t=$('hSt');
  if(S.pb==='playing'){d.className='hdr-dot on';t.textContent='En vivo'}
  else if(S.pb==='loading'){d.className='hdr-dot';d.style.background='var(--wrn)';t.textContent='Conectando...'}
  else{d.className='hdr-dot';d.style.background='';t.textContent=S.pb==='error'?'Error':'Offline'}
}

function updVolUI(){
  $('volR').value=S.vol;
  $('volV').textContent=S.muted?'üîá':S.vol;
  $('volI').textContent=S.muted?'üîá':S.vol>50?'üîä':S.vol>0?'üîâ':'üîà';
}

function updFavBtn(){
  if(!S.cur)return;
  const is=S.favs.some(f=>sameStn(f,S.cur));
  $('btnFv').textContent=is?'‚òÖ':'‚òÜ';
  $('btnFv').classList.toggle('fav-on',is);
}

function sameStn(a,b){
  return(a.url_resolved&&a.url_resolved===b.url_resolved)||(a.stationuuid&&a.stationuuid===b.stationuuid);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GALVAN√ìMETRO VU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const gCv=$('gaugeCv'),gCtx=gCv.getContext('2d');

function resizeGauge(){
  const r=$('gaugeW').getBoundingClientRect();
  if(r.width>0){gCv.width=Math.floor(r.width*2);gCv.height=240}
}

new ResizeObserver(()=>{if($('plyC').style.display!=='none')resizeGauge()}).observe($('gaugeW'));

function calcLvl(now,ch,vol){
  if(S.pb!=='playing'||S.muted)return S.pb==='loading'?.05+Math.sin(now/300)*.03:.01;
  const v=Math.max(.15,vol),bl=500,bp=(now%bl)/bl;
  const kick=Math.exp(-bp*7)*.32;
  const snp=((now+bl)%(bl*2))/(bl*2),snare=Math.exp(-snp*9)*.22;
  const hhp=(now%(bl/2))/(bl/2),hh=Math.exp(-hhp*14)*.08;
  const bass=(Math.sin(now/900+ch*.7)*.5+.5)*.18;
  const mid=Math.abs(Math.sin(now/210+ch*2.3))*.12;
  const hi=Math.abs(Math.sin(now/55+ch*4.1))*.04;
  const swell=(Math.sin(now/5000)*.5+.5)*.08;
  const trans=Math.random()<.012?Math.random()*.22:0;
  const st=Math.sin(now/1600+ch*Math.PI)*.04;
  return Math.max(0,Math.min(1,(kick+snare+hh+bass+mid+hi+swell+trans+st)*v));
}

function startGauge(){
  function frame(now){
    const W=gCv.width,H=gCv.height;
    if(W<10){S.af=requestAnimationFrame(frame);return}
    gCtx.clearRect(0,0,W,H);
    const vol=S.vol/100;
    const tL=calcLvl(now,0,vol),tR=calcLvl(now,1,vol);
    const sp=.08,dm=.72;
    S.vL+=(tL-S.nL)*sp;S.vL*=dm;S.nL+=S.vL;S.nL=Math.max(-.02,Math.min(1.06,S.nL));
    S.vR+=(tR-S.nR)*sp;S.vR*=dm;S.nR+=S.vR;S.nR=Math.max(-.02,Math.min(1.06,S.nR));
    const gw=W/2;
    drawG(gCtx,gw*.5,H*.88,Math.min(gw*.42,H*.72),S.nL,'L');
    drawG(gCtx,gw*1.5,H*.88,Math.min(gw*.42,H*.72),S.nR,'R');
    S.af=requestAnimationFrame(frame);
  }
  S.af=requestAnimationFrame(frame);
}

function drawG(ctx,cx,cy,r,val,label){
  const dk=document.documentElement.dataset.theme!=='light';
  const minA=-55*DEG,maxA=55*DEG,sweep=maxA-minA;
  const nA=minA+Math.max(0,Math.min(1.05,val))*sweep;
  
  ctx.save();
  ctx.fillStyle=dk?'rgba(12,20,38,.7)':'rgba(232,236,242,.8)';
  ctx.beginPath();rr(ctx,cx-r*1.12,cy-r*1.18,r*2.24,r*1.25,r*.12);ctx.fill();
  ctx.strokeStyle=dk?'rgba(0,229,255,.06)':'rgba(0,0,0,.08)';ctx.lineWidth=1;
  ctx.beginPath();rr(ctx,cx-r*1.12,cy-r*1.18,r*2.24,r*1.25,r*.12);ctx.stroke();
  
  const ar=r*.92;
  [{s:0,e:.5,c:dk?'#00e676':'#16a34a'},{s:.5,e:.78,c:dk?'#ffd600':'#ca8a04'},{s:.78,e:1,c:dk?'#ff1744':'#dc2626'}].forEach(z=>{
    ctx.beginPath();ctx.arc(cx,cy,ar,-Math.PI/2+minA+z.s*sweep,-Math.PI/2+minA+z.e*sweep);
    ctx.strokeStyle=z.c;ctx.lineWidth=r*.06;ctx.globalAlpha=.35;ctx.stroke();ctx.globalAlpha=1;
  });
  
  ctx.textAlign='center';ctx.textBaseline='middle';
  [{p:0,l:'-20'},{p:.18,l:'-12'},{p:.36,l:'-6'},{p:.55,l:'-3'},{p:.78,l:'0'},{p:1,l:'+3'}].forEach(m=>{
    const a=-Math.PI/2+minA+m.p*sweep,ox=Math.cos(a),oy=Math.sin(a);
    ctx.beginPath();ctx.moveTo(cx+ox*(r*.82),cy+oy*(r*.82));ctx.lineTo(cx+ox*(r*.96),cy+oy*(r*.96));
    ctx.strokeStyle=dk?'rgba(255,255,255,.4)':'rgba(0,0,0,.35)';ctx.lineWidth=m.p>=.78?2:1.5;ctx.stroke();
    ctx.font=`600 ${r*.1}px Orbitron,monospace`;
    ctx.fillStyle=m.p>=.78?(dk?'rgba(255,60,80,.7)':'rgba(180,30,30,.7)'):(dk?'rgba(255,255,255,.45)':'rgba(0,0,0,.45)');
    ctx.fillText(m.l,cx+ox*(r*.7),cy+oy*(r*.7));
  });
  
  for(let i=0;i<=20;i++){
    const p=i/20,a=-Math.PI/2+minA+p*sweep,ox=Math.cos(a),oy=Math.sin(a);
    ctx.beginPath();ctx.moveTo(cx+ox*(r*.88),cy+oy*(r*.88));ctx.lineTo(cx+ox*(r*.93),cy+oy*(r*.93));
    ctx.strokeStyle=dk?'rgba(255,255,255,.15)':'rgba(0,0,0,.12)';ctx.lineWidth=1;ctx.stroke();
  }
  
  ctx.font=`700 ${r*.13}px Orbitron,monospace`;
  ctx.fillStyle=dk?'rgba(255,255,255,.12)':'rgba(0,0,0,.1)';
  ctx.fillText('VU',cx,cy-r*.35);
  
  const sA=-Math.PI/2+nA;
  ctx.beginPath();ctx.moveTo(cx+2,cy+2);ctx.lineTo(cx+Math.cos(sA)*(r*.86)+2,cy+Math.sin(sA)*(r*.86)+2);
  ctx.strokeStyle='rgba(0,0,0,.25)';ctx.lineWidth=2.5;ctx.stroke();
  
  const na=-Math.PI/2+nA,nx=Math.cos(na),ny=Math.sin(na);
  const perpX=-ny,perpY=nx;
  const tipX=cx+nx*(r*.86),tipY=cy+ny*(r*.86),bw=r*.02;
  const nColor=dk?'#00e5ff':'#0270ad';
  
  ctx.beginPath();ctx.moveTo(cx+perpX*bw,cy+perpY*bw);ctx.lineTo(tipX,tipY);ctx.lineTo(cx-perpX*bw,cy-perpY*bw);
  ctx.fillStyle=nColor;ctx.fill();
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(tipX,tipY);
  ctx.strokeStyle=dk?'rgba(0,229,255,.3)':'rgba(2,112,173,.2)';ctx.lineWidth=4;ctx.stroke();
  
  const pg=ctx.createRadialGradient(cx-r*.02,cy-r*.02,0,cx,cy,r*.08);
  pg.addColorStop(0,dk?'#5a6a7e':'#aabbcc');pg.addColorStop(1,dk?'#1a2535':'#556677');
  ctx.beginPath();ctx.arc(cx,cy,r*.07,0,Math.PI*2);ctx.fillStyle=pg;ctx.fill();
  ctx.beginPath();ctx.arc(cx,cy,r*.07,0,Math.PI*2);
  ctx.strokeStyle=dk?'rgba(255,255,255,.15)':'rgba(0,0,0,.15)';ctx.lineWidth=1;ctx.stroke();
  
  ctx.font=`700 ${r*.12}px Orbitron,monospace`;
  ctx.fillStyle=dk?'rgba(0,229,255,.5)':'rgba(2,112,173,.5)';
  ctx.fillText(label,cx,cy-r*.12);
  ctx.restore();
}

function rr(ctx,x,y,w,h,r){
  ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDERIZADO DE LISTAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBox(){
  const c=$('sBox');
  if(S.loading){c.innerHTML='<div class="ldg"><div class="ldg-s"></div><p>Buscando emisoras...</p></div>';return}
  if(S.err){c.innerHTML=`<div class="emt"><i>‚ö†Ô∏è</i><p>${S.err}</p><button class="btn-rt" onclick="retryLoad()">Reintentar</button></div>`;return}
  if(!S.list.length){
    if(S.tab==='favs')c.innerHTML='<div class="emt"><i>‚≠ê</i><p>No tienes favoritos.</p></div>';
    else if(S.tab==='custom')c.innerHTML=`<div class="emt"><i>üìå</i><p>Sin emisoras personalizadas.</p><br><button class="btn-rt" onclick="openMdl('addMdl')">Ôºã Agregar</button></div>`;
    else c.innerHTML='<div class="emt"><i>üì°</i><p>No se encontraron emisoras.</p></div>';
    return;
  }
  renderStnList();
}

function renderStnList(){
  let h='';
  S.list.forEach((s,i)=>{
    const on=S.cur&&sameStn(S.cur,s);
    const fv=S.favs.some(f=>sameStn(f,s));
    const tg=s.tags?s.tags.split(',').slice(0,2).map(x=>x.trim()).filter(Boolean):[];
    h+=`<div class="stn${on?' on':''}" onclick="playStn(S.list[${i}])">
      <div class="stn-a">${s.favicon&&s.favicon.trim()?`<img src="${s.favicon}" onerror="this.parentElement.innerHTML='üìª'" loading="lazy">`:'üìª'}</div>
      <div class="stn-i">
        <div class="stn-n">${esc(s.name)}</div>
        <div class="stn-d">${mkFlag(s.countrycode)} ${esc(s.country||'')}${s.bitrate?' ¬∑ '+s.bitrate+'kbps':''}</div>
        <div class="stn-bg">${s.codec?`<span class="stn-b cd">${s.codec}</span>`:''}${tg.map(t=>`<span class="stn-b">${esc(t)}</span>`).join('')}</div>
      </div>
      <div class="stn-r">
        <button class="stn-f${fv?' on':''}" onclick="event.stopPropagation();togFav(${i});vib(30)">${fv?'‚òÖ':'‚òÜ'}</button>
        ${on&&S.pb==='playing'?'<span class="stn-pi">üîä</span>':''}
      </div>
    </div>`;
  });
  $('sBox').innerHTML=`<div class="stns">${h}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS Y NAVEGACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function swTab(tab){
  S.tab=tab;S.sub=null;S.sq='';
  $('srchIn').value='';$('srchX').classList.remove('on');
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('on',t.dataset.t===tab));
  const sc=$('scats');
  
  if(tab==='country'){
    sc.classList.add('on');
    sc.innerHTML=COUNTRIES.map(c=>`<button class="scat" data-v="${c.c}" onclick="selSub('country','${c.c}');vib(30)">${c.f} ${c.n}</button>`).join('');
    $('sBox').innerHTML='<div class="emt"><i>üåé</i><p>Selecciona un pa√≠s</p></div>';
    showLinf(false);
  }else if(tab==='genre'){
    sc.classList.add('on');
    sc.innerHTML=GENRES.map(g=>`<button class="scat" data-v="${g.id}" onclick="selSub('genre','${g.id}');vib(30)">${g.i} ${g.n}</button>`).join('');
    $('sBox').innerHTML='<div class="emt"><i>üéµ</i><p>Selecciona un g√©nero</p></div>';
    showLinf(false);
  }else{
    sc.classList.remove('on');
    if(tab==='top')loadList(apiTop,'üî• Populares');
    else if(tab==='favs')loadFavs();
    else if(tab==='custom')loadCustom();
  }
}

function selSub(type,val){
  S.sub=val;
  document.querySelectorAll('.scat').forEach(s=>s.classList.toggle('on',s.dataset.v===val));
  if(type==='country'){
    const c=COUNTRIES.find(x=>x.c===val);
    loadList(()=>apiCountry(val),c?c.f+' '+c.n:val);
  }else{
    const g=GENRES.find(x=>x.id===val);
    loadList(()=>apiTag(val),g?g.i+' '+g.n:val);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// B√öSQUEDA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let srchTm;
$('srchIn').addEventListener('input',e=>{
  const q=e.target.value.trim();
  $('srchX').classList.toggle('on',q.length>0);
  clearTimeout(srchTm);
  if(q.length>=2){
    srchTm=setTimeout(()=>{
      S.sq=q;
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
      $('scats').classList.remove('on');
      loadList(()=>apiSearch(q),'üîç "'+q+'"');
    },400);
  }else if(!q.length)swTab(S.tab);
});

function clrSearch(){$('srchIn').value='';$('srchX').classList.remove('on');S.sq='';swTab(S.tab)}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FAVORITOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function togFav(i){
  const s=S.list[i];if(!s)return;
  const idx=S.favs.findIndex(f=>sameStn(f,s));
  if(idx>=0){S.favs.splice(idx,1);toast('‚úï Eliminada de favoritos')}
  else{S.favs.push(pickStn(s));toast('‚≠ê Agregada a favoritos')}
  saveFavs();renderStnList();updFavBtn();
  if(S.tab==='favs')loadFavs();
}

function toggleFavCur(){
  if(!S.cur)return;
  const idx=S.favs.findIndex(f=>sameStn(f,S.cur));
  if(idx>=0){S.favs.splice(idx,1);toast('‚úï Eliminada de favoritos')}
  else{S.favs.push(pickStn(S.cur));toast('‚≠ê Agregada a favoritos')}
  saveFavs();updFavBtn();renderStnList();
  if(S.tab==='favs')loadFavs();
}

function pickStn(s){
  return{
    stationuuid:s.stationuuid||'',name:s.name,url:s.url||'',
    url_resolved:s.url_resolved||s.url||'',favicon:s.favicon||'',
    country:s.country||'',countrycode:s.countrycode||'',
    tags:s.tags||'',codec:s.codec||'',bitrate:s.bitrate||0,
    isCustom:s.isCustom||false
  };
}

function loadFavs(){
  S.list=[...S.favs];S.loading=false;S.err=null;
  renderBox();showLinf(S.list.length>0,'‚≠ê Favoritos',S.list.length);
}

function saveFavs(){localStorage.setItem('wtfm_favs',JSON.stringify(S.favs))}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMISORAS PERSONALIZADAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveCustom(){
  const nm=$('fNm').value.trim();
  let url=$('fUrl').value.trim();
  const pais=$('fPais').value.trim();
  const gen=$('fGen').value.trim();
  
  if(!nm||!url){toast('‚ö†Ô∏è Nombre y URL obligatorios');vib([60,50,60]);return}
  if(!url.startsWith('http')){toast('‚ö†Ô∏è URL debe empezar con http');return}
  
  if(isPlaylistUrl(url)){
    toast('üîÑ Resolviendo playlist...');
    try{url=await resolvePlaylistUrl(url)}catch{}
  }
  
  S.custom.push({
    stationuuid:'c_'+Date.now(),name:nm,url,url_resolved:url,
    favicon:'',country:pais,countrycode:'',tags:gen,
    codec:'',bitrate:0,isCustom:true
  });
  
  localStorage.setItem('wtfm_custom',JSON.stringify(S.custom));
  closeMdl('addMdl');toast('üìå Emisora guardada');
  ['fNm','fUrl','fPais','fGen'].forEach(id=>$(id).value='');
  if(S.tab==='custom')loadCustom();
}

function loadCustom(){
  S.list=[...S.custom];S.loading=false;S.err=null;
  renderBox();showLinf(S.list.length>0,'üìå Mis Emisoras',S.list.length);
}

function retryLoad(){
  if(S.sq)loadList(()=>apiSearch(S.sq),'üîç');
  else if(S.tab==='top')loadList(apiTop,'üî•');
  else if(S.sub)selSub(S.tab==='country'?'country':'genre',S.sub);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEMA - CLARO/OSCURO/AUTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTheme(t){S.theme=t;localStorage.setItem('wtfm_theme',t);applyTheme();updThUI()}
function toggleTheme(){setTheme(S.theme==='dark'?'light':S.theme==='light'?'dark':'dark')}

function applyTheme(){
  let th=S.theme;
  if(th==='auto')th=matchMedia('(prefers-color-scheme:light)').matches?'light':'dark';
  document.documentElement.dataset.theme=th;
  $('metaTheme').content=th==='dark'?'#060910':'#d8dfe8';
  $('btnThm').textContent=th==='dark'?'üåô':'‚òÄÔ∏è';
  applyCustomColors();
}

function updThUI(){
  ['Dk','Lt','At'].forEach((x,i)=>{
    const b=$('sg'+x);
    if(b)b.classList.toggle('on',S.theme===['dark','light','auto'][i]);
  });
}

matchMedia('(prefers-color-scheme:light)').addEventListener('change',()=>{if(S.theme==='auto')applyTheme()});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDITOR DE TEMAS PERSONALIZADO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function swThmTab(t){
  document.querySelectorAll('.thm-tab').forEach(b=>b.classList.toggle('on',b.dataset.th===t));
  $('tpDark').classList.toggle('on',t==='dark');
  $('tpLight').classList.toggle('on',t==='light');
}

function loadThmEditorUI(){
  ['dark','light'].forEach(th=>{
    const c=S.customColors[th];
    const pre=th==='dark'?'Dk':'Lt';
    
    $('c'+pre+'Bg').value=c.bg;
    $('p'+pre+'Bg').style.background=c.bg;
    $('h'+pre+'Bg').textContent=c.bg;
    
    $('c'+pre+'Card').value=c.card;
    $('p'+pre+'Card').style.background=c.card;
    $('h'+pre+'Card').textContent=c.card;
    
    $('c'+pre+'Tx').value=c.tx;
    $('p'+pre+'Tx').style.background=c.tx;
    $('h'+pre+'Tx').textContent=c.tx;
    
    $('c'+pre+'Tx2').value=c.tx2;
    $('p'+pre+'Tx2').style.background=c.tx2;
    $('h'+pre+'Tx2').textContent=c.tx2;
    
    $('c'+pre+'Pri').value=c.pri;
    $('p'+pre+'Pri').style.background=c.pri;
    $('h'+pre+'Pri').textContent=c.pri;
    
    $('c'+pre+'Acc').value=c.acc;
    $('p'+pre+'Acc').style.background=c.acc;
    $('h'+pre+'Acc').textContent=c.acc;
  });
}

function updThmClr(theme,key,value){
  S.customColors[theme][key]=value;
  const pre=theme==='dark'?'Dk':'Lt';
  const keyMap={bg:'Bg',card:'Card',tx:'Tx',tx2:'Tx2',pri:'Pri',acc:'Acc'};
  const k=keyMap[key];
  $('p'+pre+k).style.background=value;
  $('h'+pre+k).textContent=value;
  
  let currentTheme=S.theme;
  if(currentTheme==='auto')currentTheme=matchMedia('(prefers-color-scheme:light)').matches?'light':'dark';
  if(theme===currentTheme)applyCustomColors();
}

function applyCustomColors(){
  let th=S.theme;
  if(th==='auto')th=matchMedia('(prefers-color-scheme:light)').matches?'light':'dark';
  const c=S.customColors[th];
  const r=document.documentElement;
  
  r.style.setProperty('--bg',c.bg);
  r.style.setProperty('--card',c.card);
  r.style.setProperty('--tx',c.tx);
  r.style.setProperty('--tx2',c.tx2);
  r.style.setProperty('--pri',c.pri);
  r.style.setProperty('--acc',c.acc);
  
  r.style.setProperty('--prib',c.pri+'18');
  r.style.setProperty('--pribd',c.pri+'4D');
  r.style.setProperty('--prid',adjustColor(c.pri,-20));
  r.style.setProperty('--accb',c.acc+'18');
  r.style.setProperty('--accbd',c.acc+'4D');
}

function adjustColor(hex,amt){
  let r=parseInt(hex.slice(1,3),16);
  let g=parseInt(hex.slice(3,5),16);
  let b=parseInt(hex.slice(5,7),16);
  r=Math.max(0,Math.min(255,r+amt));
  g=Math.max(0,Math.min(255,g+amt));
  b=Math.max(0,Math.min(255,b+amt));
  return'#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
}

function saveThmColors(){
  localStorage.setItem('wtfm_colors',JSON.stringify(S.customColors));
  applyCustomColors();
  toast('üé® Tema guardado');
  closeMdl('thmMdl');
}

function resetTheme(){
  const active=document.querySelector('.thm-tab.on').dataset.th;
  S.customColors[active]={...DEFAULT_COLORS[active]};
  loadThmEditorUI();
  applyCustomColors();
  toast('üîÑ Colores restablecidos');
  vib(30);
}

function expTheme(){
  const d={version:'4.3.0',type:'theme',date:new Date().toISOString(),colors:S.customColors};
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json'}));
  a.download=`WaveTuner_Tema_${tsNow()}.json`;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  toast('üì§ Tema exportado');
}

function impTheme(){$('thmFileIn').click()}

function handleThmImp(e){
  const f=e.target.files[0];if(!f)return;
  const rd=new FileReader();
  rd.onload=ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      if(d.type!=='theme'||!d.colors){throw new Error('Formato inv√°lido')}
      if(d.colors.dark)S.customColors.dark={...DEFAULT_COLORS.dark,...d.colors.dark};
      if(d.colors.light)S.customColors.light={...DEFAULT_COLORS.light,...d.colors.light};
      localStorage.setItem('wtfm_colors',JSON.stringify(S.customColors));
      loadThmEditorUI();
      applyCustomColors();
      toast('üì• Tema importado');
    }catch{toast('‚ö†Ô∏è Archivo de tema no v√°lido');vib([60,50,60])}
  };
  rd.readAsText(f);e.target.value='';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACORDE√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function togAcc(el){
  const isOpen=el.classList.toggle('op');
  el.nextElementSibling.classList.toggle('op',isOpen);
  const acc=el.parentElement;
  acc.classList.toggle('open',isOpen);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RUEDAS DE TIEMPO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let whlTm,whlIv;

function whlD(id,dir){
  whlStep(id,dir);
  whlTm=setTimeout(()=>{whlIv=setInterval(()=>whlStep(id,dir),80)},350);
  const up=()=>{
    clearTimeout(whlTm);clearInterval(whlIv);
    window.removeEventListener('pointerup',up);
    window.removeEventListener('pointercancel',up);
  };
  window.addEventListener('pointerup',up);
  window.addEventListener('pointercancel',up);
}

function whlStep(id,dir){
  const w=S.wheels[id];if(!w)return;
  w.v+=dir;
  if(w.v>w.max)w.v=w.min;
  if(w.v<w.min)w.v=w.max;
  $(id+'v').textContent=String(w.v).padStart(2,'0');
  vib(25);updDurDisp();
}

function calcMin(sh,sm,eh,em){
  let s=sh*60+sm,e=eh*60+em;
  if(e<=s)e+=1440;
  return e-s;
}

function fmtDur(m){
  const h=Math.floor(m/60),mm=m%60;
  return h>0?(mm>0?`${h}h ${mm}min`:`${h}h`):`${mm}min`;
}

function updDurDisp(){
  const d1=calcMin(S.wheels.wH1.v,S.wheels.wM1.v,S.wheels.wH1e.v,S.wheels.wM1e.v);
  $('schDur1').textContent=`‚è± Duraci√≥n: ${fmtDur(d1)}`;
  const d2=calcMin(S.wheels.wH2.v,S.wheels.wM2.v,S.wheels.wH2e.v,S.wheels.wM2e.v);
  $('schDur2').textContent=`‚è± Duraci√≥n: ${fmtDur(d2)}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROGRAMACI√ìN DE GRABACIONES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function swSchTab(t){
  document.querySelectorAll('.sch-tab').forEach(b=>b.classList.toggle('on',b.dataset.s===t));
  ['Timed','Sched','Recur'].forEach(p=>{
    const el=$('sp'+p);
    if(el)el.classList.toggle('on',p.toLowerCase()===t);
  });
}

function togDay(el){el.classList.toggle('on');vib(30)}

function populateFavSel(){
  const opts=S.favs.length?S.favs.map((f,i)=>`<option value="${i}">${f.name}</option>`).join(''):'';
  const empty=S.favs.length?'':'<option value="">‚Äî Agrega emisoras a favoritos primero ‚Äî</option>';
  $('schSchedStn').innerHTML=`<option value="">Seleccionar emisora...</option>${empty}${opts}`;
  $('schRecurStn').innerHTML=`<option value="">Seleccionar emisora...</option>${empty}${opts}`;
}

function startTimedRec(){
  const min=parseInt($('schTimedMin').value);
  if(!min||min<1){toast('‚ö†Ô∏è Ingresa duraci√≥n v√°lida');vib([60,50,60]);return}
  if(S.pb!=='playing'){toast('‚ö†Ô∏è Primero reproduce una emisora');vib([60,50,60]);return}
  closeMdl('schMdl');
  startRecording(min*60,null);
  toast(`‚è± Grabando ${min} minutos`);
}

function addSchedule(type){
  let stnIdx,stn,dur;
  
  if(type==='sched'){
    stnIdx=parseInt($('schSchedStn').value);
    if(isNaN(stnIdx)||!S.favs[stnIdx]){toast('‚ö†Ô∏è Selecciona una emisora');vib([60,50,60]);return}
    stn=S.favs[stnIdx];
    const date=$('schSchedDate').value;
    if(!date){toast('‚ö†Ô∏è Selecciona fecha');vib([60,50,60]);return}
    dur=calcMin(S.wheels.wH1.v,S.wheels.wM1.v,S.wheels.wH1e.v,S.wheels.wM1e.v);
    const sch={
      id:'s_'+Date.now(),type:'sched',station:pickStn(stn),active:true,lastTriggered:0,
      date,startH:S.wheels.wH1.v,startM:S.wheels.wM1.v,
      endH:S.wheels.wH1e.v,endM:S.wheels.wM1e.v,duration:dur
    };
    S.schedules.push(sch);saveSch();renderSchList();
    const sh=String(sch.startH).padStart(2,'0'),sm=String(sch.startM).padStart(2,'0');
    const eh=String(sch.endH).padStart(2,'0'),em=String(sch.endM).padStart(2,'0');
    toast(`üìÖ ${date} ${sh}:${sm}-${eh}:${em}`);
  }else{
    stnIdx=parseInt($('schRecurStn').value);
    if(isNaN(stnIdx)||!S.favs[stnIdx]){toast('‚ö†Ô∏è Selecciona una emisora');vib([60,50,60]);return}
    stn=S.favs[stnIdx];
    const days=[];
    document.querySelectorAll('#daysRow .day-btn.on').forEach(b=>days.push(parseInt(b.dataset.d)));
    if(!days.length){toast('‚ö†Ô∏è Selecciona al menos un d√≠a');vib([60,50,60]);return}
    dur=calcMin(S.wheels.wH2.v,S.wheels.wM2.v,S.wheels.wH2e.v,S.wheels.wM2e.v);
    const sch={
      id:'s_'+Date.now(),type:'recur',station:pickStn(stn),active:true,lastTriggered:0,
      days,startH:S.wheels.wH2.v,startM:S.wheels.wM2.v,
      endH:S.wheels.wH2e.v,endM:S.wheels.wM2e.v,duration:dur
    };
    S.schedules.push(sch);saveSch();renderSchList();
    const dn=['Do','Lu','Ma','Mi','Ju','Vi','Sa'];
    toast(`üîÅ ${days.map(d=>dn[d]).join(',')} ${String(sch.startH).padStart(2,'0')}:${String(sch.startM).padStart(2,'0')}`);
  }
}

function delSchedule(id){
  S.schedules=S.schedules.filter(s=>s.id!==id);
  saveSch();renderSchList();toast('üóëÔ∏è Programaci√≥n eliminada');vib(45);
}

function saveSch(){localStorage.setItem('wtfm_sch',JSON.stringify(S.schedules))}

function renderSchList(){
  const wrap=$('schListW'),list=$('schList');
  if(!S.schedules.length){wrap.style.display='none';return}
  wrap.style.display='block';
  const dn=['Do','Lu','Ma','Mi','Ju','Vi','Sa'];
  list.innerHTML=S.schedules.map(s=>{
    const sh=String(s.startH).padStart(2,'0'),sm=String(s.startM).padStart(2,'0');
    const eh=String(s.endH).padStart(2,'0'),em=String(s.endM).padStart(2,'0');
    let desc=s.type==='sched'?`üìÖ ${s.date} ¬∑ ${sh}:${sm}-${eh}:${em}`:`üîÅ ${s.days.map(d=>dn[d]).join(', ')} ¬∑ ${sh}:${sm}-${eh}:${em}`;
    return`<div class="sch-item">
      <div class="sch-item-info">
        <div class="sch-item-t">${esc(s.station.name)}</div>
        <div class="sch-item-d">${desc} ¬∑ ${fmtDur(s.duration)}</div>
      </div>
      <button class="sch-item-del" onclick="delSchedule('${s.id}');vib(45)">‚úï</button>
    </div>`;
  }).join('');
}

function checkSchedules(){
  const now=new Date(),ms=now.getTime();
  S.schedules.forEach(sch=>{
    if(!sch.active||S.recActive)return;
    if(ms-sch.lastTriggered<120000)return;
    
    if(sch.type==='sched'){
      const d=new Date(sch.date+'T'+String(sch.startH).padStart(2,'0')+':'+String(sch.startM).padStart(2,'0'));
      if(Math.abs(ms-d.getTime())<60000)triggerSch(sch);
    }else if(sch.type==='recur'){
      const day=now.getDay();
      if(sch.days.includes(day)&&now.getHours()===sch.startH&&now.getMinutes()===sch.startM)triggerSch(sch);
    }
  });
}

function triggerSch(sch){
  sch.lastTriggered=Date.now();saveSch();
  playStn(sch.station);
  const durSec=sch.duration*60;
  setTimeout(()=>{if(S.pb==='playing')startRecording(durSec,sch.id)},3000);
  toast(`üìÖ Grabaci√≥n programada: ${sch.station.name}`);vib([50,100,50]);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORTAR / IMPORTAR DATOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function expData(){
  const d={
    version:'4.3.0',date:new Date().toISOString(),
    favorites:S.favs,customStations:S.custom,schedules:S.schedules,
    theme:S.theme,quality:S.quality,lastStation:S.lastStation,
    customColors:S.customColors
  };
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json'}));
  a.download=`Backup_WaveTunerFM_${tsNow()}.json`;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  toast('üì§ Datos exportados');
}

function impData(){$('fileIn').click()}

function handleImp(e){
  const f=e.target.files[0];if(!f)return;
  const rd=new FileReader();
  rd.onload=ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      let nf=0,nc=0;
      if(d.favorites){
        const nw=d.favorites.filter(x=>!S.favs.some(e=>sameStn(e,x)));
        S.favs.push(...nw);saveFavs();nf=nw.length;
      }
      if(d.customStations){
        const nw=d.customStations.filter(x=>!S.custom.some(e=>(e.url_resolved||e.url)===(x.url_resolved||x.url)));
        S.custom.push(...nw);localStorage.setItem('wtfm_custom',JSON.stringify(S.custom));nc=nw.length;
      }
      if(d.schedules){
        d.schedules.forEach(ns=>{if(!S.schedules.some(es=>es.id===ns.id)){S.schedules.push(ns)}});
        saveSch();renderSchList();
      }
      if(d.customColors){
        S.customColors=d.customColors;
        localStorage.setItem('wtfm_colors',JSON.stringify(S.customColors));
        applyCustomColors();
      }
      if(d.lastStation){S.lastStation=d.lastStation;localStorage.setItem('wtfm_last',JSON.stringify(S.lastStation))}
      if(d.theme)setTheme(d.theme);
      if(d.quality)setQuality(d.quality);
      toast(`üì• +${nf} favs, +${nc} emisoras`);
      if(S.tab==='favs')loadFavs();
      if(S.tab==='custom')loadCustom();
    }catch{toast('‚ö†Ô∏è Archivo no v√°lido');vib([60,50,60])}
  };
  rd.readAsText(f);e.target.value='';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openMdl(id){
  $(id).classList.add('on');
  updThUI();updQualUI();renderSchList();populateFavSel();
  $('schSchedDate').value=new Date().toISOString().slice(0,10);
  updDurDisp();
  if(id==='thmMdl')loadThmEditorUI();
}

function closeMdl(id){$(id).classList.remove('on')}

function maybeClose(e,id){if(e.target.id===id)closeMdl(id)}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PWA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupPWA(){
  const sizes=[192,512];const icons=[];
  sizes.forEach(s=>{
    const cv=document.createElement('canvas');cv.width=cv.height=s;
    const x=cv.getContext('2d');
    const g=x.createLinearGradient(0,0,s,s);
    g.addColorStop(0,'#00e5ff');g.addColorStop(1,'#0091ea');
    x.fillStyle=g;x.beginPath();x.roundRect(0,0,s,s,s*.2);x.fill();
    x.font=`${s*.45}px serif`;x.textAlign='center';x.textBaseline='middle';
    x.fillText('üìª',s/2,s/2);
    const url=cv.toDataURL('image/png');
    icons.push({src:url,sizes:`${s}x${s}`,type:'image/png',purpose:'any maskable'});
    if(s===192){$('favIco').href=url;$('applIco').href=url}
  });
  
  const mf={
    name:'WaveTuner FM',short_name:'WaveTuner',
    description:'Internet Radio Player',id:'wavetuner-fm',
    start_url:'.',scope:'.',display:'standalone',
    background_color:'#060910',theme_color:'#060910',
    orientation:'portrait',categories:['music','entertainment'],icons
  };
  
  const lnk=document.createElement('link');lnk.rel='manifest';
  lnk.href=URL.createObjectURL(new Blob([JSON.stringify(mf)],{type:'application/json'}));
  document.head.appendChild(lnk);
  
  window.addEventListener('beforeinstallprompt',e=>{
    e.preventDefault();S.deferredPrompt=e;
    $('pwaI').textContent='¬°Disponible para instalar!';
    $('btnInst').classList.add('on');
  });
  
  if('serviceWorker'in navigator&&location.protocol==='https:'){
    const sw=`const CN='wtfm-v43';
self.addEventListener('install',e=>{e.waitUntil(caches.open(CN).then(c=>c.addAll(['./',])));self.skipWaiting()});
self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CN).map(k=>caches.delete(k)))));self.clients.claim()});
self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)))});`;
    navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'application/javascript'}))).catch(()=>{});
  }
}

function installPWA(){
  if(S.deferredPrompt){
    S.deferredPrompt.prompt();
    S.deferredPrompt.userChoice.then(r=>{
      toast(r.outcome==='accepted'?'üì≤ App instalada':'Instalaci√≥n cancelada');
      S.deferredPrompt=null;
    });
  }else{
    toast('‚ÑπÔ∏è Requiere servidor HTTPS (GitHub Pages)');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEDIA SESSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updMedia(){
  if(!('mediaSession'in navigator)||!S.cur)return;
  navigator.mediaSession.metadata=new MediaMetadata({
    title:S.cur.name,artist:S.cur.country||'Radio',album:'WaveTuner FM',
    artwork:S.cur.favicon?[{src:S.cur.favicon,sizes:'512x512',type:'image/png'}]:[]
  });
  navigator.mediaSession.setActionHandler('play',togglePlay);
  navigator.mediaSession.setActionHandler('pause',togglePlay);
  navigator.mediaSession.setActionHandler('stop',stopAudio);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ATAJOS DE TECLADO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT')return;
  switch(e.key){
    case' ':e.preventDefault();togglePlay();vib(50);break;
    case'ArrowUp':e.preventDefault();setVol(Math.min(100,S.vol+5));break;
    case'ArrowDown':e.preventDefault();setVol(Math.max(0,S.vol-5));break;
    case'm':toggleMute();vib(30);break;
    case'f':if(S.cur){toggleFavCur();vib([40,60,40])}break;
    case'r':toggleRec();break;
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENTO VOLUMEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
$('volR').addEventListener('input',e=>setVol(parseInt(e.target.value)));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INICIALIZACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function init(){
  applyTheme();
  updVolUI();
  updQualUI();
  loadLastStation();
  swTab('top');
  startGauge();
  setupPWA();
  renderSchList();
  setInterval(checkSchedules,30000);
  $('schSchedDate').value=new Date().toISOString().slice(0,10);
  updDurDisp();
  console.log('üìª WaveTuner FM v4.3.0 - 16 de Febrero de 2026');
})();
</script>
</body>
</html>
